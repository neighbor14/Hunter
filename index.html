<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecargaPay CRM - Sistema de ProspecÃ§Ã£o B2B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            font-feature-settings: 'cv11', 'ss01';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .report-modal {
            top: 0;
            left: 0;
            transform: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        .highlight-today {
            background-color: #fef9c3; /* yellow-100 */
        }
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .loading-text {
            margin-top: 1rem;
            color: #4f46e5;
            font-weight: 500;
        }
        .button-loading {
            opacity: 0.7;
            cursor: not-allowed;
            position: relative;
        }
        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        .kanban-column {
            flex: 0 0 300px;
            min-width: 300px;
        }
        .editable-date:hover {
            background-color: #e5e7eb;
            cursor: pointer;
        }
        .handle {
            cursor: grab;
        }
        
        /* Sortable drag & drop styles */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e5e7eb !important;
        }
        
        .sortable-chosen {
            background-color: #dbeafe !important;
        }
        
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(2deg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .handle:active {
            cursor: grabbing;
        }
        
        /* Funcionalidade de expandir/retrair empresas */
        .company-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        
        .company-header:hover {
            background-color: #e5e7eb !important;
        }
        
        .company-toggle {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
            display: inline-block;
        }
        
        .company-collapsed .company-toggle {
            transform: rotate(-90deg);
        }
        
        .company-lead {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .company-lead.collapsed {
            display: none;
        }
        
        .company-lead.expanded {
            display: table-row;
        }
        
        /* Controle de visibilidade para containers de cards */
        .company-leads.collapsed {
            display: none;
        }
        
        .company-leads.expanded {
            display: block;
        }
        
        /* NOVOS ESTILOS MODERNOS */
        .company-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px 0 rgba(102, 126, 234, 0.4);
        }
        
        /* Cards de contato modernos */
        .contact-card {
            background: white;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .contact-card:hover {
            box-shadow: 0 8px 25px 0 rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #d1d5db;
        }
        
        /* Status badges modernos */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* BotÃµes de aÃ§Ã£o modernos */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-decoration: none;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
        }
        
        .action-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(14, 165, 233, 0.3);
        }
        
        .action-primary:hover {
            box-shadow: 0 6px 20px 0 rgba(14, 165, 233, 0.4);
        }
        
        .action-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(34, 197, 94, 0.3);
        }
        
        .action-success:hover {
            box-shadow: 0 6px 20px 0 rgba(34, 197, 94, 0.4);
        }
        
        .action-secondary {
            background-color: #f8fafc;
            color: #475569;
            border-color: #e2e8f0;
        }
        
        .action-secondary:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }

        .action-accent {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(139, 92, 246, 0.3);
        }
        
        .action-accent:hover {
            box-shadow: 0 6px 20px 0 rgba(139, 92, 246, 0.4);
        }

        .action-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: 1px solid transparent;
        }

        .action-info:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .action-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid transparent;
        }

        .action-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .action-neutral {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: 1px solid transparent;
        }

        .action-neutral:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        /* DARK MODE STYLES */
        .dark {
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
        }

        .dark .bg-white {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
        }

        .dark .bg-gray-50 {
            background-color: #334155 !important;
        }

        .dark .bg-gray-100 {
            background-color: #475569 !important;
            color: #f1f5f9 !important;
        }

        .dark .bg-gray-200 {
            background-color: #64748b !important;
        }

        .dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .dark .text-gray-800 {
            color: #e2e8f0 !important;
        }

        .dark .text-gray-700 {
            color: #cbd5e1 !important;
        }

        .dark .text-gray-600 {
            color: #94a3b8 !important;
        }

        .dark .text-gray-500 {
            color: #64748b !important;
        }

        .dark .border-gray-200 {
            border-color: #475569 !important;
        }

        .dark .border-gray-300 {
            border-color: #64748b !important;
        }

        .dark .contact-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
            border-color: #475569 !important;
        }

        .dark .contact-card:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .company-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
            border-color: #334155 !important;
        }

        .dark .action-btn.action-execute {
            background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
        }

        .dark .action-btn.action-copy {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%) !important;
        }

        .dark .action-btn.action-notes {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%) !important;
        }

        .dark .action-btn.action-undo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        }

        .dark .action-btn.action-delete {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
        }

        .dark .modal {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
            border: 1px solid #475569 !important;
        }

        .dark .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.8) !important;
        }

        .dark .status-badge {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }

        .dark .overdue {
            background-color: #dc2626 !important;
            color: white !important;
        }

        .dark .today {
            background-color: #f59e0b !important;
            color: white !important;
        }

        .dark .on-time {
            background-color: #059669 !important;
            color: white !important;
        }

        .dark input, .dark select, .dark textarea {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #475569 !important;
        }

        .dark input:focus, .dark select:focus, .dark textarea:focus {
            border-color: #0ea5e9 !important;
            box-shadow: 0 0 0 1px #0ea5e9 !important;
        }

        /* Campo de data editÃ¡vel em dark mode */
        .dark input[type="date"] {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
            border-color: #0ea5e9 !important;
        }

        .dark input[type="date"]:hover {
            background-color: #334155 !important;
        }

        .dark input[type="date"]:focus {
            background-color: #1e293b !important;
            border-color: #0ea5e9 !important;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3) !important;
        }

        .dark .kanban-column {
            background-color: #1e293b !important;
            border-color: #475569 !important;
        }

        .dark .kanban-item {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #475569 !important;
        }

        .dark .calendar-day {
            background-color: #1e293b !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }

        .dark .calendar-day.today {
            background-color: #0ea5e9 !important;
            color: white !important;
        }

        .dark .calendar-contact {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }

        .dark .bg-blue-50 {
            background-color: #1e40af !important;
            color: white !important;
        }

        .dark .bg-green-50 {
            background-color: #059669 !important;
            color: white !important;
        }

        .dark .bg-yellow-50 {
            background-color: #f59e0b !important;
            color: white !important;
        }

        .dark .bg-red-50 {
            background-color: #dc2626 !important;
            color: white !important;
        }

        .dark .bg-purple-50 {
            background-color: #7c3aed !important;
            color: white !important;
        }

        .dark .border-blue-300, .dark .border-green-300, 
        .dark .border-yellow-300, .dark .border-red-300, 
        .dark .border-purple-300 {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* Melhorar contrastes nos cards de mÃ©tricas em dark mode */
        .dark .bg-blue-100 {
            background-color: #1e40af !important;
            color: white !important;
        }

        .dark .bg-green-100 {
            background-color: #059669 !important;
            color: white !important;
        }

        .dark .bg-yellow-100 {
            background-color: #f59e0b !important;
            color: white !important;
        }

        .dark .bg-red-100 {
            background-color: #dc2626 !important;
            color: white !important;
        }

        .dark .bg-purple-100 {
            background-color: #7c3aed !important;
            color: white !important;
        }

        .dark .bg-orange-100 {
            background-color: #ea580c !important;
            color: white !important;
        }

        .dark .bg-indigo-100 {
            background-color: #4f46e5 !important;
            color: white !important;
        }

        /* Textos nos cards de progressÃ£o */
        .dark .text-blue-800,
        .dark .text-green-800,
        .dark .text-yellow-800,
        .dark .text-red-800,
        .dark .text-purple-800,
        .dark .text-orange-800,
        .dark .text-indigo-800 {
            color: white !important;
        }

        .dark .text-blue-700,
        .dark .text-green-700,
        .dark .text-yellow-700,
        .dark .text-red-700,
        .dark .text-purple-700,
        .dark .text-orange-700,
        .dark .text-indigo-700 {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* Cards de mÃ©tricas especÃ­ficos */
        .dark [class*="bg-blue-"]:not(.bg-blue-500):not(.bg-blue-600) {
            background-color: #1e40af !important;
            color: white !important;
        }

        .dark [class*="bg-green-"]:not(.bg-green-500):not(.bg-green-600) {
            background-color: #059669 !important;
            color: white !important;
        }

        .dark [class*="bg-yellow-"]:not(.bg-yellow-500):not(.bg-yellow-600) {
            background-color: #f59e0b !important;
            color: white !important;
        }

        .dark [class*="bg-red-"]:not(.bg-red-500):not(.bg-red-600) {
            background-color: #dc2626 !important;
            color: white !important;
        }

        .dark [class*="bg-purple-"]:not(.bg-purple-500):not(.bg-purple-600) {
            background-color: #7c3aed !important;
            color: white !important;
        }

        .dark [class*="bg-orange-"]:not(.bg-orange-500):not(.bg-orange-600) {
            background-color: #ea580c !important;
            color: white !important;
        }

        /* AnimaÃ§Ã£o suave para transiÃ§Ã£o de tema */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* AnimaÃ§Ãµes suaves */
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos do CalendÃ¡rio */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .calendar-day {
            background: white;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            min-height: 180px;
            overflow: hidden;
            box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.15);
        }

        .calendar-day.today {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .calendar-day.has-contacts {
            border-color: #0ea5e9;
        }

        .calendar-day.today.has-contacts {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .calendar-day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
        }

        .calendar-day-header.today {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .calendar-day-body {
            padding: 0.5rem;
            height: calc(100% - 40px);
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 300px; /* Altura mÃ¡xima para forÃ§ar scroll */
            min-height: 150px; /* Altura mÃ­nima para consistÃªncia */
        }

        .calendar-contact {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.375rem;
            margin-bottom: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-contact:hover {
            background: #e2e8f0;
            transform: scale(1.02);
        }

        .calendar-contact:last-child {
            margin-bottom: 0;
        }

        .calendar-contact.overdue {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .calendar-contact-company {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-contact-name {
            color: #6b7280;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-contact-action {
            background: #0ea5e9;
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 500;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-contact.overdue .calendar-contact-action {
            background: #ef4444;
        }

        .calendar-empty {
            padding: 1rem;
            text-align: center;
            color: #9ca3af;
            font-size: 0.75rem;
            font-style: italic;
        }

        .calendar-week-label {
            background: #f1f5f9;
            color: #475569;
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .calendar-day {
                min-height: 120px;
            }
            
            .calendar-contact {
                font-size: 0.625rem;
                padding: 0.25rem;
            }
        }
        
        /* Pipeline de Mensagens */
        .pipeline-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            min-height: 400px;
        }

        .pipeline-column {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            min-height: 350px;
        }

        .pipeline-header {
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .pipeline-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .pipeline-lead {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .pipeline-lead:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #3b82f6;
        }

        .pipeline-lead-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .pipeline-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            margin-right: 0.75rem;
        }

        .pipeline-lead-info h4 {
            font-weight: 600;
            font-size: 0.85rem;
            color: #1f2937;
            margin: 0;
            line-height: 1.2;
        }

        .pipeline-lead-info p {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0;
            line-height: 1.2;
        }

        .pipeline-lead-date {
            font-size: 0.7rem;
            color: #9ca3af;
            text-align: right;
            margin-top: 0.25rem;
        }

        /* Cores diferentes para cada coluna */
        .pipeline-column:nth-child(1) .pipeline-header { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .pipeline-column:nth-child(2) .pipeline-header { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .pipeline-column:nth-child(3) .pipeline-header { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .pipeline-column:nth-child(4) .pipeline-header { background: linear-gradient(135deg, #10b981, #059669); }
        .pipeline-column:nth-child(5) .pipeline-header { background: linear-gradient(135deg, #ef4444, #dc2626); }

        /* Melhorias de responsividade mobile */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .pipeline-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .pipeline-column {
                min-height: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .pipeline-container {
                grid-template-columns: 1fr;
            }
        }

        .mobile-stack {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .mobile-stack > * {
            width: 100% !important;
        }
        
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-card {
            display: none;
        }
        
        .mobile-view .table-responsive {
            display: none;
        }
        
        .mobile-view .mobile-card {
            display: block;
        }
        
        .mobile-lead-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4f46e5;
        }
        
        .modal {
            width: 95% !important;
            height: 90% !important;
            top: 5% !important;
            left: 2.5% !important;
            transform: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loader">
        <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div id="loading-text" class="loading-text">Carregando dados...</div>
    </div>

    <!-- Header moderno -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-lg">R</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-semibold text-gray-900">RecargaPay CRM</h1>
                            <p class="text-sm text-gray-500">Sistema de ProspecÃ§Ã£o B2B</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- BotÃ£o Limpar Leads (TemporÃ¡rio) -->
                    <button id="clear-leads-btn" class="action-btn" style="background: #dc2626; color: white;" title="Limpar todos os leads">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span class="hidden sm:inline">Limpar</span>
                    </button>
                    <!-- BotÃ£o Importar Leads Discreto -->
                    <button id="import-leads-btn" class="action-btn action-success" title="Importar leads em lote">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <span class="hidden sm:inline">Importar</span>
                    </button>
                    <button id="dark-mode-toggle" class="action-btn action-neutral">
                        <svg id="sun-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg id="moon-icon" class="w-4 h-4 mr-2 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                        <span id="theme-text">Escuro</span>
                    </button>
                    <button id="version-history-btn" class="action-btn action-info">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        HistÃ³rico <span id="current-version" class="text-xs opacity-75">v2.4</span>
                    </button>
                    <button id="toggle-all-btn" class="action-btn action-neutral" title="Abrir/Fechar todas as empresas">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        Abrir tudo
                    </button>
                    <button id="executive-report-btn" class="action-btn action-accent">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        RelatÃ³rio Executivo
                    </button>
                    <button id="export-xls-btn" class="action-btn action-secondary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Exportar
                    </button>
                    <button id="open-report-btn" class="action-btn action-primary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        RelatÃ³rios
                    </button>
                    <button id="guide-btn" class="action-btn action-secondary" title="Abrir guia rÃ¡pido do analista">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Guia RÃ¡pido
                    </button>
                    <button id="tech-docs-btn" class="action-btn action-secondary" title="DocumentaÃ§Ã£o tÃ©cnica do sistema">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Docs TÃ©cnicos
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- SeÃ§Ã£o de ConfiguraÃ§Ãµes -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <details>
                <summary class="text-xl font-semibold cursor-pointer">ConfiguraÃ§Ãµes</summary>
                
                <div class="mt-6 border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Gerenciar Status do Funil</h3>
                        <div class="text-sm text-gray-500 flex items-center">
                            <span class="mr-2">ðŸ’¡</span>
                            <span>Arraste â˜° para reordenar</span>
                        </div>
                    </div>
                    <div id="status-config-container" class="space-y-2">
                        <!-- Status configurÃ¡veis serÃ£o inseridos aqui -->
                    </div>
                    <button id="add-status-btn" class="mt-4 text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center space-x-2">
                        <span>âž•</span>
                        <span>Adicionar Status</span>
                    </button>
                </div>

                <div class="mt-6 border-t pt-6">
                    <h3 class="text-lg font-semibold mb-2">Gerenciar AÃ§Ãµes da CadÃªncia</h3>
                    <div id="actions-config-container" class="space-y-4">
                        <!-- AÃ§Ãµes dinÃ¢micas serÃ£o inseridas aqui -->
                    </div>
                    <button id="add-action-btn" class="mt-4 text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Adicionar AÃ§Ã£o</button>
                </div>
                 <div class="flex justify-end mt-6">
                    <button id="save-config-btn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Salvar Todas as ConfiguraÃ§Ãµes</button>
                </div>
            </details>
        </div>


        <!-- SeÃ§Ã£o para Adicionar Novo Lead -->
        <div class="bg-white rounded-xl shadow-md mb-8">
            <!-- BotÃ£o para expandir/colapsar formulÃ¡rio -->
            <div class="p-4">
                <button id="toggle-add-lead-btn" class="w-full flex items-center justify-between p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span class="font-semibold">Adicionar Novo Lead</span>
                    </div>
                    <svg id="toggle-arrow" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            
            <!-- FormulÃ¡rio (inicialmente oculto) -->
            <div id="add-lead-form-container" class="hidden px-6 pb-6">
                <form id="add-lead-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div class="lg:col-span-1">
                        <label for="empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                        <input type="text" id="empresa" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700">Nome do Contato</label>
                        <input type="text" id="nome" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                        <input type="text" id="cargo" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="lg:col-span-1">
                        <label for="linkedin" class="block text-sm font-medium text-gray-700">URL LinkedIn</label>
                        <input type="url" id="linkedin" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Adicionar Lead</button>
                </form>
            </div>
        </div>

        <!-- Input de importaÃ§Ã£o escondido -->
        <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv" />

        <!-- Dashboard Compacto -->
        <div class="bg-white rounded-xl shadow-md mb-8 p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Total de Leads -->
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-800" id="dashboard-total-leads">0</div>
                    <div class="text-xs text-gray-500">Total Leads</div>
                </div>
                
                <!-- Leads Ativos -->
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="dashboard-active-leads">0</div>
                    <div class="text-xs text-gray-500">Ativos</div>
                </div>
                
                <!-- PrÃ³ximas AÃ§Ãµes (Hoje) -->
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="dashboard-today-actions">0</div>
                    <div class="text-xs text-gray-500">AÃ§Ãµes Hoje</div>
                </div>
                
                <!-- Taxa de ConversÃ£o -->
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="dashboard-conversion-rate">0%</div>
                    <div class="text-xs text-gray-500">Taxa ConversÃ£o</div>
                </div>
            </div>
            
            <!-- Barra de Status (opcional, sÃ³ aparece se houver espaÃ§o) -->
            <div class="mt-3 pt-3 border-t border-gray-200 hidden md:block">
                <div class="flex justify-between text-xs text-gray-600">
                    <span>ðŸŸ¢ <span id="dashboard-status-0">0</span></span>
                    <span>ðŸŸ¡ <span id="dashboard-status-1">0</span></span>
                    <span>ðŸ”µ <span id="dashboard-status-2">0</span></span>
                    <span>ðŸ”´ <span id="dashboard-status-3">0</span></span>
                </div>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-8">
            <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="flex-grow">
                    <label for="search-input" class="block text-sm font-medium text-gray-700">Buscar por Empresa ou Contato</label>
                    <input type="text" id="search-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Digite para buscar...">
                </div>
                <div class="md:w-64">
                    <label for="status-filter" class="block text-sm font-medium text-gray-700">Filtrar por Status</label>
                    <select id="status-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="md:w-56">
                    <label for="activity-filter" class="block text-sm font-medium text-gray-700">Filtrar por Atividade</label>
                    <select id="activity-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="all" selected>Todos</option>
                        <option value="active">Ativos</option>
                        <option value="inactive">Inativos</option>
                    </select>
                </div>
                <!-- BotÃ£o de visualizaÃ§Ã£o removido - usando apenas layout de cards -->
                <div class="md:w-auto" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-1">VisualizaÃ§Ã£o</label>
                    <button id="toggle-view-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 md:hidden">
                        ðŸ“± Modo Cards
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Leads -->
        <div id="leads-container" class="bg-white rounded-xl shadow-md">
            <!-- VisualizaÃ§Ã£o Desktop (Tabela) - DESABILITADA para evitar layout duplicado -->
            <div class="table-responsive overflow-x-auto" style="display: none;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Empresa / Contato</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">PrÃ³xima AÃ§Ã£o</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Data PrÃ³xima AÃ§Ã£o</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">AÃ§Ãµes Manuais</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas da tabela serÃ£o inseridas aqui via JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- VisualizaÃ§Ã£o de Cards (principal) -->
            <div class="p-4" style="display: block !important;">
                <div id="leads-cards-body">
                    <!-- Cards mobile serÃ£o inseridos aqui via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Notas -->
    <div id="notes-modal-backdrop" class="modal-backdrop"></div>
    <div id="notes-modal" class="modal bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2">
        <h3 class="text-xl font-semibold mb-4">ObservaÃ§Ãµes</h3>
        <textarea id="modal-notes-textarea" class="w-full h-40 p-2 border border-gray-300 rounded-md"></textarea>
        <div class="mt-4 flex justify-end space-x-2">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
            <button id="modal-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
        </div>
    </div>

    <!-- Modal para Editar Lead -->
    <div id="edit-modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-modal" class="modal bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2">
        <h3 class="text-xl font-semibold mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Editar Lead
        </h3>
        
        <form id="edit-lead-form" class="space-y-4">
            <div>
                <label for="edit-empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                <input type="text" id="edit-empresa" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <div>
                <label for="edit-nome" class="block text-sm font-medium text-gray-700">Nome do Contato</label>
                <input type="text" id="edit-nome" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <div>
                <label for="edit-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                <input type="text" id="edit-cargo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <div>
                <label for="edit-linkedin" class="block text-sm font-medium text-gray-700">URL LinkedIn</label>
                <input type="url" id="edit-linkedin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <div>
                <label for="edit-notes" class="block text-sm font-medium text-gray-700">ObservaÃ§Ãµes</label>
                <textarea id="edit-notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
        </form>
        
        <div class="mt-6 flex justify-end space-x-3">
            <button id="edit-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                Cancelar
            </button>
            <button id="edit-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                Salvar AlteraÃ§Ãµes
            </button>
        </div>
    </div>

    <!-- Modal para RelatÃ³rios -->
    <div id="report-modal-backdrop" class="modal-backdrop"></div>
    <div id="report-modal" class="modal report-modal bg-gray-100 p-6 rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">RelatÃ³rio de Performance</h2>
            <div class="flex items-center space-x-4">
                <button id="refresh-agenda-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-2" title="Atualizar agenda com dados mais recentes">
                    ðŸ”„ Atualizar Agenda
                </button>
                <button id="normalize-dates-btn" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-2" title="Normalizar formatos de data inconsistentes">
                    ðŸ”§ Normalizar Datas
                </button>
                <button id="distribute-leads-btn" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 mr-2" title="Distribuir leads automaticamente pelos prÃ³ximos dias Ãºteis">
                    ðŸ“… Distribuir Leads
                </button>
                <button id="debug-agenda-btn" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 mr-2" title="Debug da agenda - mostrar informaÃ§Ãµes detalhadas">
                    ðŸ› Debug Agenda
                </button>


                <button id="close-report-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
        </div>
        
        <!-- KPIs Semanais -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3">ðŸ“Š MÃ©tricas Semanais (Ãšltimos 7 dias)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Contatos Executados</h3>
                    <p id="report-contacts-week" class="text-3xl font-bold mt-1">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Novas ReuniÃµes</h3>
                    <p id="report-meetings-week" class="text-3xl font-bold mt-1">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Total de Leads Ativos</h3>
                    <p id="report-active-leads" class="text-3xl font-bold mt-1">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Taxa de ConversÃ£o</h3>
                    <p id="report-conversion-rate" class="text-3xl font-bold mt-1">0%</p>
                </div>
            </div>
        </div>

        <!-- KPIs Mensais - ProgressÃ£o no Funil -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-3">ðŸŽ¯ ProgressÃ£o no Funil (Ãšltimos 30 dias)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <h3 class="text-blue-700 text-sm font-medium">ðŸ“ Novos Leads Adicionados</h3>
                    <p id="report-new-leads-month" class="text-2xl font-bold mt-1 text-blue-800">0</p>
                    <p class="text-xs text-blue-600 mt-1">Leads adicionados ao sistema</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <h3 class="text-yellow-700 text-sm font-medium">ðŸ“ž Lista â†’ Em Contato</h3>
                    <p id="report-to-contact-month" class="text-2xl font-bold mt-1 text-yellow-800">0</p>
                    <p class="text-xs text-yellow-600 mt-1">Primeiro contato iniciado</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg shadow border-l-4 border-purple-500">
                    <h3 class="text-purple-700 text-sm font-medium">ðŸ’¬ Em Contato â†’ Conversando</h3>
                    <p id="report-to-talking-month" class="text-2xl font-bold mt-1 text-purple-800">0</p>
                    <p class="text-xs text-purple-600 mt-1">Resposta obtida</p>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg shadow border-l-4 border-indigo-500">
                    <h3 class="text-indigo-700 text-sm font-medium">ðŸ¤ Conversando â†’ ReuniÃ£o</h3>
                    <p id="report-to-meeting-month" class="text-2xl font-bold mt-1 text-indigo-800">0</p>
                    <p class="text-xs text-indigo-600 mt-1">ReuniÃ£o agendada</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg shadow border-l-4 border-orange-500">
                    <h3 class="text-orange-700 text-sm font-medium">ðŸ’¼ ReuniÃ£o â†’ NegociaÃ§Ã£o</h3>
                    <p id="report-to-negotiation-month" class="text-2xl font-bold mt-1 text-orange-800">0</p>
                    <p class="text-xs text-orange-600 mt-1">Proposta apresentada</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow border-l-4 border-green-500">
                    <h3 class="text-green-700 text-sm font-medium">âœ… NegociaÃ§Ã£o â†’ Cliente</h3>
                    <p id="report-to-client-month" class="text-2xl font-bold mt-1 text-green-800">0</p>
                    <p class="text-xs text-green-600 mt-1">Parceria fechada</p>
                </div>
            </div>
        </div>

        <!-- Performance por Mensagem/AÃ§Ã£o -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-3">ðŸŽ¯ Performance por Mensagem (Ãšltimos 30 dias)</h3>
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-600">
                    <strong>Como funciona:</strong> Quando um lead muda de status positivamente, creditamos a conversÃ£o Ã  aÃ§Ã£o/mensagem anterior que foi executada.
                </p>
            </div>
            <div id="message-performance-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Cards de performance por mensagem serÃ£o inseridos aqui -->
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">ðŸ’¡ Insights de Performance</h4>
                <div id="performance-insights" class="space-y-1">
                    <!-- Insights automÃ¡ticos serÃ£o inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Taxas de ConversÃ£o por Etapa -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-3">ðŸ“ˆ Taxas de ConversÃ£o por Etapa (Ãšltimos 30 dias)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Lista â†’ Em Contato</h3>
                    <p id="conversion-to-contact" class="text-xl font-bold mt-1 text-yellow-600">0%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Em Contato â†’ Conversando</h3>
                    <p id="conversion-to-talking" class="text-xl font-bold mt-1 text-purple-600">0%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Conversando â†’ ReuniÃ£o</h3>
                    <p id="conversion-to-meeting" class="text-xl font-bold mt-1 text-indigo-600">0%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">ReuniÃ£o â†’ NegociaÃ§Ã£o</h3>
                    <p id="conversion-to-negotiation" class="text-xl font-bold mt-1 text-orange-600">0%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">NegociaÃ§Ã£o â†’ Cliente</h3>
                    <p id="conversion-to-client" class="text-xl font-bold mt-1 text-green-600">0%</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow border-2 border-gray-300">
                    <h3 class="text-gray-700 text-sm font-medium">ðŸ† Taxa Geral (Lead â†’ Cliente)</h3>
                    <p id="conversion-overall" class="text-xl font-bold mt-1 text-gray-800">0%</p>
                </div>
            </div>
        </div>

        <!-- Agenda dos PrÃ³ximos 14 Dias Ãšteis -->
        <h3 class="text-2xl font-bold mb-4">ðŸ“… Agenda - PrÃ³ximos 14 Dias Ãšteis</h3>
        <div id="agenda-calendar" class="mb-8">
            <!-- Agenda serÃ¡ inserida aqui -->
        </div>

        <!-- Pipeline de Mensagens -->
        <h3 class="text-2xl font-bold mb-4">ðŸŽ¯ Pipeline de Mensagens - Leads Ativos</h3>
        <div id="pipeline-funnel" class="mb-8 bg-white rounded-lg shadow-sm border p-6">
            <!-- Pipeline serÃ¡ inserido aqui -->
        </div>

        <!-- Funil Kanban -->
        <h3 class="text-2xl font-bold mb-4">Funil de ProspecÃ§Ã£o</h3>
        <div id="kanban-board" class="kanban-board">
            <!-- Colunas do Kanban serÃ£o inseridas aqui -->
        </div>
    </div>

    <!-- Modal para RelatÃ³rio Executivo -->
    <div id="executive-modal-backdrop" class="modal-backdrop"></div>
    <div id="executive-modal" class="modal report-modal bg-gray-100 p-6 rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">ðŸ“Š RelatÃ³rio Executivo de Atividades</h2>
            <button id="close-executive-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        
        <!-- Seletor de PerÃ­odo -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold mb-4">ðŸ“… Selecionar PerÃ­odo</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <button id="period-7days" class="period-btn action-btn action-info ring-2 ring-blue-500">
                    ðŸ“… Ãšltimos 7 dias
                </button>
                <button id="period-14days" class="period-btn action-btn action-secondary">
                    ðŸ“… Ãšltimas 2 semanas
                </button>
                <button id="period-30days" class="period-btn action-btn action-secondary">
                    ðŸ“… Ãšltimo mÃªs
                </button>
                <button id="period-custom" class="period-btn action-btn action-secondary">
                    ðŸ“… PerÃ­odo customizado
                </button>
            </div>
            
            <!-- Seletor de datas customizado -->
            <div id="custom-period-selector" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 p-4 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data InÃ­cio</label>
                    <input type="date" id="custom-start-date" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                    <input type="date" id="custom-end-date" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-4">
                <div>
                    <span class="text-sm text-gray-600">PerÃ­odo selecionado: </span>
                    <span id="selected-period-text" class="font-semibold text-gray-800">Ãšltimos 7 dias</span>
                </div>
                <button id="generate-executive-report" class="action-btn action-accent">
                    ðŸ“Š Gerar RelatÃ³rio
                </button>
            </div>
        </div>
        
        <!-- Ãrea do RelatÃ³rio -->
        <div id="executive-report-content" class="space-y-6">
            <div class="bg-white p-8 rounded-lg shadow-md text-center">
                <div class="text-gray-500 text-lg">
                    ðŸ“Š Selecione um perÃ­odo e clique em "Gerar RelatÃ³rio" para visualizar as atividades realizadas.
                </div>
            </div>
        </div>
        
        <!-- BotÃµes de AÃ§Ã£o -->
        <div class="flex justify-end space-x-4 mt-6">
            <button id="export-executive-excel" class="action-btn action-success">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Exportar Excel
            </button>
            <button id="email-executive-report" class="action-btn action-primary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                Enviar por Email
            </button>
        </div>
    </div>

    <!-- Modal para HistÃ³rico de VersÃµes -->
    <div id="version-modal-backdrop" class="modal-backdrop"></div>
    <div id="version-modal" class="modal bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-80vh overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">ðŸ“‹ HistÃ³rico de VersÃµes</h2>
            <button id="close-version-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        
        <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
            <p class="text-sm text-blue-700">
                <strong>Sistema de Versionamento AutomÃ¡tico</strong><br>
                Cada alteraÃ§Ã£o significativa no CRM gera uma nova versÃ£o automaticamente.
            </p>
        </div>

        <div id="version-list" class="space-y-4">
            <!-- VersÃµes serÃ£o inseridas aqui -->
        </div>
    </div>

    <script>
        // --- CONFIGURAÃ‡ÃƒO OBRIGATÃ“RIA ---
        // AVISO DE SEGURANÃ‡A: Em produÃ§Ã£o, mova estas chaves para variÃ¡veis de ambiente
        // Por enquanto, configure aqui mas considere implementar um backend
        
        // ConfiguraÃ§Ã£o das credenciais - CONFIGURADO
        const CONFIG = {
            JSONBIN_API_KEY: "$2a$10$8LughrqC.RmXcfp0ZKyEousPzWo4jgDSJNUc4isyT15.hiUdG9brW", // API Key configurada
            JSONBIN_BIN_ID: "68af741f43b1c97be92dbe9a",  // Bin ID configurado
            // Para maior seguranÃ§a, considere usar um backend que faÃ§a essas chamadas
        };
        
        // ValidaÃ§Ã£o de configuraÃ§Ã£o
        function validateConfig() {
            if (!CONFIG.JSONBIN_API_KEY || !CONFIG.JSONBIN_BIN_ID) {
                return {
                    valid: false,
                    message: "API Key e Bin ID devem ser configurados no inÃ­cio do cÃ³digo."
                };
            }
            
            // Aceita tanto $2a$ quanto $2b$ (ambos sÃ£o vÃ¡lidos para JSONBin)
            if (!CONFIG.JSONBIN_API_KEY.startsWith('$2a$') && !CONFIG.JSONBIN_API_KEY.startsWith('$2b$')) {
                return {
                    valid: false,
                    message: "API Key deve comeÃ§ar com $2a$ ou $2b$"
                };
            }
            
            if (CONFIG.JSONBIN_BIN_ID.length < 10) {
                return {
                    valid: false,
                    message: "Bin ID parece invÃ¡lido (muito curto)"
                };
            }
            
            return { valid: true };
        }
        
        // --- FUNÃ‡Ã•ES DE SEGURANÃ‡A ---
        // FunÃ§Ã£o para escapar HTML e prevenir XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // FunÃ§Ã£o para validar URL
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // FunÃ§Ã£o para validar email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        // ------------------------------------

        // --- VARIÃVEIS GLOBAIS ---
        let leads = [];
        let cadenceConfig = {};
        let database = { leads: [], config: {} };
        
        // Estado de empresas expandidas/retraÃ­das (salvo no localStorage)
        let companyExpandedState = JSON.parse(localStorage.getItem('companyExpandedState') || '{}');

        // --- ELEMENTOS DO DOM ---
        const form = document.getElementById('add-lead-form');
        const tableBody = document.getElementById('leads-table-body');
        const cardsBody = document.getElementById('leads-cards-body');
        const leadsContainer = document.getElementById('leads-container');
        const toggleViewBtn = document.getElementById('toggle-view-btn');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const addActionBtn = document.getElementById('add-action-btn');
        const addStatusBtn = document.getElementById('add-status-btn');
        const actionsConfigContainer = document.getElementById('actions-config-container');
        const statusConfigContainer = document.getElementById('status-config-container');
        const loader = document.getElementById('loader');
        const openReportBtn = document.getElementById('open-report-btn');
        const closeReportBtn = document.getElementById('close-report-btn');
        const exportXlsBtn = document.getElementById('export-xls-btn');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const activityFilter = document.getElementById('activity-filter');
        
        // VariÃ¡vel para controlar visualizaÃ§Ã£o mobile
        let isMobileView = false;
        
        // Controle para evitar renderizaÃ§Ãµes mÃºltiplas
        let isRendering = false;

        // --- MODAL ---
        const notesModalBackdrop = document.getElementById('notes-modal-backdrop');
        const notesModal = document.getElementById('notes-modal');
        const modalTextarea = document.getElementById('modal-notes-textarea');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let currentLeadIdForModal = null;

        // --- MODAL EDITAR LEAD ---
        const editModalBackdrop = document.getElementById('edit-modal-backdrop');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-lead-form');
        const editEmpresaInput = document.getElementById('edit-empresa');
        const editNomeInput = document.getElementById('edit-nome');
        const editCargoInput = document.getElementById('edit-cargo');
        const editLinkedinInput = document.getElementById('edit-linkedin');
        const editNotesInput = document.getElementById('edit-notes');
        const editSaveBtn = document.getElementById('edit-save-btn');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        let currentLeadIdForEdit = null;

        // --- MODAL RELATÃ“RIO ---
        const reportModalBackdrop = document.getElementById('report-modal-backdrop');
        const reportModal = document.getElementById('report-modal');

        // --- MODAL RELATÃ“RIO EXECUTIVO ---
        const executiveModalBackdrop = document.getElementById('executive-modal-backdrop');
        const executiveModal = document.getElementById('executive-modal');
        const executiveReportBtn = document.getElementById('executive-report-btn');
        const closeExecutiveBtn = document.getElementById('close-executive-btn');

        // --- LÃ“GICA DO BANCO DE DADOS (JSONBIN.IO) ---
        const binUrl = `https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`;
        
        async function loadDataFromBin() {
            const configValidation = validateConfig();
            if (!configValidation.valid) {
                document.body.innerHTML = `<div class="text-red-500 text-center p-8">
                    <h1>âŒ Erro de ConfiguraÃ§Ã£o</h1>
                    <p><strong>${configValidation.message}</strong></p>
                    <p>Por favor, configure suas credenciais no inÃ­cio do cÃ³digo JavaScript.</p>
                    <div class="mt-4 p-4 bg-gray-100 rounded-lg text-left text-sm">
                        <p><strong>Como configurar:</strong></p>
                        <ol class="list-decimal list-inside mt-2 space-y-1">
                            <li>Acesse <a href="https://jsonbin.io" target="_blank" class="text-blue-600 underline">jsonbin.io</a></li>
                            <li>Crie uma conta e obtenha sua API Key</li>
                            <li>Crie um novo "bin" e copie o ID</li>
                            <li>Cole as credenciais no objeto CONFIG no inÃ­cio do cÃ³digo</li>
                        </ol>
                    </div>
                </div>`;
                return;
            }

            const defaultConfig = {
                statusOptions: ["ProspecÃ§Ã£o (Backlog)", "Contato em Andamento", "ConexÃ£o/Interesse", "ReuniÃ£o Agendada", "NegociaÃ§Ã£o", "Parceria Fechada", "Parceria Perdida"],
                actions: []
            };

            try {
                const response = await fetch(`${binUrl}/latest`, {
                    headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
                });

                let needsUpdate = false;
                if (response.status === 404) { // Bin nÃ£o existe
                    database = { leads: [], config: defaultConfig };
                    needsUpdate = true;
                } else if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                } else {
                    const data = await response.json();
                    database = data.record;
                    // Verifica se o bin estÃ¡ vazio ou com estrutura antiga/invÃ¡lida
                    if (!database.config) {
                        database = { leads: database.leads || [], config: defaultConfig }; // MantÃ©m os leads se existirem
                        needsUpdate = true;
                    }
                }
                
                if (needsUpdate) {
                    await saveDataToBin(true); // Salva a estrutura correta no bin
                }
                
                // Remover leads duplicados por ID antes de renderizar
                const uniqueLeads = [];
                const seenIds = new Set();
                
                database.leads.forEach(lead => {
                    if (!seenIds.has(lead.id)) {
                        seenIds.add(lead.id);
                        uniqueLeads.push(lead);
                    }
                });
                
                leads = uniqueLeads;
                cadenceConfig = database.config;
                
                console.log('Leads originais:', database.leads.length, 'Leads Ãºnicos:', uniqueLeads.length);

                renderConfigForm();
                populateStatusFilter();
                renderTable();
                
                // Removido reset automÃ¡tico de datas: manter sempre as datas originais do BD
                
                loader.style.display = 'none';

            } catch (error) {
                console.error("Falha ao carregar dados do JSONBin:", error);
                document.body.innerHTML = `<div class="text-red-500 text-center p-8"><h1>Falha ao carregar dados.</h1><p>Verifique se a API Key e o Bin ID estÃ£o corretos e se o Bin existe.</p><p>Erro: ${error.message}</p></div>`;
            }
        }

        async function saveDataToBin(isInitialSave = false, customMessage = "Salvando dados...") {
            if (!isInitialSave) {
                showLoader(customMessage);
            }
            try {
                // Limpar leads duplicados antes de salvar (versÃ£o robusta)
                const uniqueLeads = [];
                const seenIds = new Set();
                const seenCompaniesEmails = new Set(); // Detectar duplicatas por empresa+nome
                
                leads.forEach(lead => {
                    const leadKey = `${lead.empresa}|${lead.nome}|${lead.linkedin}`;
                    
                    if (!seenIds.has(lead.id) && !seenCompaniesEmails.has(leadKey)) {
                        seenIds.add(lead.id);
                        seenCompaniesEmails.add(leadKey);
                        uniqueLeads.push(lead);
                    } else {
                        console.log('ðŸ—‘ï¸ Lead duplicado removido:', lead.empresa, '-', lead.nome);
                    }
                });
                
                console.log('ðŸ§¹ Limpeza no save - Leads antes:', leads.length, 'depois:', uniqueLeads.length);
                
                // Atualizar array global tambÃ©m
                leads = uniqueLeads;
                database.leads = uniqueLeads;
                database.config = cadenceConfig;

                await fetch(binUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CONFIG.JSONBIN_API_KEY
                    },
                    body: JSON.stringify(database)
                });
                if (!isInitialSave) {
                    renderTable();
                }
            } catch (error) {
                console.error("Falha ao salvar dados no JSONBin:", error);
                showNotification("âŒ Erro ao salvar os dados. Verifique sua conexÃ£o.", "error");
            } finally {
                if (!isInitialSave) {
                    hideLoader();
                }
            }
        }
        
        // FunÃ§Ãµes de utilidade para loading e notificaÃ§Ãµes
        function showLoader(message = "Carregando...") {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) loadingText.textContent = message;
            loader.style.display = 'flex';
        }
        
        function hideLoader() {
            loader.style.display = 'none';
        }
        
        function showNotification(message, type = "info") {
            // Criar notificaÃ§Ã£o toast simples
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // Remover apÃ³s 3 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }


        // --- LÃ“GICA DE CONFIGURAÃ‡ÃƒO ---
        const renderConfigForm = () => {
            // Render Status
            statusConfigContainer.innerHTML = '';
            if (cadenceConfig.statusOptions) {
                cadenceConfig.statusOptions.forEach((status, index) => {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'flex items-center space-x-2 p-2 bg-white border rounded-md shadow-sm hover:shadow-md transition-shadow';
                    statusDiv.setAttribute('data-status-index', index);
                    statusDiv.innerHTML = `
                        <span class="handle text-gray-400 cursor-grab hover:text-gray-600 p-1" title="Arrastar para reordenar">â˜°</span>
                        <input type="text" value="${escapeHtml(status)}" class="config-status-name flex-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button class="remove-status-btn text-red-500 hover:text-red-700 p-2 bg-gray-100 rounded-md hover:bg-red-50" data-index="${index}" title="Remover Status">âœ•</button>
                    `;
                    statusConfigContainer.appendChild(statusDiv);
                });
                
                // Inicializar Sortable para drag & drop
                initStatusSortable();
            }

            // Render Actions
            actionsConfigContainer.innerHTML = '';
            if (!cadenceConfig.actions) return;
            cadenceConfig.actions.forEach((action, index) => {
                const actionDiv = document.createElement('div');
                actionDiv.className = 'p-4 border rounded-lg grid grid-cols-1 md:grid-cols-1 gap-4 items-center';
                actionDiv.dataset.actionId = action.id;

                const statusOptionsHTML = (cadenceConfig.statusOptions || []).map(status => 
                    `<option value="${status}" ${action.setsStatusTo === status ? 'selected' : ''}>${status}</option>`
                ).join('');

                actionDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nome da AÃ§Ã£o ${index + 1}</label>
                            <input type="text" value="${action.name}" class="config-action-name mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dias ApÃ³s AÃ§Ã£o Anterior</label>
                            <input type="number" value="${action.delayDays}" class="config-action-delay mt-1 w-full p-2 border rounded-md" min="0">
                        </div>
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700">Muda Status Para:</label>
                                <select class="config-action-status mt-1 w-full p-2 border rounded-md">${statusOptionsHTML}</select>
                            </div>
                            <button class="remove-action-btn text-red-500 hover:text-red-700 p-2 bg-gray-100 rounded-md" title="Remover AÃ§Ã£o">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium text-gray-700">Template de Mensagem (use [NOME] e [EMPRESA])</label>
                        <textarea class="config-action-template mt-1 w-full p-2 border rounded-md h-24">${action.template || ''}</textarea>
                    </div>
                `;
                actionsConfigContainer.appendChild(actionDiv);
            });
        };

        // --- FUNCIONALIDADE DE DRAG & DROP PARA STATUS ---
        let statusSortable = null;

        function initStatusSortable() {
            // Destruir instÃ¢ncia anterior se existir
            if (statusSortable) {
                statusSortable.destroy();
            }
            
            statusSortable = Sortable.create(statusConfigContainer, {
                handle: '.handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onStart: function (evt) {
                    document.body.style.cursor = 'grabbing';
                    showNotification("ðŸ’¡ Arraste para reordenar os status do funil", "info");
                },
                onEnd: function (evt) {
                    document.body.style.cursor = '';
                    
                    // Verificar se houve mudanÃ§a de posiÃ§Ã£o
                    if (evt.oldIndex !== evt.newIndex) {
                        updateStatusOrder(evt.oldIndex, evt.newIndex);
                        showNotification("âœ… Ordem dos status atualizada! Clique em 'Salvar' para confirmar.", "success");
                    }
                }
            });
        }

        function updateStatusOrder(oldIndex, newIndex) {
            // Reordenar array de status
            const statusArray = [...cadenceConfig.statusOptions];
            const movedStatus = statusArray.splice(oldIndex, 1)[0];
            statusArray.splice(newIndex, 0, movedStatus);
            
            // Atualizar configuraÃ§Ã£o
            cadenceConfig.statusOptions = statusArray;
            
            // Re-renderizar para atualizar Ã­ndices
            renderConfigForm();
            
            console.log(`ðŸ“ Status reordenado: "${movedStatus}" movido da posiÃ§Ã£o ${oldIndex} para ${newIndex}`);
        }

        async function saveConfig() {
            // Save Statuses
            const newStatusOptions = [];
            const statusInputs = statusConfigContainer.querySelectorAll('.config-status-name');
            statusInputs.forEach(input => {
                if(input.value.trim()) newStatusOptions.push(input.value.trim());
            });
            cadenceConfig.statusOptions = newStatusOptions;

            // Save Actions
            const newActions = [];
            const actionDivs = actionsConfigContainer.querySelectorAll('[data-action-id]');
            actionDivs.forEach(div => {
                const id = parseFloat(div.dataset.actionId);
                const name = div.querySelector('.config-action-name').value;
                const delayDays = parseInt(div.querySelector('.config-action-delay').value) || 0;
                const setsStatusTo = div.querySelector('.config-action-status').value;
                const template = div.querySelector('.config-action-template').value;
                newActions.push({ id, name, delayDays, setsStatusTo, template });
            });
            cadenceConfig.actions = newActions;
            
            await saveDataToBin(false, "Salvando configuraÃ§Ãµes...");
            populateStatusFilter();
            showNotification("âœ… ConfiguraÃ§Ãµes salvas com sucesso!", "success");
        };

        addStatusBtn.addEventListener('click', () => {
             if (!cadenceConfig.statusOptions) cadenceConfig.statusOptions = [];
             cadenceConfig.statusOptions.push("Novo Status");
             renderConfigForm();
        });

        statusConfigContainer.addEventListener('click', (e) => {
            const removeButton = e.target.closest('.remove-status-btn');
            if (removeButton) {
                const indexToRemove = parseInt(removeButton.dataset.index);
                cadenceConfig.statusOptions.splice(indexToRemove, 1);
                renderConfigForm();
            }
        });

        addActionBtn.addEventListener('click', () => {
            if (!cadenceConfig.actions) cadenceConfig.actions = [];
            cadenceConfig.actions.push({
                id: Date.now(),
                name: "Nova AÃ§Ã£o",
                delayDays: 7,
                setsStatusTo: (cadenceConfig.statusOptions && cadenceConfig.statusOptions.length > 0) ? cadenceConfig.statusOptions[0] : "",
                template: ""
            });
            renderConfigForm();
        });

        actionsConfigContainer.addEventListener('click', (e) => {
            const removeButton = e.target.closest('.remove-action-btn');
            if (removeButton) {
                const actionDiv = removeButton.closest('[data-action-id]');
                const actionIdToRemove = parseFloat(actionDiv.dataset.actionId);
                cadenceConfig.actions = cadenceConfig.actions.filter(a => a.id !== actionIdToRemove);
                renderConfigForm();
            }
        });

        saveConfigBtn.addEventListener('click', saveConfig);


        // --- LÃ“GICA PRINCIPAL DE LEADS ---
        // FunÃ§Ãµes de data padronizadas para evitar problemas de timezone
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setUTCDate(result.getUTCDate() + days);
            return result;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '---';
            const d = new Date(dateStr);
            // Usar UTC para evitar problemas de timezone
            const day = String(d.getUTCDate()).padStart(2, '0');
            const month = String(d.getUTCMonth() + 1).padStart(2, '0');
            const year = d.getUTCFullYear();
            return `${day}/${month}/${year}`;
        };

        const getToday = () => {
            const today = new Date();
            // Criar data UTC para evitar problemas de timezone
            return new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
        };
        
        // FunÃ§Ã£o para verificar se Ã© dia Ãºtil (segunda a sexta)
        const isWorkingDay = (date) => {
            const dayOfWeek = date.getUTCDay();
            return dayOfWeek >= 1 && dayOfWeek <= 5; // 1 = segunda, 5 = sexta
        };
        
        // FUNÃ‡Ã•ES DE CORREÃ‡ÃƒO AUTOMÃTICA REMOVIDAS
        // Sistema agora Ã© 100% fiel Ã s datas originais dos leads
        
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            
            // Se jÃ¡ Ã© uma string ISO completa, usar diretamente
            if (dateStr.includes('T')) {
                return new Date(dateStr);
            }
            
            // Se Ã© formato YYYY-MM-DD, tratar como UTC para evitar problemas de fuso horÃ¡rio
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return new Date(dateStr + 'T00:00:00.000Z');
            }
            
            // NOVO: Se Ã© formato DD/MM/AAAA (brasileiro), converter para ISO
            const brFormat = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (brFormat) {
                const [, day, month, year] = brFormat;
                const isoDate = `${year}-${month}-${day}T00:00:00.000Z`;
                console.log(`[DEBUG parseDate] BR formato: ${dateStr} â†’ ${isoDate}`);
                return new Date(isoDate);
            }
            
            // Fallback para outros formatos
            return new Date(dateStr);
        };

        // Controle para evitar renderizaÃ§Ãµes muito prÃ³ximas
        let lastRenderTime = 0;
        const RENDER_DEBOUNCE_TIME = 200; // milissegundos

        // FunÃ§Ã£o para atualizar o dashboard
        const updateDashboard = () => {
            const totalLeads = leads.length;
            const activeLeads = leads.filter(lead => lead.isActive !== false).length;
            
            // Calcular aÃ§Ãµes para hoje
            const today = new Date().toISOString().split('T')[0];
            const todayActions = leads.filter(lead => {
                if (!lead.nextActionDate) return false;
                const actionDate = new Date(lead.nextActionDate).toISOString().split('T')[0];
                return actionDate === today && lead.isActive !== false;
            }).length;
            
            // Calcular taxa de conversÃ£o (leads que saÃ­ram da lista ou chegaram ao final)
            const completedLeads = leads.filter(lead => {
                return lead.status && lead.status.toLowerCase().includes('finalizado') || 
                       lead.status && lead.status.toLowerCase().includes('convertido') ||
                       lead.status && lead.status.toLowerCase().includes('fechado') ||
                       (lead.currentActionIndex >= (cadenceConfig.actions?.length || 0));
            }).length;
            
            const conversionRate = totalLeads > 0 ? Math.round((completedLeads / totalLeads) * 100) : 0;
            
            // Atualizar elementos do dashboard
            const totalElement = document.getElementById('dashboard-total-leads');
            const activeElement = document.getElementById('dashboard-active-leads');
            const todayElement = document.getElementById('dashboard-today-actions');
            const conversionElement = document.getElementById('dashboard-conversion-rate');
            
            if (totalElement) totalElement.textContent = totalLeads;
            if (activeElement) activeElement.textContent = activeLeads;
            if (todayElement) todayElement.textContent = todayActions;
            if (conversionElement) conversionElement.textContent = conversionRate + '%';
            
            // Atualizar distribuiÃ§Ã£o de status (primeiros 4)
            if (cadenceConfig.statusOptions && cadenceConfig.statusOptions.length > 0) {
                for (let i = 0; i < 4; i++) {
                    const statusElement = document.getElementById(`dashboard-status-${i}`);
                    if (statusElement && cadenceConfig.statusOptions[i]) {
                        const count = leads.filter(lead => lead.status === cadenceConfig.statusOptions[i]).length;
                        statusElement.textContent = count;
                    }
                }
            }
        };

        const renderTable = () => {
            console.log('ðŸ”„ renderTable() chamado - Total leads:', leads.length);
            
            const now = Date.now();
            if (now - lastRenderTime < RENDER_DEBOUNCE_TIME) {
                console.log('ðŸ”„ RenderizaÃ§Ã£o ignorada - muito prÃ³xima da anterior');
                return;
            }
            lastRenderTime = now;

            const searchTerm = searchInput.value.toLowerCase();
            const selectedStatus = statusFilter.value;
            const selectedActivity = activityFilter ? activityFilter.value : 'all';

            console.log('ðŸ” Filtros aplicados:', { searchTerm, selectedStatus, selectedActivity });

            const filteredLeads = leads.filter(lead => {
                // Garantir que os campos existem antes de fazer toLowerCase()
                const empresa = (lead.empresa || '').toLowerCase();
                const nome = (lead.nome || '').toLowerCase();
                
                const matchesSearch = empresa.includes(searchTerm) || nome.includes(searchTerm);
                const matchesStatus = selectedStatus === 'all' || lead.status === selectedStatus;
                const isActive = lead.isActive !== false;
                const matchesActivity = selectedActivity === 'all' || (selectedActivity === 'active' && isActive) || (selectedActivity === 'inactive' && !isActive);
                
                console.log(`ðŸ” Filtrando lead: ${lead.empresa} - ${lead.nome} | Busca: ${matchesSearch} | Status: ${matchesStatus}`);
                
                return matchesSearch && matchesStatus && matchesActivity;
            });

            console.log('ðŸ“Š Leads filtrados:', filteredLeads.length, 'de', leads.length);

            // Renderizar apenas layout de cards (layout tabela removido para evitar duplicaÃ§Ã£o)
            // renderTableView(filteredLeads); // REMOVIDO - causava layout duplicado
            renderCardsView(filteredLeads);
            
            // Atualizar dashboard
            updateDashboard();
        };
        
        const renderTableView = (filteredLeads) => {
            // Evitar renderizaÃ§Ãµes mÃºltiplas simultÃ¢neas com timeout de seguranÃ§a
            if (isRendering) {
                console.log('âš ï¸ RenderizaÃ§Ã£o jÃ¡ em andamento, pulando...');
                return;
            }
            
            isRendering = true;
            console.log('ðŸ”„ Iniciando renderizaÃ§Ã£o da tabela...');
            
            // LIMPEZA COMPLETA E ROBUSTA
            // 1. Limpar innerHTML primeiro (mais rÃ¡pido)
            tableBody.innerHTML = '';
            
            // 2. Verificar e remover qualquer elemento restante
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            
            // 3. Limpar qualquer tbody extra que possa ter sido criado
            const allTbodies = tableBody.parentElement.querySelectorAll('tbody');
            allTbodies.forEach((tbody, index) => {
                if (index > 0) { // Manter apenas o primeiro tbody
                    console.log('ðŸ—‘ï¸ Removendo tbody extra:', index);
                    tbody.remove();
                }
            });
            
            // 4. Reset adicional para garantir estado limpo
            tableBody.setAttribute('data-last-render', Date.now());
            
            if (filteredLeads.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">Nenhum lead encontrado com os filtros atuais.</td></tr>`;
                isRendering = false;
                return;
            }

            const groupedLeads = filteredLeads.reduce((acc, lead) => {
                (acc[lead.empresa] = acc[lead.empresa] || []).push(lead);
                return acc;
            }, {});

            const sortedCompanies = Object.keys(groupedLeads).sort();
            const today = getToday();
            
            // Debug com timestamp para rastrear renderizaÃ§Ãµes
            const renderTimestamp = Date.now();
            console.log(`ðŸ”„ [${renderTimestamp}] Renderizando`, sortedCompanies.length, 'empresas:', sortedCompanies);

            // Armazenar empresas jÃ¡ renderizadas nesta sessÃ£o
            const renderedCompanies = new Set();

            sortedCompanies.forEach(companyName => {
                // VerificaÃ§Ã£o robusta de duplicaÃ§Ã£o
                if (renderedCompanies.has(companyName)) {
                    console.log(`âš ï¸ [${renderTimestamp}] Empresa jÃ¡ renderizada nesta sessÃ£o:`, companyName);
                    return;
                }
                
                // Verificar se jÃ¡ existe header para esta empresa no DOM
                const existingHeader = tableBody.querySelector(`[data-company-header="${CSS.escape(companyName)}"]`);
                if (existingHeader) {
                    console.log(`âš ï¸ [${renderTimestamp}] Header duplicado no DOM para:`, companyName, '- removendo antigo');
                    // Remover header antigo e seus leads
                    const oldLeads = tableBody.querySelectorAll(`tr[data-company="${CSS.escape(companyName)}"]`);
                    existingHeader.remove();
                    oldLeads.forEach(lead => lead.remove());
                }
                
                // Marcar empresa como renderizada
                renderedCompanies.add(companyName);
                
                // Verificar se a empresa estÃ¡ expandida (padrÃ£o: expandida)
                const isExpanded = companyExpandedState[companyName] !== false;
                
                const companyHeader = document.createElement('tr');
                companyHeader.className = `bg-gray-100 company-header ${isExpanded ? '' : 'company-collapsed'}`;
                companyHeader.setAttribute('data-company-header', companyName);
                
                const headerCell = document.createElement('td');
                headerCell.setAttribute('colspan', '5');
                headerCell.className = 'px-6 py-2 font-bold text-gray-800';
                
                const toggleSpan = document.createElement('span');
                toggleSpan.className = 'company-toggle';
                toggleSpan.style.marginRight = '8px';
                toggleSpan.style.fontSize = '16px';
                toggleSpan.style.cursor = 'pointer';
                toggleSpan.textContent = isExpanded ? 'â–¼' : 'â–¶';
                
                // Debug - forÃ§ar exibiÃ§Ã£o
                console.log('Adicionando Ã­cone:', isExpanded ? 'â–¼' : 'â–¶', 'para empresa:', companyName);
                
                headerCell.appendChild(toggleSpan);
                headerCell.appendChild(document.createTextNode(` ${escapeHtml(companyName)} (${groupedLeads[companyName].length} contato(s))`));
                
                companyHeader.appendChild(headerCell);
                
                // Adicionar evento de clique para expandir/retrair
                companyHeader.addEventListener('click', () => {
                    toggleCompany(companyName);
                });
                
                tableBody.appendChild(companyHeader);

                // Container virtual para os leads da empresa (serÃ¡ tratado por classes CSS)

                groupedLeads[companyName].forEach(lead => {
                    const nextActionDate = lead.nextActionDate ? parseDate(lead.nextActionDate) : null;
                    let rowClass = '';
                    if (nextActionDate && nextActionDate.getTime() === today.getTime()) {
                        rowClass = 'highlight-today';
                    } else if (nextActionDate && nextActionDate < today) {
                        rowClass = 'bg-red-100'; // Atrasado
                    }

                    const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                    const actionOptions = [...configuredActions, {name: "AÃ§Ã£o Manual"}, {name: "Ciclo Finalizado"}];
                    const nextActionOptionsHTML = actionOptions.map((action, index) => 
                        `<option value="${index}" ${lead.currentActionIndex === index ? 'selected' : ''}>${action.name}</option>`
                    ).join('');
                    
                    const statusOptionsHTML = (cadenceConfig.statusOptions || []).map(status => 
                        `<option value="${status}" ${lead.status === status ? 'selected' : ''}>${status}</option>`
                    ).join('');
                    
                    let actionButtonsHTML = `
                        <button onclick="window.app.openNotesModal('${lead.id}')" class="text-gray-500 hover:text-gray-800 inline-flex items-center" title="Ver/Editar Notas">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button onclick="window.app.deleteLead('${lead.id}')" class="text-red-500 hover:text-red-800 ml-2 inline-flex items-center" title="Excluir Lead">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    `;

                    if (lead.history && lead.history.length > 0) {
                        actionButtonsHTML = `
                            <button onclick="window.app.undoAction('${lead.id}')" class="text-yellow-600 hover:text-yellow-800 mr-2 inline-flex items-center" title="Desfazer Ãšltima AÃ§Ã£o">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        ` + actionButtonsHTML;
                    }

                    const currentAction = lead.currentActionIndex < configuredActions.length ? configuredActions[lead.currentActionIndex] : null;
                    if (currentAction) {
                        const color = lead.currentActionIndex === 0 ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600';
                        let copyButton = '';
                        if (currentAction.template) {
                            copyButton = `<button onclick="window.app.copyTemplate(this, '${lead.id}')" class="bg-gray-500 text-white text-xs font-bold py-1 px-2 rounded ml-2" title="Copiar Template">Copiar</button>`;
                        }
                        actionButtonsHTML = `<div class="flex items-center justify-center"><button onclick="window.app.executeAction('${lead.id}')" class="${color} text-white text-xs font-bold py-1 px-2 rounded">${currentAction.name}</button>${copyButton}</div> ${actionButtonsHTML}`;
                    }

                    const row = document.createElement('tr');
                    row.dataset.id = lead.id;
                    row.dataset.company = companyName;
                    row.className = `${rowClass} company-lead ${isExpanded ? 'expanded' : 'collapsed'}`;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-bold text-gray-900">${escapeHtml(lead.empresa)}</div>
                            <div class="text-sm text-gray-500">${escapeHtml(lead.nome)} (${escapeHtml(lead.cargo)})</div>
                            <a href="${isValidUrl(lead.linkedin) ? lead.linkedin : '#'}" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-900">Perfil LinkedIn</a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select onchange="window.app.updateLeadStatus('${lead.id}', this.value)" class="p-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-full">
                                ${statusOptionsHTML}
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             <select onchange="window.app.updateNextAction('${lead.id}', this.value)" class="p-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-full">
                                ${nextActionOptionsHTML}
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <span class="editable-date p-1 rounded-md" onclick="window.app.showDateInput(this, '${lead.id}')">${formatDate(lead.nextActionDate)}</span>
                            <input type="date" class="hidden" onchange="window.app.updateNextActionDate('${lead.id}', this.value)" onblur="this.classList.add('hidden'); this.previousElementSibling.classList.remove('hidden')">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            ${actionButtonsHTML}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            });
            
            // Finalizar renderizaÃ§Ã£o com timeout de seguranÃ§a
            setTimeout(() => {
                isRendering = false;
                console.log(`âœ… [${renderTimestamp}] RenderizaÃ§Ã£o da tabela concluÃ­da - ${renderedCompanies.size} empresas renderizadas`);
            }, 100); // Pequeno delay para evitar conflitos
        };
        
        // FunÃ§Ã£o para alternar expansÃ£o/retraÃ§Ã£o de empresa
        const toggleCompany = (companyName) => {
            const isCurrentlyExpanded = companyExpandedState[companyName] !== false;
            const newState = !isCurrentlyExpanded;
            
            // Atualizar estado
            companyExpandedState[companyName] = newState;
            
            // Salvar no localStorage
            localStorage.setItem('companyExpandedState', JSON.stringify(companyExpandedState));
            
            // Atualizar UI das linhas da empresa (tabela - se existir)
            const companyLeads = document.querySelectorAll(`tr[data-company="${CSS.escape(companyName)}"]`);
            companyLeads.forEach(row => {
                if (newState) {
                    row.classList.remove('collapsed');
                    row.classList.add('expanded');
                } else {
                    row.classList.remove('expanded');  
                    row.classList.add('collapsed');
                }
            });
            
            // Atualizar UI dos containers de cards
            const companyCardsContainers = document.querySelectorAll(`div[data-company="${CSS.escape(companyName)}"].company-leads`);
            companyCardsContainers.forEach(container => {
                if (newState) {
                    container.classList.remove('collapsed');
                    container.classList.add('expanded');
                } else {
                    container.classList.remove('expanded');  
                    container.classList.add('collapsed');
                }
            });
            
            // Encontrar header da empresa (tanto tabela quanto cards)
            const companyHeader = Array.from(document.querySelectorAll('.company-header')).find(header => {
                return header.textContent.includes(companyName);
            });
            
            // Atualizar Ã­cone do header
            if (companyHeader) {
                const toggleIcon = companyHeader.querySelector('.company-toggle');
                if (toggleIcon) {
                    toggleIcon.textContent = newState ? 'â–¼' : 'â–¶';
                }
                const toggleBtn = companyHeader.querySelector('.company-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.textContent = newState ? 'Fechar' : 'Abrir';
                }
                
                if (newState) {
                    companyHeader.classList.remove('company-collapsed');
                } else {
                    companyHeader.classList.add('company-collapsed');
                }
            }
        };
        
        const renderCardsView = (filteredLeads) => {
            console.log('ðŸŽ´ Renderizando visualizaÃ§Ã£o em cards...');
            console.log('ðŸ“‹ Leads para renderizar:', filteredLeads.length);
            
            if (!cardsBody) {
                console.error('âŒ cardsBody nÃ£o encontrado!');
                return;
            }
            
            cardsBody.innerHTML = '';
            if (filteredLeads.length === 0) {
                console.log('âš ï¸ Nenhum lead para mostrar');
                cardsBody.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhum lead encontrado com os filtros atuais.</div>`;
                return;
            }
            
            console.log('âœ… Processando leads para exibiÃ§Ã£o...');

            const groupedLeads = filteredLeads.reduce((acc, lead) => {
                (acc[lead.empresa] = acc[lead.empresa] || []).push(lead);
                return acc;
            }, {});

            const sortedCompanies = Object.keys(groupedLeads).sort();
            const today = getToday();

            sortedCompanies.forEach(companyName => {
                // Verificar se a empresa estÃ¡ expandida (padrÃ£o: expandida)
                const isExpanded = companyExpandedState[companyName] !== false;
                
                // Header da empresa com funcionalidade de expandir/retrair
                const companyHeader = document.createElement('div');
                companyHeader.className = `company-header mb-6 p-4`;
                
                // Logo da empresa
                const firstLetter = companyName.charAt(0).toUpperCase();
                const companyColors = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                ];
                const colorIndex = companyName.length % companyColors.length;
                
                companyHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="company-logo" style="background: ${companyColors[colorIndex]};">
                                ${firstLetter}
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(companyName)}</h3>
                                <p class="text-sm text-gray-500">${groupedLeads[companyName].length} contato(s) ativo(s)</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="action-btn action-secondary company-toggle-btn text-xs">${isExpanded ? 'Fechar' : 'Abrir'}</button>
                            <span class="company-toggle text-2xl text-gray-400">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                        </div>
                    </div>
                `;
                
                // Adicionar evento de clique para expandir/retrair
                companyHeader.addEventListener('click', () => {
                    toggleCompany(companyName);
                });
                // BotÃ£o dedicado para abrir/fechar sem propagar
                const toggleBtn = companyHeader.querySelector('.company-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleCompany(companyName);
                    });
                }
                
                cardsBody.appendChild(companyHeader);
                
                // Container para os cards da empresa
                const companyCardsContainer = document.createElement('div');
                companyCardsContainer.className = `company-leads ${isExpanded ? 'expanded' : 'collapsed'}`;
                companyCardsContainer.dataset.company = companyName;

                groupedLeads[companyName].forEach(lead => {
                    const nextActionDate = lead.nextActionDate ? parseDate(lead.nextActionDate) : null;
                    const isInactive = lead.isActive === false;
                    let cardBorderColor = isInactive ? 'border-gray-300' : 'border-gray-300';
                    if (nextActionDate && nextActionDate.getTime() === today.getTime()) {
                        cardBorderColor = isInactive ? 'border-gray-300' : 'border-yellow-400';
                    } else if (nextActionDate && nextActionDate < today) {
                        cardBorderColor = isInactive ? 'border-gray-300' : 'border-red-400';
                    }

                    const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                    const currentAction = lead.currentActionIndex < configuredActions.length ? configuredActions[lead.currentActionIndex] : null;

                    let actionButton = '';
                    if (currentAction && !isInactive) {
                        const buttonClass = lead.currentActionIndex === 0 ? 'action-success' : 'action-primary';
                        actionButton = `
                            <button onclick="window.app.executeAction('${lead.id}')" class="action-btn ${buttonClass} text-sm w-full">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ${currentAction.name}
                            </button>
                        `;
                    }

                    const card = document.createElement('div');
                    card.className = `contact-card p-6 border-l-4 ${cardBorderColor} ${isInactive ? 'opacity-60' : ''}`;
                    
                    let statusColor = '';
                    if (isInactive) {
                        statusColor = 'bg-gray-200 text-gray-700';
                    } else if (nextActionDate && nextActionDate < today) {
                        statusColor = 'bg-red-100 text-red-800';
                    } else if (nextActionDate && nextActionDate.getTime() === today.getTime()) {
                        statusColor = 'bg-yellow-100 text-yellow-800';
                    } else {
                        statusColor = 'bg-green-100 text-green-800';
                    }
                    
                    let copyButton = '';
                    if (currentAction && currentAction.template) {
                        copyButton = `
                            <button onclick="window.app.copyTemplate(this, '${lead.id}')" class="action-btn action-secondary text-sm w-full mt-2">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copiar Template
                            </button>
                        `;
                    }
                    
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(lead.nome)}&background=random&color=fff&size=48" 
                                     alt="${lead.nome}" class="w-12 h-12 rounded-full border-2 border-white shadow-md">
                                <div>
                                    <h4 class="font-semibold ${isInactive ? 'text-gray-500' : 'text-gray-900'} text-lg">${escapeHtml(lead.nome)}${isInactive ? ' (Inativo)' : ''}</h4>
                                    <p class="text-sm text-gray-600">${escapeHtml(lead.cargo)}</p>
                                    <a href="${isValidUrl(lead.linkedin) ? lead.linkedin : '#'}" target="_blank" 
                                       class="text-sm text-blue-600 hover:text-blue-700 transition-colors inline-flex items-center mt-1">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                        </svg>
                                        LinkedIn
                                    </a>
                                </div>
                            </div>
                            <div class="flex flex-col items-end space-y-2">
                                <span class="status-badge ${statusColor}">${isInactive ? 'Inativo (BD)' : escapeHtml(lead.status)}</span>
                                <select ${isInactive ? 'disabled' : ''} onchange="window.app.updateLeadStatus('${lead.id}', this.value)" 
                                        class="text-xs p-1 rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                        title="Alterar Status">
                                    ${(cadenceConfig.statusOptions || []).map(status => 
                                        `<option value="${status}" ${lead.status === status ? 'selected' : ''}>${status}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">PrÃ³xima AÃ§Ã£o</span>
                                ${isInactive ? '<span class="text-xs font-medium text-gray-500">Desativado</span>' : `<span class="text-xs font-medium ${nextActionDate && nextActionDate < today ? 'text-red-600' : nextActionDate && nextActionDate.getTime() === today.getTime() ? 'text-yellow-600' : 'text-green-600'}">${nextActionDate && nextActionDate < today ? 'Atrasado' : nextActionDate && nextActionDate.getTime() === today.getTime() ? 'Hoje' : 'No prazo'}</span>`}
                            </div>
                            ${isInactive ? `<div class="text-sm text-gray-600">Contato desativado (BD). NÃ£o participa do funil.</div>` : `
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-2 h-2 ${nextActionDate && nextActionDate < today ? 'bg-red-500' : nextActionDate && nextActionDate.getTime() === today.getTime() ? 'bg-yellow-500' : 'bg-green-500'} rounded-full"></div>
                                <span class="text-sm text-gray-900 font-medium">${currentAction ? currentAction.name : 'Ciclo Finalizado'}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-600">Data:</span>
                                <div class="flex items-center space-x-2">
                                    <input type="date" 
                                           value="${lead.nextActionDate}" 
                                           onchange="window.app.updateActionDate('${lead.id}', this.value)"
                                           class="text-sm p-2 border-2 border-blue-300 rounded-md bg-blue-50 hover:bg-blue-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 cursor-pointer transition-all"
                                           title="ðŸ“… Clique para alterar a data da prÃ³xima aÃ§Ã£o">
                                    <span class="text-xs text-blue-600 font-medium">âœï¸ EditÃ¡vel</span>
                                </div>
                            </div>`}
                        </div>

                        <div class="space-y-2 mb-4">
                            ${actionButton}
                            ${copyButton}
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                            <div class="flex space-x-3">
                                <button onclick="window.app.openNotesModal('${lead.id}')" 
                                        class="action-btn action-secondary text-sm" title="Notas">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                ${lead.history && lead.history.length > 0 ? `
                                <button onclick="window.app.undoAction('${lead.id}')" 
                                        class="action-btn action-secondary text-yellow-600 text-sm" title="Desfazer">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                    </svg>
                                </button>
                                ` : ''}
                            </div>
                            <button onclick="window.app.openEditModal('${lead.id}')" 
                                    class="action-btn action-info text-sm mr-2" title="Editar Lead">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                <span class="hidden sm:inline">Editar</span>
                            </button>
                            <button onclick="window.app.toggleLeadActive('${lead.id}')" 
                                    class="action-btn ${isInactive ? 'action-success' : 'action-secondary'} text-sm mr-2" 
                                    title="${isInactive ? 'Ativar' : 'Desativar'} Lead">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${isInactive ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2 2 2m-2-2V7m0 7a5 5 0 100-10 5 5 0 000 10z" />'}
                                </svg>
                                ${isInactive ? 'Ativar' : 'Desativar'}
                            </button>
                            <button onclick="window.app.deleteLead('${lead.id}')" 
                                    class="action-btn action-secondary text-red-600 text-sm" title="Excluir">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    companyCardsContainer.appendChild(card);
                });
                
                // Adicionar o container de cards Ã  visualizaÃ§Ã£o mobile
                cardsBody.appendChild(companyCardsContainer);
            });
        };

        // FunÃ§Ã£o para alternar entre visualizaÃ§Ãµes (mobile)
        const toggleMobileView = () => {
            isMobileView = !isMobileView;
            if (isMobileView) {
                leadsContainer.classList.add('mobile-view');
                toggleViewBtn.textContent = 'ðŸ“Š Modo Tabela';
            } else {
                leadsContainer.classList.remove('mobile-view');
                toggleViewBtn.textContent = 'ðŸ“± Modo Cards';
            }
        };

        // --- MANIPULADORES DE EVENTOS GLOBAIS ---
        window.app = {
            toggleAllCompanies: (expand) => {
                const newState = !!expand;
                // Atualiza estado para todas as empresas presentes atualmente
                const companyHeaders = document.querySelectorAll('.company-header');
                companyHeaders.forEach(header => {
                    const nameEl = header.querySelector('h3');
                    if (!nameEl) return;
                    const companyName = nameEl.textContent.trim();
                    companyExpandedState[companyName] = newState;
                });
                localStorage.setItem('companyExpandedState', JSON.stringify(companyExpandedState));
                // Atualiza UI
                document.querySelectorAll('.company-leads').forEach(container => {
                    container.classList.toggle('expanded', newState);
                    container.classList.toggle('collapsed', !newState);
                });
                document.querySelectorAll('.company-header').forEach(header => {
                    const icon = header.querySelector('.company-toggle');
                    if (icon) icon.textContent = newState ? 'â–¼' : 'â–¶';
                    const btn = header.querySelector('.company-toggle-btn');
                    if (btn) btn.textContent = newState ? 'Fechar' : 'Abrir';
                });
            },
            executeAction: (id) => {
                const leadIndex = leads.findIndex(l => l.id === id);
                if(leadIndex === -1) return;
                if (leads[leadIndex].isActive === false) {
                    showNotification('â„¹ï¸ Este contato estÃ¡ desativado (BD). Reative para executar aÃ§Ãµes.', 'info');
                    return;
                }

                const today = getToday();
                const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                const actionJustCompleted = configuredActions[leads[leadIndex].currentActionIndex];
                if (!actionJustCompleted) return;

                const currentActionIndex = leads[leadIndex].currentActionIndex;
                const currentStatus = leads[leadIndex].status;

                // VALIDAÃ‡ÃƒO: Para primeira aÃ§Ã£o (Ã­ndice 0), status deve ser "Lista de Contatos"
                if (currentActionIndex === 0) {
                    const validInitialStatuses = [
                        'Lista de Contatos (ainda nÃ£o abordado)',
                        'Lista de Contatos',
                        'ProspecÃ§Ã£o (Backlog)',
                        'ProspecÃ§Ã£o'
                    ];
                    
                    const isValidInitialStatus = validInitialStatuses.some(validStatus => 
                        currentStatus?.includes(validStatus) || validStatus.includes(currentStatus || '')
                    );
                    
                    if (!isValidInitialStatus) {
                        showNotification(`âš ï¸ Primeira mensagem sÃ³ pode ser enviada para leads com status "Lista de Contatos". Status atual: "${currentStatus}"`, "error");
                        return;
                    }
                }

                leads[leadIndex].history = leads[leadIndex].history || [];
                leads[leadIndex].history.push({
                    status: leads[leadIndex].status,
                    currentActionIndex: leads[leadIndex].currentActionIndex,
                    nextActionDate: leads[leadIndex].nextActionDate,
                    timestamp: new Date().toISOString()
                });

                // LÃ“GICA ESPECIAL: Para primeira aÃ§Ã£o, mudar automaticamente para "Em Contato"
                if (currentActionIndex === 0) {
                    // Buscar status "Em Contato" nas opÃ§Ãµes configuradas
                    const statusOptions = cadenceConfig.statusOptions || [];
                    const emContatoStatus = statusOptions.find(status => 
                        status.includes('Em Contato') || status.includes('Contato em Andamento')
                    );
                    
                    if (emContatoStatus) {
                        leads[leadIndex].status = emContatoStatus;
                        showNotification(`âœ… ${actionJustCompleted.name} executada! Status alterado automaticamente para "${emContatoStatus}"`, "success");
                    } else {
                        // Fallback: usar o status configurado na aÃ§Ã£o
                        leads[leadIndex].status = actionJustCompleted.setsStatusTo;
                        showNotification(`âœ… ${actionJustCompleted.name} executada!`, "success");
                    }
                } else {
                    // Para outras aÃ§Ãµes, usar o status configurado na aÃ§Ã£o
                    leads[leadIndex].status = actionJustCompleted.setsStatusTo;
                    showNotification(`âœ… ${actionJustCompleted.name} executada!`, "success");
                }

                leads[leadIndex].currentActionIndex++;

                const nextAction = configuredActions[leads[leadIndex].currentActionIndex];
                leads[leadIndex].nextActionDate = nextAction ? addDays(today, nextAction.delayDays).toISOString() : null;

                saveDataToBin();
            },
            
            undoAction: (id) => {
                const leadIndex = leads.findIndex(l => l.id === id);
                if (leadIndex === -1) {
                    showNotification("âŒ Lead nÃ£o encontrado.", "error");
                    return;
                }
                
                if (!leads[leadIndex].history || leads[leadIndex].history.length === 0) {
                    showNotification("â„¹ï¸ NÃ£o hÃ¡ aÃ§Ãµes para desfazer neste lead.", "info");
                    return;
                }

                const previousState = leads[leadIndex].history.pop();
                leads[leadIndex].status = previousState.status;
                leads[leadIndex].currentActionIndex = previousState.currentActionIndex;
                leads[leadIndex].nextActionDate = previousState.nextActionDate;
                
                showNotification("âœ… Ãšltima aÃ§Ã£o desfeita com sucesso!", "success");
                saveDataToBin();
            },

            updateLeadStatus: (id, newStatus) => {
                const leadIndex = leads.findIndex(l => l.id === id);
                if (leadIndex === -1 || leads[leadIndex].status === newStatus) return;
                if (leads[leadIndex].isActive === false) {
                    showNotification('â„¹ï¸ Este contato estÃ¡ desativado (BD). Reative para alterar status no funil.', 'info');
                    return;
                }

                leads[leadIndex].history = leads[leadIndex].history || [];
                leads[leadIndex].history.push({ 
                    status: leads[leadIndex].status, 
                    currentActionIndex: leads[leadIndex].currentActionIndex, 
                    nextActionDate: leads[leadIndex].nextActionDate,
                    timestamp: new Date().toISOString(),
                    newStatus: newStatus
                });
                
                leads[leadIndex].status = newStatus;

                const finalStages = ["ReuniÃ£o Agendada", "NegociaÃ§Ã£o", "Parceria Fechada", "Parceria Perdida"];
                if (finalStages.includes(newStatus)) {
                    leads[leadIndex].currentActionIndex = (cadenceConfig.actions.length + 1);
                    leads[leadIndex].nextActionDate = null;
                }

                saveDataToBin();
            },

            updateActionDate: (id, newDate) => {
                const leadIndex = leads.findIndex(l => l.id === id);
                if (leadIndex === -1) return;
                if (leads[leadIndex].isActive === false) {
                    showNotification('â„¹ï¸ Este contato estÃ¡ desativado (BD). Reative para agendar aÃ§Ãµes.', 'info');
                    return;
                }

                const oldDate = leads[leadIndex].nextActionDate;
                console.log(`[DEBUG] updateActionDate chamado para lead ${leads[leadIndex].nome}: ${oldDate} -> ${newDate}`);
                if (oldDate === newDate) {
                    console.log(`[DEBUG] Data nÃ£o mudou, saindo da funÃ§Ã£o`);
                    return;
                }

                // Validar se a data nÃ£o Ã© anterior ao dia atual (exceto se for ajuste do mesmo dia)
                const today = getToday();
                const selectedDate = parseDate(newDate);
                
                if (selectedDate < today) {
                    const confirmPast = confirm(`âš ï¸ ATENÃ‡ÃƒO: VocÃª estÃ¡ definindo uma data no passado (${formatDate(newDate)}).\n\nIsso pode ser Ãºtil para:\nâ€¢ Ajustar aÃ§Ãµes que deveriam ter sido feitas\nâ€¢ Corrigir datas incorretas\nâ€¢ Reagendar aÃ§Ãµes atrasadas\n\nDeseja continuar?`);
                    if (!confirmPast) return;
                }

                leads[leadIndex].history = leads[leadIndex].history || [];
                leads[leadIndex].history.push({ 
                    status: leads[leadIndex].status, 
                    currentActionIndex: leads[leadIndex].currentActionIndex, 
                    nextActionDate: oldDate,
                    timestamp: new Date().toISOString(),
                    action: 'date_updated',
                    oldDate: oldDate,
                    newDate: newDate
                });
                
                leads[leadIndex].nextActionDate = newDate;
                console.log(`[DEBUG] Data do lead ${leads[leadIndex].nome} alterada para: ${leads[leadIndex].nextActionDate}`);

                showNotification(`ðŸ“… Data atualizada para ${formatDate(newDate)}`);
                
                // CORREÃ‡ÃƒO: Aguardar salvamento antes de regenerar relatÃ³rios
                saveDataToBin().then(() => {
                    console.log(`[DEBUG] Dados salvos no JSONBin. Atualizando interfaces...`);
                    renderTable(); // Re-renderizar para atualizar as cores de status
                    
                    // CORREÃ‡ÃƒO: Sempre atualizar a agenda quando data Ã© alterada
                    console.log(`[DEBUG] Regenerando agenda apÃ³s alterar data para: ${newDate}`);
                    
                    // Sempre atualizar a agenda
                    setTimeout(() => {
                        console.log(`[DEBUG] Atualizando agenda...`);
                        generateAgenda(); // Regenera a agenda
                    }, 100);
                    
                    // Se o modal de relatÃ³rios estiver aberto, regenerar tambÃ©m o relatÃ³rio
                    const reportModal = document.getElementById('report-modal');
                    if (reportModal && reportModal.style.display === 'block') {
                        console.log(`[DEBUG] Modal de relatÃ³rios aberto - regenerando relatÃ³rio completo`);
                        setTimeout(() => {
                            generateReport(); // Regenera todos os relatÃ³rios
                        }, 200);
                    }
                }).catch(error => {
                    console.error('[DEBUG] Erro ao salvar dados:', error);
                    // Mesmo com erro, tenta regenerar com dados locais
                    renderTable();
                    const reportModal = document.getElementById('report-modal');
                    if (reportModal && reportModal.style.display === 'block') {
                        generateReport();
                    }
                });
            },

            updateNextAction: (id, newActionIndexStr) => {
                const newActionIndex = parseInt(newActionIndexStr);
                const leadIndex = leads.findIndex(l => l.id === id);
                if (leadIndex === -1 || leads[leadIndex].currentActionIndex === newActionIndex) return;
                if (leads[leadIndex].isActive === false) {
                    showNotification('â„¹ï¸ Este contato estÃ¡ desativado (BD). Reative para alterar a prÃ³xima aÃ§Ã£o.', 'info');
                    return;
                }

                leads[leadIndex].currentActionIndex = newActionIndex;

                const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                const nextAction = configuredActions[newActionIndex];
                if (nextAction) {
                    const today = getToday();
                    leads[leadIndex].nextActionDate = addDays(today, nextAction.delayDays).toISOString();
                } else {
                    leads[leadIndex].nextActionDate = null;
                }
                
                saveDataToBin();
            },

            showDateInput: (element, leadId) => {
                const lead = leads.find(l => l.id === leadId);
                if (!lead) return;

                const dateInput = element.nextElementSibling;
                element.classList.add('hidden');
                dateInput.classList.remove('hidden');
                dateInput.value = lead.nextActionDate ? lead.nextActionDate.split('T')[0] : '';
                dateInput.focus();
            },

            updateNextActionDate: (id, newDateStr) => {
                console.log(`[DEBUG updateNextActionDate] Iniciando atualizaÃ§Ã£o:`, { id, newDateStr });
                
                if (!newDateStr) {
                    console.log(`[DEBUG updateNextActionDate] âŒ newDateStr vazio`);
                    return;
                }
                
                const leadIndex = leads.findIndex(l => l.id === id);
                if (leadIndex === -1) {
                    console.log(`[DEBUG updateNextActionDate] âŒ Lead nÃ£o encontrado com ID: ${id}`);
                    return;
                }
                
                const lead = leads[leadIndex];
                console.log(`[DEBUG updateNextActionDate] ðŸ“‹ Lead encontrado: ${lead.nome}, isActive: ${lead.isActive}`);
                
                if (lead.isActive === false) {
                    console.log(`[DEBUG updateNextActionDate] âŒ Lead inativo`);
                    showNotification('â„¹ï¸ Este contato estÃ¡ desativado (BD). Reative para agendar aÃ§Ãµes.', 'info');
                    return;
                }
                
                const oldDate = lead.nextActionDate;
                const parsedDate = new Date(newDateStr + 'T00:00:00.000Z'); // ForÃ§a UTC
                lead.nextActionDate = parsedDate.toISOString();
                
                console.log(`[DEBUG updateNextActionDate] ðŸ“… AlteraÃ§Ã£o realizada:`);
                console.log(`  - Lead: ${lead.nome}`);
                console.log(`  - Data antiga: ${oldDate}`);
                console.log(`  - Data nova: ${lead.nextActionDate}`);
                console.log(`  - Input recebido: ${newDateStr}`);
                
                // Salvar no BD
                console.log(`[DEBUG updateNextActionDate] ðŸ’¾ Iniciando salvamento no BD...`);
                saveDataToBin().then(() => {
                    console.log(`[DEBUG updateNextActionDate] âœ… Salvamento concluÃ­do com sucesso`);
                    generateAgenda();
                    showNotification(`ðŸ“… Data atualizada: ${lead.nome} â†’ ${formatDate(lead.nextActionDate)}`, 'success');
                }).catch(error => {
                    console.error(`[DEBUG updateNextActionDate] âŒ Erro no salvamento:`, error);
                    showNotification(`âŒ Erro ao salvar alteraÃ§Ã£o da data`, 'error');
                });
            },

            toggleLeadActive: (id) => {
                const leadIndex = leads.findIndex(l => l.id === id);
                if (leadIndex === -1) return;
                const current = leads[leadIndex].isActive !== false; // default true
                leads[leadIndex].isActive = !current;
                if (leads[leadIndex].isActive) {
                    showNotification('âœ… Contato ativado. Ele volta a participar do funil e da agenda.', 'success');
                } else {
                    showNotification('â¸ï¸ Contato desativado. Ele nÃ£o participa do funil nem da agenda.', 'info');
                }
                saveDataToBin();
            },

            deleteLead: (id) => {
                if (confirm('Tem certeza que deseja excluir este lead? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
                    leads = leads.filter(l => l.id !== id);
                    saveDataToBin();
                }
            },

            openEditModal: (id) => {
                currentLeadIdForEdit = id;
                const lead = leads.find(l => l.id === id);
                if (lead) {
                    // Preencher campos do formulÃ¡rio
                    editEmpresaInput.value = lead.empresa || '';
                    editNomeInput.value = lead.nome || '';
                    editCargoInput.value = lead.cargo || '';
                    editLinkedinInput.value = lead.linkedin || '';
                    editNotesInput.value = lead.notes || '';
                    
                    // Mostrar modal
                    editModalBackdrop.style.display = 'block';
                    editModal.style.display = 'block';
                    
                    // Focar no primeiro campo
                    editEmpresaInput.focus();
                }
            },

            saveEditedLead: () => {
                if (!currentLeadIdForEdit) return;
                
                const leadIndex = leads.findIndex(l => l.id === currentLeadIdForEdit);
                if (leadIndex === -1) return;
                
                // Validar campos obrigatÃ³rios
                const empresa = editEmpresaInput.value.trim();
                const nome = editNomeInput.value.trim();
                
                if (!empresa || !nome) {
                    showNotification("âŒ Empresa e Nome sÃ£o obrigatÃ³rios", "error");
                    return;
                }
                
                // Atualizar lead
                leads[leadIndex].empresa = empresa;
                leads[leadIndex].nome = nome;
                leads[leadIndex].cargo = editCargoInput.value.trim();
                leads[leadIndex].linkedin = editLinkedinInput.value.trim();
                leads[leadIndex].notes = editNotesInput.value.trim();
                
                // Fechar modal
                editModalBackdrop.style.display = 'none';
                editModal.style.display = 'none';
                currentLeadIdForEdit = null;
                
                // Salvar e atualizar interface
                saveDataToBin();
                
                // CORREÃ‡ÃƒO: Atualizar agenda quando lead Ã© editado
                setTimeout(() => {
                    generateAgenda();
                }, 500);
                
                showNotification("âœ… Lead atualizado com sucesso!", "success");
            },

            closeEditModal: () => {
                editModalBackdrop.style.display = 'none';
                editModal.style.display = 'none';
                currentLeadIdForEdit = null;
            },
            
            openNotesModal: (id) => {
                currentLeadIdForModal = id;
                const lead = leads.find(l => l.id === id);
                if (lead) {
                    modalTextarea.value = lead.notes || '';
                    notesModal.style.display = 'block';
                    notesModalBackdrop.style.display = 'block';
                }
            },

            copyTemplate: (buttonElement, leadId) => {
                const lead = leads.find(l => l.id === leadId);
                const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                const currentAction = configuredActions[lead.currentActionIndex];

                if (!lead || !currentAction || !currentAction.template) return;

                let templateText = currentAction.template;
                templateText = templateText.replace(/\[NOME\]/g, lead.nome.split(' ')[0]); // Pega sÃ³ o primeiro nome
                templateText = templateText.replace(/\[EMPRESA\]/g, lead.empresa);

                navigator.clipboard.writeText(templateText).then(() => {
                    buttonElement.textContent = 'Copiado!';
                    setTimeout(() => {
                        buttonElement.textContent = 'Copiar';
                    }, 2000);
                }).catch(err => {
                    console.error('Falha ao copiar texto: ', err);
                });
            }
        };

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const newLead = {
                id: Date.now().toString(),
                empresa: document.getElementById('empresa').value,
                nome: document.getElementById('nome').value,
                cargo: document.getElementById('cargo').value,
                linkedin: document.getElementById('linkedin').value,
                status: (cadenceConfig.statusOptions && cadenceConfig.statusOptions.length > 0) ? cadenceConfig.statusOptions[0] : "N/A",
                currentActionIndex: 0,
                nextActionDate: getToday().toISOString(),
                notes: '',
                history: [],
                createdAt: new Date().toISOString(),
                isActive: true
            };
            leads.push(newLead);
            saveDataToBin();
            form.reset();
            
            // Fechar formulÃ¡rio apÃ³s adicionar com sucesso
            const addLeadFormContainer = document.getElementById('add-lead-form-container');
            const toggleArrow = document.getElementById('toggle-arrow');
            if (addLeadFormContainer && toggleArrow) {
                addLeadFormContainer.classList.add('hidden');
                toggleArrow.style.transform = 'rotate(0deg)';
                showNotification('âœ… Lead adicionado com sucesso!', 'success');
            }
        });

        const closeNotesModal = () => {
            notesModal.style.display = 'none';
            notesModalBackdrop.style.display = 'none';
            currentLeadIdForModal = null;
        };

        modalSaveBtn.addEventListener('click', () => {
            if (currentLeadIdForModal) {
                const leadIndex = leads.findIndex(l => l.id === currentLeadIdForModal);
                if(leadIndex !== -1) {
                    leads[leadIndex].notes = modalTextarea.value;
                    saveDataToBin();
                }
            }
            closeNotesModal();
        });

        modalCancelBtn.addEventListener('click', closeNotesModal);
        notesModalBackdrop.addEventListener('click', closeNotesModal);

        // Event listeners para modal de ediÃ§Ã£o
        editSaveBtn.addEventListener('click', window.app.saveEditedLead);
        editCancelBtn.addEventListener('click', window.app.closeEditModal);
        editModalBackdrop.addEventListener('click', window.app.closeEditModal);
        
        // SubmissÃ£o do formulÃ¡rio de ediÃ§Ã£o
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            window.app.saveEditedLead();
        });
        
        // Adicionar suporte para tecla ESC fechar modais
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (notesModal.style.display === 'block') {
                    closeNotesModal();
                } else if (editModal.style.display === 'block') {
                    window.app.closeEditModal();
                }
                if (reportModal.style.display === 'block') {
                    closeReportModal();
                }
            }
        });

        // --- LÃ“GICA DO RELATÃ“RIO ---
        const generateReport = () => {
            const today = getToday();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            // ========== MÃ‰TRICAS SEMANAIS ==========
            let contactsLastWeek = 0;
            let meetingsLastWeek = 0;
            
            // Contar apenas aÃ§Ãµes reais de contato (nÃ£o mudanÃ§as de status manuais)
            leads.forEach(lead => {
                if (lead.history && lead.history.length > 0) {
                    lead.history.forEach(h => {
                        const actionDate = new Date(h.timestamp);
                        if (actionDate >= sevenDaysAgo) {
                            // Contar apenas se for uma execuÃ§Ã£o de aÃ§Ã£o (nÃ£o mudanÃ§a manual de status)
                            if (!h.newStatus) {
                                contactsLastWeek++; // Esta Ã© uma aÃ§Ã£o real executada
                            }
                            
                            // Contar reuniÃµes agendadas (tanto por aÃ§Ã£o quanto manual)
                            if (h.newStatus === "ReuniÃ£o Agendada" || 
                                (h.status && h.status !== "ReuniÃ£o Agendada" && 
                                 lead.status === "ReuniÃ£o Agendada")) {
                                meetingsLastWeek++;
                            }
                        }
                    });
                }
            });

            const activeLeads = leads.filter(l => l.status !== "Parceria Fechada" && l.status !== "Parceria Perdida").length;
            
            const leadsReachedContact = leads.filter(l => l.history && l.history.some(h => h.status === "Contato em Andamento")).length;
            const leadsReachedMeeting = leads.filter(l => l.status === "ReuniÃ£o Agendada" || l.status === "NegociaÃ§Ã£o" || l.status === "Parceria Fechada").length;
            const conversionRate = leadsReachedContact > 0 ? ((leadsReachedMeeting / leadsReachedContact) * 100).toFixed(1) : 0;

            // ========== MÃ‰TRICAS MENSAIS - PROGRESSÃƒO NO FUNIL ==========
            let newLeadsMonth = 0;
            let toContactMonth = 0;
            let toTalkingMonth = 0;
            let toMeetingMonth = 0;
            let toNegotiationMonth = 0;
            let toClientMonth = 0;

            // Contar leads adicionados no Ãºltimo mÃªs (baseado na data de criaÃ§Ã£o estimada)
            leads.forEach(lead => {
                // Estimar data de criaÃ§Ã£o pela primeira entrada no histÃ³rico ou nextActionDate
                let creationDate = null;
                if (lead.history && lead.history.length > 0) {
                    // Usar a entrada mais antiga do histÃ³rico
                    const oldestHistory = lead.history.reduce((oldest, current) => {
                        return new Date(current.timestamp) < new Date(oldest.timestamp) ? current : oldest;
                    });
                    creationDate = new Date(oldestHistory.timestamp);
                } else if (lead.nextActionDate) {
                    creationDate = new Date(lead.nextActionDate);
                }
                
                if (creationDate && creationDate >= thirtyDaysAgo) {
                    newLeadsMonth++;
                }

                // Analisar progressÃµes de status no Ãºltimo mÃªs
                if (lead.history) {
                    lead.history.forEach(h => {
                        const actionDate = new Date(h.timestamp);
                        if (actionDate >= thirtyDaysAgo && h.newStatus) {
                            const fromStatus = h.status;
                            const toStatus = h.newStatus;

                            // Lista â†’ Em Contato (APENAS mudanÃ§as manuais, nÃ£o automÃ¡ticas da primeira aÃ§Ã£o)
                            if ((fromStatus?.includes('Lista') || fromStatus?.includes('ProspecÃ§Ã£o')) && 
                                (toStatus?.includes('Contato') || toStatus?.includes('Em Contato'))) {
                                // Verificar se foi uma mudanÃ§a manual (tem newStatus mas nÃ£o foi execuÃ§Ã£o de aÃ§Ã£o)
                                // Se foi automÃ¡tica da primeira aÃ§Ã£o, nÃ£o contar como conversÃ£o
                                const wasAutomaticFirstAction = h.currentActionIndex === 0;
                                if (!wasAutomaticFirstAction) {
                                    toContactMonth++;
                                }
                            }

                            // Em Contato â†’ Conversando
                            if ((fromStatus?.includes('Contato') || fromStatus?.includes('Em Contato')) && 
                                (toStatus?.includes('Interesse') || toStatus?.includes('Conversando') || toStatus?.includes('ConexÃ£o'))) {
                                toTalkingMonth++;
                            }

                            // Conversando â†’ ReuniÃ£o
                            if ((fromStatus?.includes('Interesse') || fromStatus?.includes('Conversando') || fromStatus?.includes('ConexÃ£o')) && 
                                toStatus?.includes('ReuniÃ£o')) {
                                toMeetingMonth++;
                            }

                            // ReuniÃ£o â†’ NegociaÃ§Ã£o
                            if (fromStatus?.includes('ReuniÃ£o') && toStatus?.includes('NegociaÃ§Ã£o')) {
                                toNegotiationMonth++;
                            }

                            // NegociaÃ§Ã£o â†’ Cliente
                            if (fromStatus?.includes('NegociaÃ§Ã£o') && 
                                (toStatus?.includes('Fechada') || toStatus?.includes('Cliente') || toStatus?.includes('Parceria Fechada'))) {
                                toClientMonth++;
                            }
                        }
                    });
                }
            });

            // ========== TAXAS DE CONVERSÃƒO POR ETAPA ==========
            const statusCounts = {};
            leads.forEach(lead => {
                statusCounts[lead.status] = (statusCounts[lead.status] || 0) + 1;
            });

            // Contagem aproximada por tipo de status
            const listStatusCount = Object.keys(statusCounts).reduce((total, status) => {
                return total + (status.includes('Lista') || status.includes('ProspecÃ§Ã£o') ? statusCounts[status] : 0);
            }, 0);

            const contactStatusCount = Object.keys(statusCounts).reduce((total, status) => {
                return total + (status.includes('Contato') || status.includes('Em Contato') ? statusCounts[status] : 0);
            }, 0);

            const talkingStatusCount = Object.keys(statusCounts).reduce((total, status) => {
                return total + (status.includes('Interesse') || status.includes('Conversando') || status.includes('ConexÃ£o') ? statusCounts[status] : 0);
            }, 0);

            const meetingStatusCount = Object.keys(statusCounts).reduce((total, status) => {
                return total + (status.includes('ReuniÃ£o') ? statusCounts[status] : 0);
            }, 0);

            const negotiationStatusCount = Object.keys(statusCounts).reduce((total, status) => {
                return total + (status.includes('NegociaÃ§Ã£o') ? statusCounts[status] : 0);
            }, 0);

            // Calcular taxas de conversÃ£o
            const conversionToContact = listStatusCount > 0 ? ((toContactMonth / listStatusCount) * 100).toFixed(1) : 0;
            const conversionToTalking = contactStatusCount > 0 ? ((toTalkingMonth / contactStatusCount) * 100).toFixed(1) : 0;
            const conversionToMeeting = talkingStatusCount > 0 ? ((toMeetingMonth / talkingStatusCount) * 100).toFixed(1) : 0;
            const conversionToNegotiation = meetingStatusCount > 0 ? ((toNegotiationMonth / meetingStatusCount) * 100).toFixed(1) : 0;
            const conversionToClient = negotiationStatusCount > 0 ? ((toClientMonth / negotiationStatusCount) * 100).toFixed(1) : 0;
            const conversionOverall = newLeadsMonth > 0 ? ((toClientMonth / newLeadsMonth) * 100).toFixed(1) : 0;

            // ========== ATUALIZAR INTERFACE ==========
            
            // MÃ©tricas semanais
            document.getElementById('report-contacts-week').textContent = contactsLastWeek;
            document.getElementById('report-meetings-week').textContent = meetingsLastWeek;
            document.getElementById('report-active-leads').textContent = activeLeads;
            document.getElementById('report-conversion-rate').textContent = `${conversionRate}%`;

            // ProgressÃ£o mensal
            document.getElementById('report-new-leads-month').textContent = newLeadsMonth;
            document.getElementById('report-to-contact-month').textContent = toContactMonth;
            document.getElementById('report-to-talking-month').textContent = toTalkingMonth;
            document.getElementById('report-to-meeting-month').textContent = toMeetingMonth;
            document.getElementById('report-to-negotiation-month').textContent = toNegotiationMonth;
            document.getElementById('report-to-client-month').textContent = toClientMonth;

            // Taxas de conversÃ£o
            document.getElementById('conversion-to-contact').textContent = `${conversionToContact}%`;
            document.getElementById('conversion-to-talking').textContent = `${conversionToTalking}%`;
            document.getElementById('conversion-to-meeting').textContent = `${conversionToMeeting}%`;
            document.getElementById('conversion-to-negotiation').textContent = `${conversionToNegotiation}%`;
            document.getElementById('conversion-to-client').textContent = `${conversionToClient}%`;
            document.getElementById('conversion-overall').textContent = `${conversionOverall}%`;

            // ========== ANÃLISE DE PERFORMANCE POR MENSAGEM ==========
            generateMessagePerformance();

            generateAgenda();
            generatePipeline();
            generateKanban();
        }

        function generateMessagePerformance() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
            if (configuredActions.length === 0) {
                document.getElementById('message-performance-grid').innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <p>ðŸ“­ Nenhuma aÃ§Ã£o configurada ainda.</p>
                        <p class="text-sm">Configure suas mensagens em <strong>ConfiguraÃ§Ãµes</strong> para ver a anÃ¡lise de performance.</p>
                    </div>
                `;
                return;
            }

            // EstatÃ­sticas por aÃ§Ã£o
            const actionStats = {};
            configuredActions.forEach((action, index) => {
                actionStats[index] = {
                    name: action.name,
                    executions: 0,
                    conversions: 0,
                    conversionRate: 0
                };
            });

            // Analisar histÃ³rico dos leads
            leads.forEach(lead => {
                if (lead.history && lead.history.length > 0) {
                    lead.history.forEach(historyItem => {
                        const actionDate = new Date(historyItem.timestamp);
                        if (actionDate >= thirtyDaysAgo) {
                            // Se foi uma execuÃ§Ã£o de aÃ§Ã£o (nÃ£o mudanÃ§a manual de status)
                            if (!historyItem.newStatus && typeof historyItem.currentActionIndex === 'number') {
                                const actionIndex = historyItem.currentActionIndex;
                                if (actionStats[actionIndex]) {
                                    actionStats[actionIndex].executions++;
                                }
                            }
                            
                            // Se foi uma mudanÃ§a de status positiva, creditar Ã  aÃ§Ã£o anterior
                            if (historyItem.newStatus) {
                                const previousActionIndex = historyItem.currentActionIndex;
                                const isPositiveStatusChange = isStatusProgression(historyItem.status, historyItem.newStatus);
                                
                                // NÃƒO contar mudanÃ§a automÃ¡tica Listaâ†’Em Contato da primeira aÃ§Ã£o
                                const isAutomaticFirstAction = previousActionIndex === 0 && 
                                    (historyItem.status?.includes('Lista') || historyItem.status?.includes('ProspecÃ§Ã£o')) &&
                                    (historyItem.newStatus?.includes('Contato') || historyItem.newStatus?.includes('Em Contato'));
                                
                                if (isPositiveStatusChange && typeof previousActionIndex === 'number' && 
                                    actionStats[previousActionIndex] && !isAutomaticFirstAction) {
                                    actionStats[previousActionIndex].conversions++;
                                }
                            }
                        }
                    });
                }
            });

            // Calcular taxas de conversÃ£o
            Object.keys(actionStats).forEach(actionIndex => {
                const stats = actionStats[actionIndex];
                if (stats.executions > 0) {
                    stats.conversionRate = ((stats.conversions / stats.executions) * 100).toFixed(1);
                }
            });

            // Renderizar cards de performance
            const performanceGrid = document.getElementById('message-performance-grid');
            performanceGrid.innerHTML = '';

            configuredActions.forEach((action, index) => {
                const stats = actionStats[index];
                let cardColor = 'bg-gray-50 border-gray-300';
                let textColor = 'text-gray-700';
                let iconColor = 'text-gray-500';
                
                if (stats.conversionRate >= 20) {
                    cardColor = 'bg-green-50 border-green-300';
                    textColor = 'text-green-800';
                    iconColor = 'text-green-600';
                } else if (stats.conversionRate >= 10) {
                    cardColor = 'bg-yellow-50 border-yellow-300';
                    textColor = 'text-yellow-800';
                    iconColor = 'text-yellow-600';
                } else if (stats.executions > 0) {
                    cardColor = 'bg-red-50 border-red-300';
                    textColor = 'text-red-800';
                    iconColor = 'text-red-600';
                }

                const card = document.createElement('div');
                card.className = `${cardColor} border-2 p-4 rounded-lg`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="${textColor} font-semibold text-sm">${action.name}</h4>
                        <span class="${iconColor}">
                            ${stats.conversionRate >= 20 ? 'ðŸŽ¯' : stats.conversionRate >= 10 ? 'ðŸ“ˆ' : stats.executions > 0 ? 'ðŸ“‰' : 'ðŸ“­'}
                        </span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">ExecuÃ§Ãµes:</span>
                            <span class="${textColor} font-bold">${stats.executions}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">ConversÃµes:</span>
                            <span class="${textColor} font-bold">${stats.conversions}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600">Taxa:</span>
                            <span class="${textColor} font-bold text-lg">${stats.conversionRate}%</span>
                        </div>
                    </div>
                `;
                performanceGrid.appendChild(card);
            });

            // Gerar insights automÃ¡ticos
            generatePerformanceInsights(actionStats, configuredActions);
        }

        function isStatusProgression(fromStatus, toStatus) {
            // Definir hierarquia de status (do menor para o maior)
            const statusHierarchy = [
                'ProspecÃ§Ã£o',
                'Lista de Contatos',
                'Contato em Andamento',
                'Em Contato',
                'ConexÃ£o/Interesse',
                'Conversando',
                'ReuniÃ£o Agendada',
                'NegociaÃ§Ã£o',
                'Parceria Fechada',
                'Cliente'
            ];

            const fromIndex = statusHierarchy.findIndex(status => 
                fromStatus?.includes(status) || status.includes(fromStatus || '')
            );
            const toIndex = statusHierarchy.findIndex(status => 
                toStatus?.includes(status) || status.includes(toStatus || '')
            );

            // Se ambos os status foram encontrados e o destino Ã© maior que a origem
            return fromIndex !== -1 && toIndex !== -1 && toIndex > fromIndex;
        }

        function generatePerformanceInsights(actionStats, configuredActions) {
            const insightsContainer = document.getElementById('performance-insights');
            const insights = [];

            // Encontrar melhor e pior performance
            let bestAction = null;
            let worstAction = null;
            let bestRate = -1;
            let worstRate = 101;

            Object.keys(actionStats).forEach(actionIndex => {
                const stats = actionStats[actionIndex];
                if (stats.executions > 0) {
                    const rate = parseFloat(stats.conversionRate);
                    if (rate > bestRate) {
                        bestRate = rate;
                        bestAction = stats;
                    }
                    if (rate < worstRate) {
                        worstRate = rate;
                        worstAction = stats;
                    }
                }
            });

            // Gerar insights
            if (bestAction && bestRate > 0) {
                insights.push(`ðŸ† <strong>${bestAction.name}</strong> Ã© sua melhor mensagem com <strong>${bestRate}%</strong> de conversÃ£o`);
            }

            if (worstAction && worstRate < 100 && bestAction !== worstAction) {
                insights.push(`âš ï¸ <strong>${worstAction.name}</strong> precisa de atenÃ§Ã£o com apenas <strong>${worstRate}%</strong> de conversÃ£o`);
            }

            const totalExecutions = Object.values(actionStats).reduce((sum, stats) => sum + stats.executions, 0);
            const totalConversions = Object.values(actionStats).reduce((sum, stats) => sum + stats.conversions, 0);
            
            if (totalExecutions > 0) {
                const overallRate = ((totalConversions / totalExecutions) * 100).toFixed(1);
                insights.push(`ðŸ“Š Taxa geral de conversÃ£o por aÃ§Ã£o: <strong>${overallRate}%</strong>`);
            }

            // SugestÃµes baseadas nos dados
            if (bestRate > 0 && worstRate < bestRate - 10) {
                insights.push(`ðŸ’¡ Considere ajustar o template da <strong>${worstAction.name}</strong> baseado no sucesso da <strong>${bestAction.name}</strong>`);
            }

            // Renderizar insights
            if (insights.length === 0) {
                insightsContainer.innerHTML = '<p class="text-blue-600 text-sm">ðŸ“ˆ Execute mais aÃ§Ãµes para ver insights personalizados!</p>';
            } else {
                insightsContainer.innerHTML = insights.map(insight => 
                    `<p class="text-blue-700 text-sm">â€¢ ${insight}</p>`
                ).join('');
            }
        }

        function generatePipeline() {
            const pipelineContainer = document.getElementById('pipeline-funnel');
            pipelineContainer.innerHTML = '';
            
            // Obter configuraÃ§Ãµes de aÃ§Ãµes
            const actions = cadenceConfig.actions || [];
            if (actions.length === 0) {
                pipelineContainer.innerHTML = '<p class="text-center text-gray-500">Configure as aÃ§Ãµes da cadÃªncia primeiro.</p>';
                return;
            }
            
            // Filtrar apenas leads ativos
            const activeLeads = leads.filter(l => l.isActive !== false);
            
            // Atualizar tÃ­tulo com contador de leads ativos
            const pipelineTitle = document.querySelector('#pipeline-funnel').previousElementSibling;
            if (pipelineTitle && pipelineTitle.tagName === 'H3') {
                pipelineTitle.innerHTML = `ðŸŽ¯ Pipeline de Mensagens - Leads Ativos (${activeLeads.length})`;
            }
            
            // Agrupar leads por currentActionIndex
            const leadsByStage = {};
            for (let i = 0; i < actions.length; i++) {
                leadsByStage[i] = [];
            }
            
            activeLeads.forEach(lead => {
                const stage = lead.currentActionIndex || 0;
                if (stage < actions.length) {
                    leadsByStage[stage].push(lead);
                }
            });
            
            // FunÃ§Ã£o para gerar iniciais
            const getInitials = (name) => {
                return name.split(' ')
                    .map(word => word.charAt(0).toUpperCase())
                    .slice(0, 2)
                    .join('');
            };
            
            // FunÃ§Ã£o para cores do avatar baseada no nome
            const getAvatarColor = (name) => {
                const colors = [
                    'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                    'linear-gradient(135deg, #f59e0b, #d97706)',
                    'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                    'linear-gradient(135deg, #10b981, #059669)',
                    'linear-gradient(135deg, #ef4444, #dc2626)',
                    'linear-gradient(135deg, #6366f1, #4f46e5)',
                    'linear-gradient(135deg, #ec4899, #db2777)'
                ];
                const index = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                return colors[index % colors.length];
            };
            
            // Criar container do pipeline
            const pipelineGrid = document.createElement('div');
            pipelineGrid.className = 'pipeline-container';
            
            // Criar colunas para cada aÃ§Ã£o
            actions.forEach((action, index) => {
                const column = document.createElement('div');
                column.className = 'pipeline-column';
                
                const header = document.createElement('div');
                header.className = 'pipeline-header';
                header.innerHTML = `
                    Mensagem ${index + 1}
                    <div class="pipeline-count">${leadsByStage[index].length}</div>
                `;
                
                column.appendChild(header);
                
                // Adicionar leads da etapa
                leadsByStage[index].forEach(lead => {
                    const leadCard = document.createElement('div');
                    leadCard.className = 'pipeline-lead';
                    
                    const initials = getInitials(lead.nome);
                    const avatarColor = getAvatarColor(lead.nome);
                    const nextActionDate = lead.nextActionDate ? formatDate(lead.nextActionDate) : 'Sem data';
                    
                    leadCard.innerHTML = `
                        <div class="pipeline-lead-header">
                            <div class="pipeline-avatar" style="background: ${avatarColor}">
                                ${initials}
                            </div>
                            <div class="pipeline-lead-info">
                                <h4>${escapeHtml(lead.nome)}</h4>
                                <p>${escapeHtml(lead.empresa)}</p>
                            </div>
                        </div>
                        <div class="pipeline-lead-date">PrÃ³x: ${nextActionDate}</div>
                    `;
                    
                    // Adicionar click para executar aÃ§Ã£o
                    leadCard.addEventListener('click', () => {
                        if (confirm(`Executar "${action.name}" para ${lead.nome} (${lead.empresa})?`)) {
                            window.app.executeAction(lead.id);
                            // Fechar modal e atualizar
                            document.getElementById('report-modal-backdrop').style.display = 'none';
                            document.getElementById('report-modal').style.display = 'none';
                            renderTable();
                        }
                    });
                    
                    column.appendChild(leadCard);
                });
                
                // Se nÃ£o hÃ¡ leads nesta etapa, mostrar mensagem
                if (leadsByStage[index].length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'text-center text-gray-400 text-sm mt-4';
                    emptyMessage.textContent = 'Nenhum lead nesta etapa';
                    column.appendChild(emptyMessage);
                }
                
                pipelineGrid.appendChild(column);
            });
            
            pipelineContainer.appendChild(pipelineGrid);
            
            // Log para debug
            console.log('ðŸ“Š Pipeline gerado:', leadsByStage);
        }

        function generateAgenda() {
            const agendaContainer = document.getElementById('agenda-calendar');
            agendaContainer.innerHTML = '';

            // FunÃ§Ã£o para formatar dia da semana curto
            const formatDayShort = (date) => {
                const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
                return days[date.getUTCDay()];
            };

            // FunÃ§Ã£o para formatar data curta
            const formatDateShort = (date) => {
                const day = date.getUTCDate().toString().padStart(2, '0');
                const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                return `${day}/${month}`;
            };

            const today = getToday();
            const workingDays = [];
            
            // Gerar prÃ³ximos 10 dias Ãºteis (2 semanas) + incluir datas de leads existentes
            let currentDate = new Date(today);
            let addedDays = 0;
            
            while (addedDays < 10) {
                if (isWorkingDay(currentDate)) {
                    workingDays.push(new Date(currentDate));
                    addedDays++;
                }
                currentDate = addDays(currentDate, 1);
            }
            
            console.log(`[DEBUG AGENDA] Gerados ${workingDays.length} dias Ãºteis padrÃ£o de ${today.toISOString().split('T')[0]}`);
            workingDays.forEach((d, i) => console.log(`[DEBUG AGENDA] Dia Ãºtil ${i+1}: ${d.toISOString().split('T')[0]}`));

            // INCLUSÃƒO SIMPLES: Todas as datas dos leads ativos
            console.log(`[DEBUG AGENDA] ðŸ“… INCLUINDO TODAS AS DATAS DOS LEADS:`);
            const activeLeadsOnly = leads.filter(l => l.isActive !== false && l.nextActionDate);
            
            activeLeadsOnly.forEach(lead => {
                const leadDate = parseDate(lead.nextActionDate);
                if (leadDate) {
                    const leadDateStr = leadDate.toISOString().split('T')[0];
                    const alreadyIncluded = workingDays.some(d => d.toISOString().split('T')[0] === leadDateStr);
                    if (!alreadyIncluded) {
                        workingDays.push(new Date(leadDate));
                        console.log(`[DEBUG AGENDA] âœ… Incluindo data do lead: ${lead.nome} â†’ ${leadDateStr}`);
                    }
                }
            });

            // Ordenar todas as datas
            workingDays.sort((a, b) => a.getTime() - b.getTime());

            // Agrupar leads por data
            const leadsByDate = {};
            
            console.log(`[DEBUG AGENDA] Gerando agenda para ${workingDays.length} dias Ãºteis:`);
            workingDays.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                leadsByDate[dateStr] = [];
                console.log(`[DEBUG AGENDA] Dia Ãºtil: ${dateStr} (${formatDateShort(date)})`);
            });

            // Organizar leads nas datas correspondentes (somente ativos)
            const activeLeadsForProcessing = leads.filter(l => l.isActive !== false);
            console.log(`[DEBUG AGENDA] Processando ${activeLeadsForProcessing.length} leads ativos de ${leads.length} totais`);
            
            // DIAGNÃ“STICO CRÃTICO: Verificar distribuiÃ§Ã£o real das datas
            console.log(`[DEBUG AGENDA] ðŸ” DIAGNÃ“STICO DE DISTRIBUIÃ‡ÃƒO DE DATAS:`);
            const dateDistribution = {};
            activeLeadsForProcessing.forEach(lead => {
                if (lead.nextActionDate) {
                    const rawDate = lead.nextActionDate;
                    const parsedDate = parseDate(rawDate);
                    const finalDateStr = parsedDate ? parsedDate.toISOString().split('T')[0] : 'INVALID';
                    
                    if (!dateDistribution[finalDateStr]) {
                        dateDistribution[finalDateStr] = [];
                    }
                    dateDistribution[finalDateStr].push(lead.nome);
                }
            });
            
            console.log(`[DEBUG AGENDA] ðŸ“Š DistribuiÃ§Ã£o por data:`, dateDistribution);
            Object.keys(dateDistribution).forEach(date => {
                console.log(`[DEBUG AGENDA] ${date}: ${dateDistribution[date].length} leads`);
                // Mostrar alguns exemplos de leads nesta data
                const examples = dateDistribution[date].slice(0, 3);
                console.log(`[DEBUG AGENDA] - Exemplos: ${examples.join(', ')}`);
            });
            
            // VERIFICAÃ‡ÃƒO ESPECÃFICA: Mostrar TODOS os formatos de data encontrados
            console.log(`[DEBUG AGENDA] ðŸ” VERIFICAÃ‡ÃƒO ESPECÃFICA DE DATAS:`);
            const dateFormats = new Set();
            const day02Leads = [];
            const day03Leads = [];
            
            activeLeadsForProcessing.forEach(lead => {
                if (lead.nextActionDate) {
                    const originalDate = lead.nextActionDate;
                    const parsedDate = parseDate(originalDate);
                    const finalDateStr = parsedDate ? parsedDate.toISOString().split('T')[0] : 'INVALID';
                    
                    // Coletar todos os formatos de data encontrados
                    dateFormats.add(originalDate);
                    
                    // Identificar leads do dia 02 e 03
                    if (originalDate.includes('02/09') || originalDate.includes('2025-09-02') || finalDateStr === '2025-09-02') {
                        day02Leads.push({
                            nome: lead.nome,
                            original: originalDate,
                            parsed: parsedDate?.toISOString(),
                            final: finalDateStr
                        });
                    }
                    
                    if (originalDate.includes('03/09') || originalDate.includes('2025-09-03') || finalDateStr === '2025-09-03') {
                        day03Leads.push({
                            nome: lead.nome,
                            original: originalDate,
                            final: finalDateStr
                        });
                    }
                }
            });
            
            console.log(`[DEBUG AGENDA] ðŸ“Š FORMATOS DE DATA ENCONTRADOS:`, Array.from(dateFormats).slice(0, 10));
            console.log(`[DEBUG AGENDA] ðŸ“… LEADS DIA 02 (${day02Leads.length}):`, day02Leads.slice(0, 5));
            console.log(`[DEBUG AGENDA] ðŸ“… LEADS DIA 03 (${day03Leads.length}):`, day03Leads.slice(0, 3));

            activeLeadsForProcessing.forEach(lead => {
                console.log(`[DEBUG AGENDA] Processando lead: ${lead.nome}, nextActionDate: ${lead.nextActionDate}`);
                if (lead.nextActionDate) {
                    // CORREÃ‡ÃƒO CRÃTICA: Usar parseDate() para garantir consistÃªncia
                    const leadDate = parseDate(lead.nextActionDate);
                    if (!leadDate) {
                        console.log(`[DEBUG AGENDA] âŒ Data invÃ¡lida para ${lead.nome}: ${lead.nextActionDate}`);
                        return;
                    }
                    
                    const leadDateStr = leadDate.toISOString().split('T')[0];
                    
                    console.log(`[DEBUG AGENDA] ðŸ”„ SINCRONIZAÃ‡ÃƒO ${lead.nome}:`)
                    console.log(`[DEBUG AGENDA] - nextActionDate original = ${lead.nextActionDate}`);
                    console.log(`[DEBUG AGENDA] - data parseada = ${leadDate.toISOString()}`);
                    console.log(`[DEBUG AGENDA] - data final = ${leadDateStr}`);
                    console.log(`[DEBUG AGENDA] - Datas disponÃ­veis na agenda:`, Object.keys(leadsByDate));
                    
                    // DEBUG ESPECIAL para Cristina Azevedo
                    if (lead.nome && lead.nome.toLowerCase().includes('cristina')) {
                        console.log(`[DEBUG AGENDA] ðŸš¨ CRISTINA AZEVEDO DEBUG:`);
                        console.log(`[DEBUG AGENDA] - Nome: ${lead.nome}`);
                        console.log(`[DEBUG AGENDA] - nextActionDate RAW: ${lead.nextActionDate}`);
                        console.log(`[DEBUG AGENDA] - parseDate resultado:`, leadDate);
                        console.log(`[DEBUG AGENDA] - leadDateStr final: ${leadDateStr}`);
                        console.log(`[DEBUG AGENDA] - leadsByDate[${leadDateStr}] existe?`, !!leadsByDate[leadDateStr]);
                    }
                    
                    if (leadsByDate[leadDateStr]) {
                        const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                        const currentAction = lead.currentActionIndex < configuredActions.length ? configuredActions[lead.currentActionIndex] : null;
                        
                        console.log(`[DEBUG AGENDA] âœ… Adicionando ${lead.nome} Ã  data ${leadDateStr}:`);
                        console.log(`[DEBUG AGENDA] - currentActionIndex: ${lead.currentActionIndex}`);
                        console.log(`[DEBUG AGENDA] - configuredActions.length: ${configuredActions.length}`);
                        console.log(`[DEBUG AGENDA] - currentAction:`, currentAction);
                        
                        leadsByDate[leadDateStr].push({
                            ...lead,
                            currentAction: currentAction
                        });
                        console.log(`[DEBUG AGENDA] Lead ${lead.nome} adicionado Ã  data ${leadDateStr}. Total na data: ${leadsByDate[leadDateStr].length}`);
                    } else {
                        console.log(`[DEBUG AGENDA] âŒ Data ${leadDateStr} nÃ£o estÃ¡ na janela de dias Ãºteis`);
                        console.log(`[DEBUG AGENDA] - Datas disponÃ­veis:`, Object.keys(leadsByDate));
                    }
                }
            });

            // Criar layout de calendÃ¡rio
            // Primeira semana
            const week1Label = document.createElement('div');
            week1Label.className = 'calendar-week-label';
            week1Label.textContent = 'Semana 1';
            agendaContainer.appendChild(week1Label);

            const week1Grid = document.createElement('div');
            week1Grid.className = 'calendar-grid';
            
            // Primeira semana (primeiros 5 dias ou menos)
            const week1Days = Math.min(5, workingDays.length);
            for (let i = 0; i < week1Days; i++) {
                if (workingDays[i]) {
                    const date = workingDays[i];
                    const dateStr = date.toISOString().split('T')[0];
                    const dayLeads = leadsByDate[dateStr] || [];
                    const isToday = date.getTime() === today.getTime();
                    const hasContacts = dayLeads.length > 0;
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = `calendar-day ${isToday ? 'today' : ''} ${hasContacts ? 'has-contacts' : ''}`;
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = `calendar-day-header ${isToday ? 'today' : ''}`;
                    headerDiv.innerHTML = `
                        <div>${formatDayShort(date)}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${formatDateShort(date)}</div>
                    `;
                    
                    const bodyDiv = document.createElement('div');
                    bodyDiv.className = 'calendar-day-body';
                    
                    console.log(`[DEBUG AGENDA] ðŸ“… Renderizando dia ${dateStr}: ${dayLeads.length} leads`);
                    if (dayLeads.length > 0) {
                        console.log(`[DEBUG AGENDA] - Leads do dia:`, dayLeads.map(l => `${l.nome} (${l.empresa})`));
                    }
                    
                    if (dayLeads.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'calendar-empty';
                        emptyDiv.textContent = 'ðŸ“… Livre';
                        bodyDiv.appendChild(emptyDiv);
                    } else {
                        // Ordenar por empresa
                        dayLeads.sort((a, b) => a.empresa.localeCompare(b.empresa));
                        
                        dayLeads.forEach(lead => {
                            const contactDiv = document.createElement('div');
                            const isOverdue = parseDate(lead.nextActionDate) < today;
                            contactDiv.className = `calendar-contact ${isOverdue ? 'overdue' : ''}`;
                            
                            contactDiv.innerHTML = `
                                <div class="calendar-contact-company">${escapeHtml(lead.empresa)}</div>
                                <div class="calendar-contact-name">${escapeHtml(lead.nome)}</div>
                                <div class="calendar-contact-action">${lead.currentAction ? lead.currentAction.name : 'Sem aÃ§Ã£o'}</div>
                            `;
                            
                            // Adicionar clique para executar aÃ§Ã£o
                            contactDiv.addEventListener('click', () => {
                                if (lead.currentAction) {
                                    if (confirm(`Executar "${lead.currentAction.name}" para ${lead.nome} (${lead.empresa})?`)) {
                                        window.app.executeAction(lead.id);
                                        // Fechar modal de relatÃ³rio e atualizar lista
                                        document.getElementById('report-modal-backdrop').style.display = 'none';
                                        document.getElementById('report-modal').style.display = 'none';
                                    }
                                }
                            });
                            
                            bodyDiv.appendChild(contactDiv);
                        });
                    }
                    
                    dayDiv.appendChild(headerDiv);
                    dayDiv.appendChild(bodyDiv);
                    week1Grid.appendChild(dayDiv);
                }
            }
            
            agendaContainer.appendChild(week1Grid);

            // Segunda semana
            const week2Label = document.createElement('div');
            week2Label.className = 'calendar-week-label';
            week2Label.textContent = 'Semana 2';
            agendaContainer.appendChild(week2Label);

            const week2Grid = document.createElement('div');
            week2Grid.className = 'calendar-grid';
            
            // Segunda semana (prÃ³ximos dias disponÃ­veis)
            const remainingDays = workingDays.length - week1Days;
            if (remainingDays > 0) {
                const week2Days = Math.min(5, remainingDays);
                for (let i = week1Days; i < week1Days + week2Days; i++) {
                    if (workingDays[i]) {
                        const date = workingDays[i];
                    const dateStr = date.toISOString().split('T')[0];
                    const dayLeads = leadsByDate[dateStr] || [];
                    const isToday = date.getTime() === today.getTime();
                    const hasContacts = dayLeads.length > 0;
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = `calendar-day ${isToday ? 'today' : ''} ${hasContacts ? 'has-contacts' : ''}`;
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = `calendar-day-header ${isToday ? 'today' : ''}`;
                    headerDiv.innerHTML = `
                        <div>${formatDayShort(date)}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${formatDateShort(date)}</div>
                    `;
                    
                    const bodyDiv = document.createElement('div');
                    bodyDiv.className = 'calendar-day-body';
                    
                    console.log(`[DEBUG AGENDA] ðŸ“… Renderizando dia ${dateStr}: ${dayLeads.length} leads`);
                    if (dayLeads.length > 0) {
                        console.log(`[DEBUG AGENDA] - Leads do dia:`, dayLeads.map(l => `${l.nome} (${l.empresa})`));
                    }
                    
                    if (dayLeads.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'calendar-empty';
                        emptyDiv.textContent = 'ðŸ“… Livre';
                        bodyDiv.appendChild(emptyDiv);
                    } else {
                        // Ordenar por empresa
                        dayLeads.sort((a, b) => a.empresa.localeCompare(b.empresa));
                        
                        dayLeads.forEach(lead => {
                            const contactDiv = document.createElement('div');
                            const isOverdue = parseDate(lead.nextActionDate) < today;
                            contactDiv.className = `calendar-contact ${isOverdue ? 'overdue' : ''}`;
                            
                            contactDiv.innerHTML = `
                                <div class="calendar-contact-company">${escapeHtml(lead.empresa)}</div>
                                <div class="calendar-contact-name">${escapeHtml(lead.nome)}</div>
                                <div class="calendar-contact-action">${lead.currentAction ? lead.currentAction.name : 'Sem aÃ§Ã£o'}</div>
                            `;
                            
                            // Adicionar clique para executar aÃ§Ã£o
                            contactDiv.addEventListener('click', () => {
                                if (lead.currentAction) {
                                    if (confirm(`Executar "${lead.currentAction.name}" para ${lead.nome} (${lead.empresa})?`)) {
                                        window.app.executeAction(lead.id);
                                        // Fechar modal de relatÃ³rio e atualizar lista
                                        document.getElementById('report-modal-backdrop').style.display = 'none';
                                        document.getElementById('report-modal').style.display = 'none';
                                    }
                                }
                            });
                            
                            bodyDiv.appendChild(contactDiv);
                        });
                    }
                    
                    dayDiv.appendChild(headerDiv);
                    dayDiv.appendChild(bodyDiv);
                    week2Grid.appendChild(dayDiv);
                    }
                }
                
                agendaContainer.appendChild(week2Grid);
            }
        }

        function generateKanban() {
            const kanbanBoard = document.getElementById('kanban-board');
            kanbanBoard.innerHTML = '';
            (cadenceConfig.statusOptions || []).forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column bg-white p-3 rounded-lg shadow';
                
                const leadsInStatus = leads.filter(l => l.status === status);
                
                let leadsHTML = '';
                leadsInStatus.forEach(l => {
                    leadsHTML += `<div class="bg-gray-50 p-2 mt-2 rounded border">
                        <p class="font-semibold text-sm">${escapeHtml(l.empresa)}</p>
                        <p class="text-xs text-gray-600">${escapeHtml(l.nome)}</p>
                    </div>`;
                });

                column.innerHTML = `
                    <h4 class="font-bold text-md mb-2">${escapeHtml(status)} (${leadsInStatus.length})</h4>
                    <div>${leadsHTML}</div>
                `;
                kanbanBoard.appendChild(column);
            });
        };

        const closeReportModal = () => {
            reportModal.style.display = 'none';
            reportModalBackdrop.style.display = 'none';
        };

        openReportBtn.addEventListener('click', () => {
            generateReport();
            reportModal.style.display = 'block';
            reportModalBackdrop.style.display = 'block';
        });

        closeReportBtn.addEventListener('click', closeReportModal);
        reportModalBackdrop.addEventListener('click', closeReportModal);

        // Event listener para atualizar agenda manualmente
        const refreshAgendaBtn = document.getElementById('refresh-agenda-btn');
        refreshAgendaBtn.addEventListener('click', () => {
            console.log('[DEBUG] BotÃ£o de atualizaÃ§Ã£o da agenda clicado');
            showNotification('ðŸ”„ Atualizando agenda...');
            generateAgenda();
            showNotification('âœ… Agenda atualizada!');
        });

        // Event listener para normalizar datas
        const normalizeDatesBtn = document.getElementById('normalize-dates-btn');
        normalizeDatesBtn.addEventListener('click', () => {
            if (confirm('ðŸ”§ NORMALIZAR DATAS\n\nIsso irÃ¡ corrigir formatos de data inconsistentes que podem estar impedindo leads de aparecer no calendÃ¡rio.\n\nâ€¢ MantÃ©m as datas originais (dia 02, 03, etc.)\nâ€¢ Apenas corrige o formato tÃ©cnico\nâ€¢ Resolve problemas de sincronizaÃ§Ã£o\n\nDeseja continuar?')) {
                normalizeDates();
            }
        });

        // Event listener para distribuir leads automaticamente
        const distributeLeadsBtn = document.getElementById('distribute-leads-btn');
        distributeLeadsBtn.addEventListener('click', () => {
            if (confirm('ðŸš¨ ATENÃ‡ÃƒO: Isso irÃ¡ redistribuir TODOS os leads ativos pelos prÃ³ximos 10 dias Ãºteis.\n\nTodas as datas atuais serÃ£o substituÃ­das.\n\nDeseja continuar?')) {
                distributeLeadsAcrossWorkingDays();
            }
        });
        
        // Event listener para abrir guia rÃ¡pido
        const guideBtn = document.getElementById('guide-btn');
        if (guideBtn) {
            guideBtn.addEventListener('click', () => {
                window.open('GUIA_RAPIDO_ANALISTA.html', '_blank');
            });
        }

        // Event listener para abrir documentaÃ§Ã£o tÃ©cnica
        const techDocsBtn = document.getElementById('tech-docs-btn');
        if (techDocsBtn) {
            techDocsBtn.addEventListener('click', () => {
                window.open('DOCUMENTACAO_TECNICA_SISTEMA.md', '_blank');
            });
        }

        // FUNÃ‡ÃƒO PARA DEBUG RÃPIDO DAS DATAS
        window.debugDates = () => {
            console.log('ðŸ” DEBUG RÃPIDO DAS DATAS DOS LEADS:');
            console.log('Total de leads:', leads.length);
            
            const dateCount = {};
            const samplesByDate = {};
            
            leads.forEach(lead => {
                if (lead.nextActionDate) {
                    const rawDate = lead.nextActionDate;
                    if (!dateCount[rawDate]) {
                        dateCount[rawDate] = 0;
                        samplesByDate[rawDate] = [];
                    }
                    dateCount[rawDate]++;
                    if (samplesByDate[rawDate].length < 3) {
                        samplesByDate[rawDate].push(lead.nome);
                    }
                }
            });
            
            console.log('ðŸ“Š Datas encontradas no BD:');
            Object.keys(dateCount).forEach(date => {
                console.log(`${date}: ${dateCount[date]} leads`);
                console.log(`  Exemplos: ${samplesByDate[date].join(', ')}`);
            });
            
            return { dateCount, samplesByDate };
        };

        // Event listener para debug da agenda
        const debugAgendaBtn = document.getElementById('debug-agenda-btn');
        debugAgendaBtn.addEventListener('click', () => {
            console.log('\n=== ðŸ› DEBUG AGENDA DETALHADO ===');
            
            // Debug de datas do sistema
            const systemDate = new Date();
            const saoPauloTime = new Date(systemDate.toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            const todayFunction = getToday();
            console.log('ðŸ• Data do sistema (JavaScript):', systemDate);
            console.log('ðŸ• Data do sistema (ISO):', systemDate.toISOString());
            console.log('ðŸ• Data SÃ£o Paulo:', saoPauloTime.toLocaleString('pt-BR'));
            console.log('ðŸ• getToday() funÃ§Ã£o:', todayFunction);
            console.log('ðŸ• getToday() ISO:', todayFunction.toISOString());
            console.log('ðŸ• Timezone offset:', systemDate.getTimezoneOffset());
            
            console.log('\nðŸ“Š Total de leads:', leads.length);
            console.log('ðŸ”¢ Leads ativos:', leads.filter(l => l.isActive !== false).length);
            console.log('ðŸ“… ConfiguraÃ§Ã£o de cadÃªncia:', cadenceConfig);
            
            console.log('\nðŸ“‹ TODOS OS LEADS:');
            leads.forEach((lead, index) => {
                console.log(`${index + 1}. ${lead.nome} (${lead.empresa})`);
                console.log(`   - nextActionDate: ${lead.nextActionDate}`);
                console.log(`   - currentActionIndex: ${lead.currentActionIndex}`);
                console.log(`   - isActive: ${lead.isActive}`);
                console.log(`   - status: ${lead.status}`);
                console.log('');
            });
            
            console.log('\nðŸŽ¯ LEADS COM PRÃ“XIMA AÃ‡ÃƒO:');
            const leadsWithAction = leads.filter(l => l.nextActionDate && l.isActive !== false);
            leadsWithAction.forEach(lead => {
                const leadDate = parseDate(lead.nextActionDate);
                const leadDateStr = leadDate ? leadDate.toISOString().split('T')[0] : 'INVÃLIDA';
                console.log(`- ${lead.nome}: ${lead.nextActionDate} â†’ Data processada: ${leadDateStr} (Action ${lead.currentActionIndex})`);
            });
            
            console.log('\nðŸ“… VERIFICAÃ‡ÃƒO ESPECÃFICA - AGENDA vs DADOS:');
            
            // Verificar Roberto Machado
            console.log('Verificando se Roberto Machado estÃ¡ sendo colocado no dia correto...');
            const roberto = leads.find(l => l.nome && l.nome.toLowerCase().includes('roberto'));
            if (roberto) {
                console.log('ðŸ” Roberto Machado encontrado:');
                console.log(`  - nextActionDate: ${roberto.nextActionDate}`);
                console.log(`  - Data parseada: ${parseDate(roberto.nextActionDate)?.toISOString()}`);
                console.log(`  - Data string: ${parseDate(roberto.nextActionDate)?.toISOString().split('T')[0]}`);
                console.log(`  - isActive: ${roberto.isActive}`);
                console.log(`  - currentActionIndex: ${roberto.currentActionIndex}`);
            } else {
                console.log('âŒ Roberto Machado nÃ£o encontrado nos leads');
            }
            
            // Verificar Cristina Azevedo
            console.log('\nVerificando se Cristina Azevedo estÃ¡ sendo colocada no dia correto...');
            const cristina = leads.find(l => l.nome && l.nome.toLowerCase().includes('cristina'));
            if (cristina) {
                console.log('ðŸ” Cristina Azevedo encontrada:');
                console.log(`  - nextActionDate: ${cristina.nextActionDate}`);
                console.log(`  - Data parseada: ${parseDate(cristina.nextActionDate)?.toISOString()}`);
                console.log(`  - Data string: ${parseDate(cristina.nextActionDate)?.toISOString().split('T')[0]}`);
                console.log(`  - isActive: ${cristina.isActive}`);
                console.log(`  - currentActionIndex: ${cristina.currentActionIndex}`);
            } else {
                console.log('âŒ Cristina Azevedo nÃ£o encontrada nos leads');
            }
            
            console.log('\nâš ï¸ PROBLEMAS POSSÃVEIS:');
            leads.forEach(lead => {
                if (lead.nextActionDate && lead.isActive !== false) {
                    const dateFormat = lead.nextActionDate.includes('T') ? 'ISO' : 'Simple';
                    console.log(`${lead.nome}: Data formato ${dateFormat} - ${lead.nextActionDate}`);
                    
                    if (lead.currentActionIndex >= (cadenceConfig.actions?.length || 0)) {
                        console.log(`âš ï¸ ${lead.nome}: ActionIndex ${lead.currentActionIndex} > Total aÃ§Ãµes ${cadenceConfig.actions?.length || 0}`);
                    }
                }
            });
            
            showNotification('ðŸ› Debug completo - veja o console do navegador!', 'info');
        });
        
        // FUNÃ‡ÃƒO PARA NORMALIZAR TODAS AS DATAS (CORRIGIR FORMATOS INCONSISTENTES)
        const normalizeDates = () => {
            console.log('ðŸ”§ Iniciando normalizaÃ§Ã£o de datas...');
            
            const activeLeads = leads.filter(l => l.isActive !== false && l.nextActionDate);
            if (activeLeads.length === 0) {
                showNotification('â„¹ï¸ Nenhum lead ativo encontrado para normalizar.', 'info');
                return;
            }
            
            let normalizedCount = 0;
            const dateFormats = {};
            const problematicLeads = [];
            
            activeLeads.forEach(lead => {
                const originalDate = lead.nextActionDate;
                let normalizedDate = null;
                
                // Debug especÃ­fico para Roberto Machado
                if (lead.nome && lead.nome.toLowerCase().includes('roberto')) {
                    console.log(`ðŸ” ROBERTO DEBUG:`, {
                        nome: lead.nome,
                        originalDate: originalDate,
                        tipo: typeof originalDate,
                        includes_T: originalDate.includes('T'),
                        length: originalDate.length
                    });
                }
                
                // Detectar formato mais robustamente
                let format = 'Unknown';
                if (originalDate.includes('T') && originalDate.includes('Z')) {
                    format = 'ISO_Full';
                } else if (originalDate.includes('T')) {
                    format = 'ISO_Partial';
                } else if (originalDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    format = 'Simple_YYYY-MM-DD';
                } else if (originalDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    format = 'Brazilian_DD/MM/YYYY';
                } else {
                    format = 'Other';
                    problematicLeads.push(`${lead.nome}: "${originalDate}"`);
                }
                
                if (!dateFormats[format]) dateFormats[format] = 0;
                dateFormats[format]++;
                
                // Normalizar baseado no formato detectado
                if (format === 'ISO_Full') {
                    // JÃ¡ estÃ¡ correto
                    normalizedDate = originalDate;
                } else if (format === 'Simple_YYYY-MM-DD') {
                    // Converter YYYY-MM-DD para ISO completo
                    normalizedDate = originalDate + 'T00:00:00.000Z';
                    console.log(`ðŸ”§ ${lead.nome}: ${originalDate} â†’ ${normalizedDate}`);
                    lead.nextActionDate = normalizedDate;
                    normalizedCount++;
                } else if (format === 'Brazilian_DD/MM/YYYY') {
                    // Converter DD/MM/YYYY para ISO
                    const [day, month, year] = originalDate.split('/');
                    normalizedDate = `${year}-${month}-${day}T00:00:00.000Z`;
                    console.log(`ðŸ”§ ${lead.nome}: ${originalDate} â†’ ${normalizedDate}`);
                    lead.nextActionDate = normalizedDate;
                    normalizedCount++;
                } else {
                    console.warn(`âš ï¸ Formato nÃ£o reconhecido para ${lead.nome}: "${originalDate}"`);
                }
            });
            
            console.log('ðŸ“Š Formatos encontrados:', dateFormats);
            if (problematicLeads.length > 0) {
                console.warn('âš ï¸ Leads com formatos problemÃ¡ticos:', problematicLeads);
            }
            console.log(`âœ… ${normalizedCount} leads normalizados`);
            
            if (normalizedCount > 0) {
                // Salvar e atualizar interface
                saveDataToBin().then(() => {
                    renderTable();
                    generateAgenda();
                    showNotification(`ðŸ”§ ${normalizedCount} datas normalizadas! CalendÃ¡rio atualizado.`, 'success');
                });
            } else {
                showNotification('âœ… Todas as datas jÃ¡ estÃ£o no formato correto!', 'success');
            }
        };

        // FUNÃ‡ÃƒO PARA DISTRIBUIR LEADS AUTOMATICAMENTE EM DIAS ÃšTEIS
        const distributeLeadsAcrossWorkingDays = () => {
            console.log('ðŸ“… Iniciando distribuiÃ§Ã£o automÃ¡tica de leads por dias Ãºteis...');
            
            const activeLeads = leads.filter(l => l.isActive !== false && l.nextActionDate);
            if (activeLeads.length === 0) {
                showNotification('â„¹ï¸ Nenhum lead ativo encontrado para distribuir.', 'info');
                return;
            }
            
            // Gerar prÃ³ximos 10 dias Ãºteis
            const workingDays = [];
            let currentDate = new Date();
            
            while (workingDays.length < 10) {
                if (isWorkingDay(currentDate)) {
                    workingDays.push(new Date(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Distribuir leads uniformemente
            const leadsPerDay = Math.ceil(activeLeads.length / workingDays.length);
            let leadIndex = 0;
            let updatedCount = 0;
            
            workingDays.forEach((date, dayIndex) => {
                const leadsForThisDay = activeLeads.slice(leadIndex, leadIndex + leadsPerDay);
                
                leadsForThisDay.forEach(lead => {
                    const newDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                    lead.nextActionDate = newDate.toISOString();
                    updatedCount++;
                });
                
                leadIndex += leadsPerDay;
                console.log(`ðŸ“… Dia ${date.toISOString().split('T')[0]}: ${leadsForThisDay.length} leads`);
            });
            
            console.log(`âœ… ${updatedCount} leads redistribuÃ­dos em ${workingDays.length} dias Ãºteis`);
            
            // Salvar e atualizar interface
            saveDataToBin().then(() => {
                renderTable();
                generateAgenda();
                showNotification(`ðŸ“… ${updatedCount} leads redistribuÃ­dos automaticamente em ${workingDays.length} dias Ãºteis!`, 'success');
            });
        };

        // --- LÃ“GICA DE EXPORTAÃ‡ÃƒO ---
        const exportToXLS = () => {
            if (leads.length === 0) {
                alert("NÃ£o hÃ¡ leads para exportar.");
                return;
            }

            const headers = ["Empresa", "Nome Contato", "Cargo", "LinkedIn", "Status", "PrÃ³xima AÃ§Ã£o", "Data PrÃ³xima AÃ§Ã£o", "ObservaÃ§Ãµes"];
            
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n";

            leads.forEach(lead => {
                const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                const currentAction = lead.currentActionIndex < configuredActions.length 
                    ? configuredActions[lead.currentActionIndex] 
                    : null;
                const nextActionName = currentAction ? currentAction.name : "Ciclo Finalizado";

                const row = [
                    lead.empresa,
                    lead.nome,
                    lead.cargo,
                    lead.linkedin,
                    lead.status,
                    nextActionName,
                    formatDate(lead.nextActionDate),
                    `"${(lead.notes || '').replace(/"/g, '""')}"` // Trata aspas nas notas
                ];
                csvContent += row.join(";") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const today = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `backup_prospeccao_${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        exportXlsBtn.addEventListener('click', exportToXLS);

        // --- LÃ“GICA DE FILTROS ---
        const populateStatusFilter = () => {
            statusFilter.innerHTML = `<option value="all">Todos os Status</option>`;
            (cadenceConfig.statusOptions || []).forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
        };
        
        // Implementar debouncing para busca para melhorar performance
        let searchTimeout;
        const debounceSearch = (callback, delay = 300) => {
            return function(...args) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => callback.apply(this, args), delay);
            };
        };
        
        const debouncedRenderTable = debounceSearch(renderTable, 300);
        
        searchInput.addEventListener('input', debouncedRenderTable);
        statusFilter.addEventListener('change', renderTable);
        
        // Event listener para toggle de visualizaÃ§Ã£o mobile
        if (toggleViewBtn) {
            toggleViewBtn.addEventListener('click', toggleMobileView);
        }


        // --- INICIALIZAÃ‡ÃƒO ---
        // --- SISTEMA DE VERSIONAMENTO ---
        const VERSION_HISTORY_KEY = 'crm_version_history';
        let currentVersion = '2.5.0';

        const versionHistory = [
            {
                version: '2.5.0',
                date: '2024-11-25 20:15',
                type: 'major',
                title: 'Dark Mode Profissional',
                description: 'Sistema completo de dark mode com toggle inteligente, paleta de cores profissional e persistÃªncia de preferÃªncias.',
                changes: [
                    'Toggle dark/light mode no header',
                    'DetecÃ§Ã£o automÃ¡tica da preferÃªncia do sistema',
                    'Paleta de cores escuras profissional',
                    'TransiÃ§Ãµes suaves entre temas',
                    'PersistÃªncia no localStorage',
                    'Todos os elementos adaptados para dark mode'
                ]
            },
            {
                version: '2.4.0',
                date: '2024-11-25 19:30',
                type: 'feature',
                title: 'Sistema de Versionamento',
                description: 'Implementado sistema automÃ¡tico de controle de versÃµes com histÃ³rico visual completo.',
                changes: [
                    'BotÃ£o de histÃ³rico no header',
                    'Modal moderno para visualizaÃ§Ã£o de versÃµes',
                    'Versionamento automÃ¡tico',
                    'Design integrado ao CRM'
                ]
            },
            {
                version: '2.3.0',
                date: '2024-11-25 19:00',
                type: 'improvement',
                title: 'CorreÃ§Ã£o de KPIs',
                description: 'Corrigidos KPIs para excluir mudanÃ§as automÃ¡ticas de status, garantindo mÃ©tricas mais precisas.',
                changes: [
                    'ExclusÃ£o da mudanÃ§a automÃ¡tica Listaâ†’Em Contato',
                    'KPIs mais confiÃ¡veis',
                    'MÃ©tricas de performance reais'
                ]
            },
            {
                version: '2.2.0',
                date: '2024-11-25 18:30',
                type: 'feature',
                title: 'ValidaÃ§Ã£o da Primeira Mensagem',
                description: 'Implementada validaÃ§Ã£o obrigatÃ³ria e automaÃ§Ã£o da primeira mensagem para garantir fluxo correto.',
                changes: [
                    'ValidaÃ§Ã£o de status obrigatÃ³rio',
                    'MudanÃ§a automÃ¡tica para "Em Contato"',
                    'Bloqueio de execuÃ§Ã£o incorreta',
                    'NotificaÃ§Ãµes de confirmaÃ§Ã£o'
                ]
            },
            {
                version: '2.1.0',
                date: '2024-11-25 17:45',
                type: 'feature',
                title: 'Performance por Mensagem',
                description: 'Nova anÃ¡lise revolucionÃ¡ria que mostra a taxa de conversÃ£o individual de cada mensagem da cadÃªncia.',
                changes: [
                    'Cards coloridos por performance',
                    'Insights automÃ¡ticos',
                    'Taxa de conversÃ£o real por aÃ§Ã£o',
                    'AnÃ¡lise estratÃ©gica avanÃ§ada'
                ]
            },
            {
                version: '2.0.0',
                date: '2024-11-25 16:00',
                type: 'major',
                title: 'KPIs de ProgressÃ£o no Funil',
                description: 'Sistema completo de mÃ©tricas mensais mostrando a progressÃ£o dos leads em cada etapa do funil.',
                changes: [
                    'MÃ©tricas mensais por etapa',
                    'Taxas de conversÃ£o detalhadas',
                    'Dashboard profissional',
                    'AnÃ¡lise de gargalos no funil'
                ]
            },
            {
                version: '1.9.0',
                date: '2024-11-25 14:30',
                type: 'improvement',
                title: 'Dropdown de Status Manual',
                description: 'Corrigido bug onde usuÃ¡rios nÃ£o conseguiam alterar status manualmente no layout de cards.',
                changes: [
                    'Dropdown de status nos cards',
                    'Funcionalidade manual restaurada',
                    'Interface mais flexÃ­vel'
                ]
            },
            {
                version: '1.8.0',
                date: '2024-11-25 13:00',
                type: 'feature',
                title: 'Agenda em CalendÃ¡rio Visual',
                description: 'TransformaÃ§Ã£o da agenda em layout de calendÃ¡rio com 2 semanas (5x2 quadrados) para melhor planejamento.',
                changes: [
                    'Layout de calendÃ¡rio 5x2',
                    'VisÃ£o de 2 semanas',
                    'Cards compactos por dia',
                    'Responsivo para mobile'
                ]
            },
            {
                version: '1.7.0',
                date: '2024-11-25 10:00',
                type: 'feature',
                title: 'RelatÃ³rio com Agenda',
                description: 'Adicionada seÃ§Ã£o de agenda no relatÃ³rio mostrando contatos dos prÃ³ximos 14 dias Ãºteis.',
                changes: [
                    'Agenda de 14 dias Ãºteis',
                    'OrganizaÃ§Ã£o por data',
                    'Planejamento semanal',
                    'IntegraÃ§Ã£o no relatÃ³rio'
                ]
            },
            {
                version: '1.6.0',
                date: '2024-11-24 16:00',
                type: 'improvement',
                title: 'Campo EditÃ¡vel de Delay',
                description: 'Liberado campo "Dias ApÃ³s AÃ§Ã£o Anterior" para permitir configuraÃ§Ã£o personalizada.',
                changes: [
                    'Campo delayDays editÃ¡vel',
                    'ValidaÃ§Ã£o min="0"',
                    'ConfiguraÃ§Ã£o flexÃ­vel de timing'
                ]
            },
            {
                version: '1.5.0',
                date: '2024-11-24 14:00',
                type: 'major',
                title: 'Design Visual Moderno',
                description: 'Redesign completo com interface moderna inspirada em CRMs lÃ­deres do mercado.',
                changes: [
                    'Header moderno com logo',
                    'Cards de contato elegantes',
                    'Avatars automÃ¡ticos',
                    'Logos de empresa dinÃ¢micos',
                    'Paleta de cores moderna'
                ]
            }
        ];

        function initVersioning() {
            // Atualizar versÃ£o atual no header
            document.getElementById('current-version').textContent = `v${currentVersion}`;
            
            // Verificar se hÃ¡ nova versÃ£o e atualizar histÃ³rico
            checkAndUpdateVersion();
            
            // Event listeners para o modal de versÃµes
            setupVersionModal();
        }

        function checkAndUpdateVersion() {
            const storedHistory = localStorage.getItem(VERSION_HISTORY_KEY);
            let localHistory = storedHistory ? JSON.parse(storedHistory) : [];
            
            // Se o histÃ³rico local nÃ£o tem a versÃ£o atual, adicionÃ¡-la
            const hasCurrentVersion = localHistory.some(v => v.version === currentVersion);
            if (!hasCurrentVersion) {
                const currentVersionData = versionHistory.find(v => v.version === currentVersion);
                if (currentVersionData) {
                    localHistory.unshift(currentVersionData);
                    localStorage.setItem(VERSION_HISTORY_KEY, JSON.stringify(localHistory));
                }
            }
        }

        function setupVersionModal() {
            const versionBtn = document.getElementById('version-history-btn');
            const versionModal = document.getElementById('version-modal');
            const versionBackdrop = document.getElementById('version-modal-backdrop');
            const closeVersionBtn = document.getElementById('close-version-btn');

            // Abrir modal
            versionBtn.addEventListener('click', () => {
                renderVersionHistory();
                versionModal.style.display = 'block';
                versionBackdrop.style.display = 'block';
                setTimeout(() => {
                    versionModal.style.opacity = '1';
                    versionModal.style.transform = 'translateY(0)';
                }, 10);
            });

            // Fechar modal
            const closeModal = () => {
                versionModal.style.opacity = '0';
                versionModal.style.transform = 'translateY(-50px)';
                setTimeout(() => {
                    versionModal.style.display = 'none';
                    versionBackdrop.style.display = 'none';
                }, 300);
            };

            closeVersionBtn.addEventListener('click', closeModal);
            versionBackdrop.addEventListener('click', closeModal);
        }

        function renderVersionHistory() {
            const versionList = document.getElementById('version-list');
            const storedHistory = localStorage.getItem(VERSION_HISTORY_KEY);
            const history = storedHistory ? JSON.parse(storedHistory) : versionHistory;

            versionList.innerHTML = history.map(version => {
                const typeColors = {
                    'major': 'bg-purple-50 border-purple-300 text-purple-800',
                    'feature': 'bg-blue-50 border-blue-300 text-blue-800',
                    'improvement': 'bg-green-50 border-green-300 text-green-800',
                    'bugfix': 'bg-red-50 border-red-300 text-red-800'
                };

                const typeIcons = {
                    'major': 'ðŸš€',
                    'feature': 'âœ¨',
                    'improvement': 'ðŸ”§',
                    'bugfix': 'ðŸ›'
                };

                const isLatest = version.version === currentVersion;

                return `
                    <div class="border-2 ${typeColors[version.type]} rounded-lg p-4 ${isLatest ? 'ring-2 ring-blue-400' : ''}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${typeIcons[version.type]}</span>
                                <div>
                                    <h3 class="font-bold text-lg flex items-center space-x-2">
                                        <span>v${version.version}</span>
                                        ${isLatest ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">ATUAL</span>' : ''}
                                    </h3>
                                    <p class="text-sm opacity-75">${version.date}</p>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full border border-current opacity-75 uppercase font-medium">
                                ${version.type}
                            </span>
                        </div>
                        
                        <h4 class="font-semibold mb-2">${version.title}</h4>
                        <p class="text-sm mb-3">${version.description}</p>
                        
                        <div class="space-y-1">
                            ${version.changes.map(change => 
                                `<div class="flex items-center space-x-2">
                                    <span class="w-2 h-2 bg-current rounded-full opacity-50"></span>
                                    <span class="text-sm">${change}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Auto-incrementar versÃ£o em debug (simulaÃ§Ã£o)
        function incrementVersion() {
            const [major, minor, patch] = currentVersion.split('.').map(Number);
            currentVersion = `${major}.${minor}.${patch + 1}`;
            
            // Simular nova versÃ£o para debug
            const newVersion = {
                version: currentVersion,
                date: new Date().toLocaleString('pt-BR'),
                type: 'improvement',
                title: 'Debug/AlteraÃ§Ã£o de Layout',
                description: 'AlteraÃ§Ã£o realizada durante desenvolvimento ou debug do sistema.',
                changes: [
                    'Ajustes de interface',
                    'CorreÃ§Ãµes de bugs',
                    'Melhorias de performance'
                ]
            };

            const storedHistory = localStorage.getItem(VERSION_HISTORY_KEY);
            let localHistory = storedHistory ? JSON.parse(storedHistory) : versionHistory.slice();
            localHistory.unshift(newVersion);
            
            localStorage.setItem(VERSION_HISTORY_KEY, JSON.stringify(localHistory));
            document.getElementById('current-version').textContent = `v${currentVersion}`;
        }

        // Expor funÃ§Ã£o para debug
        window.debugVersion = incrementVersion;

        // --- SISTEMA DE DARK MODE ---
        const DARK_MODE_KEY = 'crm_dark_mode';
        
        function initDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const themeText = document.getElementById('theme-text');
            
            // Verificar preferÃªncia salva ou preferÃªncia do sistema
            const savedTheme = localStorage.getItem(DARK_MODE_KEY);
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDarkMode = savedTheme === 'dark' || (!savedTheme && systemPrefersDark);
            
            // Aplicar tema inicial
            updateTheme(isDarkMode);
            
            // Event listener para o toggle
            darkModeToggle.addEventListener('click', () => {
                const currentlyDark = document.documentElement.classList.contains('dark');
                const newDarkMode = !currentlyDark;
                
                updateTheme(newDarkMode);
                localStorage.setItem(DARK_MODE_KEY, newDarkMode ? 'dark' : 'light');
                
                // Feedback visual
                showNotification(newDarkMode ? 'ðŸŒ™ Modo escuro ativado' : 'â˜€ï¸ Modo claro ativado');
            });
            
            function updateTheme(isDark) {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                    themeText.textContent = 'Claro';
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                    themeText.textContent = 'Escuro';
                }
            }
            
            // Escutar mudanÃ§as na preferÃªncia do sistema
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem(DARK_MODE_KEY)) {
                    updateTheme(e.matches);
                }
            });
        }

        // --- SISTEMA DE RELATÃ“RIO EXECUTIVO ---
        let selectedPeriod = { 
            type: '7days', 
            startDate: null, 
            endDate: null,
            label: 'Ãšltimos 7 dias'
        };

        function initExecutiveReport() {
            // Event listeners para botÃµes de perÃ­odo
            document.getElementById('period-7days').addEventListener('click', () => selectPeriod('7days', 'Ãšltimos 7 dias'));
            document.getElementById('period-14days').addEventListener('click', () => selectPeriod('14days', 'Ãšltimas 2 semanas'));
            document.getElementById('period-30days').addEventListener('click', () => selectPeriod('30days', 'Ãšltimo mÃªs'));
            document.getElementById('period-custom').addEventListener('click', () => selectPeriod('custom', 'PerÃ­odo customizado'));
            
            // Event listeners para datas customizadas
            document.getElementById('custom-start-date').addEventListener('change', updateCustomPeriod);
            document.getElementById('custom-end-date').addEventListener('change', updateCustomPeriod);
            
            // Event listeners para modal
            executiveReportBtn.addEventListener('click', openExecutiveModal);
            closeExecutiveBtn.addEventListener('click', closeExecutiveModal);
            executiveModalBackdrop.addEventListener('click', closeExecutiveModal);
            
            // Event listener para gerar relatÃ³rio
            document.getElementById('generate-executive-report').addEventListener('click', generateExecutiveReport);
            
            // Event listeners para exportaÃ§Ã£o
            document.getElementById('export-executive-excel').addEventListener('click', exportExecutiveToExcel);
            document.getElementById('email-executive-report').addEventListener('click', emailExecutiveReport);
        }

        function selectPeriod(type, label) {
            selectedPeriod.type = type;
            selectedPeriod.label = label;
            
            // Atualizar visual dos botÃµes
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500', 'action-info');
                btn.classList.add('action-secondary');
            });
            document.getElementById(`period-${type}`).classList.remove('action-secondary');
            document.getElementById(`period-${type}`).classList.add('action-info', 'ring-2', 'ring-blue-500');
            
            // Mostrar/esconder seletor customizado
            const customSelector = document.getElementById('custom-period-selector');
            if (type === 'custom') {
                customSelector.classList.remove('hidden');
                updateCustomPeriod();
            } else {
                customSelector.classList.add('hidden');
                updatePeriodDates();
            }
            
            document.getElementById('selected-period-text').textContent = label;
        }

        function updateCustomPeriod() {
            const startDate = document.getElementById('custom-start-date').value;
            const endDate = document.getElementById('custom-end-date').value;
            
            if (startDate && endDate) {
                selectedPeriod.startDate = new Date(startDate + 'T00:00:00.000Z');
                selectedPeriod.endDate = new Date(endDate + 'T23:59:59.999Z');
                
                const startFormatted = formatDate(selectedPeriod.startDate.toISOString());
                const endFormatted = formatDate(selectedPeriod.endDate.toISOString());
                selectedPeriod.label = `${startFormatted} a ${endFormatted}`;
                document.getElementById('selected-period-text').textContent = selectedPeriod.label;
            }
        }

        function updatePeriodDates() {
            const today = getToday();
            let daysAgo;
            
            switch (selectedPeriod.type) {
                case '7days':
                    daysAgo = 7;
                    break;
                case '14days':
                    daysAgo = 14;
                    break;
                case '30days':
                    daysAgo = 30;
                    break;
                default:
                    return;
            }
            
            selectedPeriod.endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1);
            selectedPeriod.startDate = new Date(today.getTime() - (daysAgo - 1) * 24 * 60 * 60 * 1000);
        }

        function openExecutiveModal() {
            updatePeriodDates();
            executiveModal.style.display = 'block';
            executiveModalBackdrop.style.display = 'block';
        }

        function closeExecutiveModal() {
            executiveModal.style.display = 'none';
            executiveModalBackdrop.style.display = 'none';
        }

        function generateExecutiveReport() {
            if (!selectedPeriod.startDate || !selectedPeriod.endDate) {
                updatePeriodDates();
            }
            
            showLoader("Gerando relatÃ³rio executivo...");
            
            setTimeout(() => {
                const reportData = analyzeActivities(selectedPeriod.startDate, selectedPeriod.endDate);
                renderExecutiveReport(reportData);
                hideLoader();
            }, 500);
        }

        function analyzeActivities(startDate, endDate) {
            const activities = {
                leadsAdicionados: [],
                mudancasStatus: [],
                mensagensEnviadas: [],
                summary: {
                    totalLeadsAdicionados: 0,
                    totalMudancasStatus: 0,
                    totalMensagensEnviadas: 0,
                    leadsMaisAtivos: [],
                    diasMaisAtivos: {}
                }
            };

            console.log(`ðŸ“Š Analisando atividades de ${formatDate(startDate.toISOString())} a ${formatDate(endDate.toISOString())}`);

            leads.forEach(lead => {
                let leadCreationDate = null;
                if (lead.createdAt) {
                    leadCreationDate = new Date(lead.createdAt);
                } else if (lead.history && lead.history.length > 0) {
                    const oldestHistory = lead.history.reduce((oldest, current) => {
                        return new Date(current.timestamp) < new Date(oldest.timestamp) ? current : oldest;
                    });
                    leadCreationDate = new Date(oldestHistory.timestamp);
                } else if (lead.nextActionDate) {
                    leadCreationDate = new Date(lead.nextActionDate);
                    leadCreationDate.setDate(leadCreationDate.getDate() - 1);
                }

                if (leadCreationDate && leadCreationDate >= startDate && leadCreationDate <= endDate) {
                    activities.leadsAdicionados.push({
                        empresa: lead.empresa,
                        nome: lead.nome,
                        cargo: lead.cargo,
                        data: leadCreationDate,
                        dataFormatada: formatDate(leadCreationDate.toISOString()),
                        status: lead.status
                    });
                    activities.summary.totalLeadsAdicionados++;
                }

                if (lead.history && lead.history.length > 0) {
                    lead.history.forEach(historyItem => {
                        const actionDate = new Date(historyItem.timestamp);
                        
                        if (actionDate >= startDate && actionDate <= endDate) {
                            const dayKey = actionDate.toISOString().split('T')[0];
                            activities.summary.diasMaisAtivos[dayKey] = (activities.summary.diasMaisAtivos[dayKey] || 0) + 1;

                            if (historyItem.newStatus) {
                                activities.mudancasStatus.push({
                                    empresa: lead.empresa,
                                    nome: lead.nome,
                                    cargo: lead.cargo,
                                    statusAnterior: historyItem.status,
                                    statusNovo: historyItem.newStatus,
                                    data: actionDate,
                                    dataFormatada: formatDate(actionDate.toISOString()),
                                    tipo: 'manual'
                                });
                                activities.summary.totalMudancasStatus++;
                            }

                            if (!historyItem.newStatus && typeof historyItem.currentActionIndex === 'number') {
                                const configuredActions = (cadenceConfig && Array.isArray(cadenceConfig.actions)) ? cadenceConfig.actions : [];
                                const action = configuredActions[historyItem.currentActionIndex];
                                
                                activities.mensagensEnviadas.push({
                                    empresa: lead.empresa,
                                    nome: lead.nome,
                                    cargo: lead.cargo,
                                    acao: action ? action.name : `AÃ§Ã£o ${historyItem.currentActionIndex + 1}`,
                                    data: actionDate,
                                    dataFormatada: formatDate(actionDate.toISOString()),
                                    statusAnterior: historyItem.status
                                });
                                activities.summary.totalMensagensEnviadas++;
                            }
                        }
                    });
                }
            });

            activities.leadsAdicionados.sort((a, b) => b.data - a.data);
            activities.mudancasStatus.sort((a, b) => b.data - a.data);
            activities.mensagensEnviadas.sort((a, b) => b.data - a.data);

            const leadActivity = {};
            [...activities.mudancasStatus, ...activities.mensagensEnviadas].forEach(activity => {
                const key = `${activity.empresa} - ${activity.nome}`;
                leadActivity[key] = (leadActivity[key] || 0) + 1;
            });

            activities.summary.leadsMaisAtivos = Object.entries(leadActivity)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([lead, count]) => ({ lead, count }));

            console.log(`ðŸ“ˆ Resumo: ${activities.summary.totalLeadsAdicionados} leads, ${activities.summary.totalMensagensEnviadas} mensagens, ${activities.summary.totalMudancasStatus} mudanÃ§as`);
            
            return activities;
        }

        function renderExecutiveReport(reportData) {
            const contentDiv = document.getElementById('executive-report-content');
            
            contentDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ðŸ“ˆ</span>
                        Resumo Executivo - ${selectedPeriod.label}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-800">${reportData.summary.totalLeadsAdicionados}</div>
                            <div class="text-sm text-blue-600 font-medium">Leads Adicionados</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-800">${reportData.summary.totalMensagensEnviadas}</div>
                            <div class="text-sm text-green-600 font-medium">Mensagens Enviadas</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-purple-800">${reportData.summary.totalMudancasStatus}</div>
                            <div class="text-sm text-purple-600 font-medium">MudanÃ§as de Status</div>
                        </div>
                    </div>
                </div>

                ${reportData.summary.leadsMaisAtivos.length > 0 ? `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">ðŸŽ¯</span>
                        Leads com Mais Atividade
                    </h3>
                    <div class="space-y-2">
                        ${reportData.summary.leadsMaisAtivos.map(item => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="font-medium">${escapeHtml(item.lead)}</span>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">${item.count} atividades</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">ðŸ‘¥</span>
                        Leads Adicionados (${reportData.leadsAdicionados.length})
                    </h3>
                    ${reportData.leadsAdicionados.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Contato</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Cargo</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Status Atual</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${reportData.leadsAdicionados.map(lead => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-sm">${lead.dataFormatada}</td>
                                            <td class="px-4 py-3 font-medium">${escapeHtml(lead.empresa)}</td>
                                            <td class="px-4 py-3">${escapeHtml(lead.nome)}</td>
                                            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(lead.cargo)}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">${escapeHtml(lead.status)}</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p class="text-gray-500 text-center py-8">Nenhum lead adicionado no perÃ­odo selecionado.</p>'}
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">ðŸ’¬</span>
                        Mensagens Enviadas (${reportData.mensagensEnviadas.length})
                    </h3>
                    ${reportData.mensagensEnviadas.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Contato</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Mensagem/AÃ§Ã£o</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Status Anterior</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${reportData.mensagensEnviadas.map(msg => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-sm">${msg.dataFormatada}</td>
                                            <td class="px-4 py-3 font-medium">${escapeHtml(msg.empresa)}</td>
                                            <td class="px-4 py-3">${escapeHtml(msg.nome)}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">${escapeHtml(msg.acao)}</span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(msg.statusAnterior)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p class="text-gray-500 text-center py-8">Nenhuma mensagem enviada no perÃ­odo selecionado.</p>'}
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">ðŸ”„</span>
                        MudanÃ§as de Status (${reportData.mudancasStatus.length})
                    </h3>
                    ${reportData.mudancasStatus.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Contato</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Status Anterior</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Status Novo</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${reportData.mudancasStatus.map(change => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-sm">${change.dataFormatada}</td>
                                            <td class="px-4 py-3 font-medium">${escapeHtml(change.empresa)}</td>
                                            <td class="px-4 py-3">${escapeHtml(change.nome)}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">${escapeHtml(change.statusAnterior)}</span>
                                            </td>
                                            <td class="px-4 py-3 text-sm">
                                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium">${escapeHtml(change.statusNovo)}</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p class="text-gray-500 text-center py-8">Nenhuma mudanÃ§a de status no perÃ­odo selecionado.</p>'}
                </div>
            `;

            showNotification(`ðŸ“Š RelatÃ³rio executivo gerado para ${selectedPeriod.label}`, "success");
        }

        function exportExecutiveToExcel() {
            if (!document.getElementById('executive-report-content').innerHTML.includes('Resumo Executivo -')) {
                showNotification("âš ï¸ Gere um relatÃ³rio primeiro antes de exportar.", "error");
                return;
            }

            const reportData = analyzeActivities(selectedPeriod.startDate, selectedPeriod.endDate);
            
            const headers = [
                "RELATÃ“RIO EXECUTIVO DE ATIVIDADES - SISTEMA CRM",
                `PerÃ­odo: ${selectedPeriod.label}`,
                `Gerado em: ${formatDate(new Date().toISOString())}`,
                "",
                "ðŸ“ˆ RESUMO EXECUTIVO",
                `Leads Adicionados: ${reportData.summary.totalLeadsAdicionados}`,
                `Mensagens Enviadas: ${reportData.summary.totalMensagensEnviadas}`,
                `MudanÃ§as de Status: ${reportData.summary.totalMudancasStatus}`,
                "",
                "ðŸ“‹ DETALHAMENTO POR ATIVIDADE"
            ];

            let csvContent = "data:text/csv;charset=utf-8," + headers.join("\n") + "\n\n";

            if (reportData.leadsAdicionados.length > 0) {
                csvContent += "ðŸ‘¥ LEADS ADICIONADOS\n";
                csvContent += "Data;Empresa;Contato;Cargo;Status Atual\n";
                reportData.leadsAdicionados.forEach(lead => {
                    csvContent += `${lead.dataFormatada};${lead.empresa};${lead.nome};${lead.cargo};${lead.status}\n`;
                });
                csvContent += "\n";
            }

            if (reportData.mensagensEnviadas.length > 0) {
                csvContent += "ðŸ’¬ MENSAGENS ENVIADAS\n";
                csvContent += "Data;Empresa;Contato;Mensagem/AÃ§Ã£o;Status Anterior\n";
                reportData.mensagensEnviadas.forEach(msg => {
                    csvContent += `${msg.dataFormatada};${msg.empresa};${msg.nome};${msg.acao};${msg.statusAnterior}\n`;
                });
                csvContent += "\n";
            }

            if (reportData.mudancasStatus.length > 0) {
                csvContent += "ðŸ”„ MUDANÃ‡AS DE STATUS\n";
                csvContent += "Data;Empresa;Contato;Status Anterior;Status Novo\n";
                reportData.mudancasStatus.forEach(change => {
                    csvContent += `${change.dataFormatada};${change.empresa};${change.nome};${change.statusAnterior};${change.statusNovo}\n`;
                });
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `relatorio_executivo_${selectedPeriod.type}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification("ðŸ“Š RelatÃ³rio executivo exportado com sucesso!", "success");
        }

        function emailExecutiveReport() {
            if (!document.getElementById('executive-report-content').innerHTML.includes('Resumo Executivo -')) {
                showNotification("âš ï¸ Gere um relatÃ³rio primeiro antes de enviar.", "error");
                return;
            }

            const reportData = analyzeActivities(selectedPeriod.startDate, selectedPeriod.endDate);
            
            const emailSubject = `ðŸ“Š RelatÃ³rio Executivo CRM - ${selectedPeriod.label}`;
            const emailBody = `
RelatÃ³rio Executivo de Atividades - Sistema CRM
PerÃ­odo: ${selectedPeriod.label}
Gerado em: ${formatDate(new Date().toISOString())}

ðŸ“ˆ RESUMO EXECUTIVO:
â€¢ Leads Adicionados: ${reportData.summary.totalLeadsAdicionados}
â€¢ Mensagens Enviadas: ${reportData.summary.totalMensagensEnviadas}  
â€¢ MudanÃ§as de Status: ${reportData.summary.totalMudancasStatus}

${reportData.summary.leadsMaisAtivos.length > 0 ? `
ðŸŽ¯ LEADS COM MAIS ATIVIDADE:
${reportData.summary.leadsMaisAtivos.map(item => `â€¢ ${item.lead}: ${item.count} atividades`).join('\n')}
` : ''}

ðŸ“‹ ATIVIDADES DETALHADAS:

ðŸ‘¥ LEADS ADICIONADOS (${reportData.leadsAdicionados.length}):
${reportData.leadsAdicionados.length > 0 ? 
    reportData.leadsAdicionados.slice(0, 10).map(lead => 
        `â€¢ ${lead.dataFormatada} - ${lead.empresa} (${lead.nome}) - ${lead.status}`
    ).join('\n') + (reportData.leadsAdicionados.length > 10 ? '\n... e mais ' + (reportData.leadsAdicionados.length - 10) + ' leads' : '')
    : 'â€¢ Nenhum lead adicionado no perÃ­odo'
}

ðŸ’¬ MENSAGENS ENVIADAS (${reportData.mensagensEnviadas.length}):
${reportData.mensagensEnviadas.length > 0 ? 
    reportData.mensagensEnviadas.slice(0, 10).map(msg => 
        `â€¢ ${msg.dataFormatada} - ${msg.empresa} (${msg.nome}) - ${msg.acao}`
    ).join('\n') + (reportData.mensagensEnviadas.length > 10 ? '\n... e mais ' + (reportData.mensagensEnviadas.length - 10) + ' mensagens' : '')
    : 'â€¢ Nenhuma mensagem enviada no perÃ­odo'
}

ðŸ”„ MUDANÃ‡AS DE STATUS (${reportData.mudancasStatus.length}):
${reportData.mudancasStatus.length > 0 ? 
    reportData.mudancasStatus.slice(0, 10).map(change => 
        `â€¢ ${change.dataFormatada} - ${change.empresa} (${change.nome}) - ${change.statusAnterior} â†’ ${change.statusNovo}`
    ).join('\n') + (reportData.mudancasStatus.length > 10 ? '\n... e mais ' + (reportData.mudancasStatus.length - 10) + ' mudanÃ§as' : '')
    : 'â€¢ Nenhuma mudanÃ§a de status no perÃ­odo'
}

---
Para visualizar o relatÃ³rio completo com detalhes, acesse o Sistema de ProspecÃ§Ã£o B2B.

Este relatÃ³rio foi gerado automaticamente pelo Sistema CRM - RecargaPay
            `.trim();

            const mailtoLink = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailtoLink;

            showNotification("ðŸ“§ Cliente de email aberto com o relatÃ³rio executivo!", "success");
        }

        // === SISTEMA DE IMPORTAÃ‡ÃƒO DE LEADS ===
        
        let importedLeadsData = [];
        
        // Inicializar importaÃ§Ã£o discreta
        function initDragDrop() {
            const importBtn = document.getElementById('import-leads-btn');
            const clearBtn = document.getElementById('clear-leads-btn');
            const fileInput = document.getElementById('file-input');
            
            // BotÃ£o de importaÃ§Ã£o no header
            if (importBtn) {
                importBtn.addEventListener('click', () => {
                    fileInput.click();
                });
            }
            
            // BotÃ£o de limpar leads
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (confirm(`Tem certeza que deseja limpar todos os ${leads.length} leads?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita!`)) {
                        clearAllLeads();
                    }
                });
            }
            
            // SeleÃ§Ã£o de arquivo
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileUpload(e.target.files[0]);
                    }
                });
            }
            
            console.log('âœ… Sistema de importaÃ§Ã£o discreta inicializado');
        }
        
        // Limpar todos os leads
        async function clearAllLeads() {
            console.log('ðŸ—‘ï¸ Limpando todos os leads...');
            showLoader("Limpando todos os leads...");
            
            try {
                leads = [];
                await saveDataToBin(false, "Salvando sistema limpo...");
                renderTable();
                showNotification("âœ… Todos os leads foram removidos com sucesso!", "success");
            } catch (error) {
                console.error('Erro ao limpar leads:', error);
                showNotification("âŒ Erro ao limpar leads. Tente novamente.", "error");
            } finally {
                hideLoader();
            }
        }
        
        // Processar arquivo carregado
        function handleFileUpload(file) {
            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls') && !fileName.endsWith('.csv')) {
                showNotification("âŒ Formato nÃ£o suportado. Use arquivos Excel (.xlsx, .xls) ou CSV (.csv)", "error");
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                showNotification("âŒ Arquivo muito grande. MÃ¡ximo: 10MB", "error");
                return;
            }
            
            showLoader("Processando arquivo...");
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    if (fileName.endsWith('.csv')) {
                        processCSVFile(e.target.result, file.name);
                    } else {
                        processExcelFile(e.target.result, file.name);
                    }
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showNotification("âŒ Erro ao processar arquivo. Verifique o formato e tente novamente.", "error");
                } finally {
                    hideLoader();
                }
            };
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }
        
        // Processar arquivo Excel
        function processExcelFile(data, filename) {
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            processImportData(jsonData, filename);
        }
        
        // Processar arquivo CSV
        function processCSVFile(data, filename) {
            const lines = data.split(/\r?\n/);
            const jsonData = lines.map(line => {
                if (!line) return [];
                // Detecta delimitador brasileiro ';' ou padrÃ£o ',' por linha
                const semicolons = (line.match(/;/g) || []).length;
                const commas = (line.match(/,/g) || []).length;
                const delimiter = semicolons > commas ? ';' : ',';
                return line.split(delimiter).map(cell => cell.trim().replace(/^"(.*)"$/, '$1'));
            }).filter(row => row.some(cell => cell.length > 0));
            
            processImportData(jsonData, filename);
        }
        
        // Processar dados importados
        function processImportData(data, filename) {
            console.log('ðŸ” Processando dados importados:', { filename, totalRows: data.length });
            
            if (data.length < 2) {
                showNotification("âŒ Arquivo deve conter pelo menos um cabeÃ§alho e uma linha de dados", "error");
                return;
            }
            
            // Detectar qual linha contÃ©m os verdadeiros cabeÃ§alhos
            let headerRowIndex = 0;
            let headers = [];
            
            // Procurar por cabeÃ§alhos vÃ¡lidos nas primeiras 3 linhas
            for (let i = 0; i < Math.min(3, data.length); i++) {
                const row = data[i];
                const rowAsString = row.map(cell => String(cell).toLowerCase().trim());
                
                // Verificar se essa linha contÃ©m palavras-chave de cabeÃ§alhos
                const hasHeaderKeywords = rowAsString.some(cell => 
                    cell.includes('empresa') || cell.includes('nome') || cell.includes('data') ||
                    cell.includes('linkedin') || cell.includes('cargo') || cell.includes('abordagem') ||
                    cell.includes('company') || cell.includes('name') || cell.includes('contact')
                );
                
                console.log(`ðŸ” Linha ${i + 1}:`, rowAsString);
                console.log(`ðŸ“‹ ContÃ©m palavras-chave de cabeÃ§alho:`, hasHeaderKeywords);
                
                if (hasHeaderKeywords) {
                    headerRowIndex = i;
                    headers = rowAsString;
                    console.log(`âœ… CabeÃ§alhos detectados na linha ${i + 1}:`);
                    console.log('ðŸ“‹ CabeÃ§alhos originais encontrados:', row);
                    console.log('ðŸ“‹ CabeÃ§alhos processados:', rowAsString);
                    break;
                }
            }
            
            // Se nÃ£o encontrou cabeÃ§alhos especÃ­ficos, usar a primeira linha nÃ£o vazia
            if (headers.length === 0) {
                for (let i = 0; i < Math.min(3, data.length); i++) {
                    const row = data[i].map(cell => String(cell).trim());
                    if (row.some(cell => cell.length > 0 && !cell.includes('unnamed'))) {
                        headerRowIndex = i;
                        headers = row.map(h => String(h).toLowerCase().trim());
                        console.log(`ðŸ”§ Usando linha ${i + 1} como cabeÃ§alhos (fallback)`);
                        break;
                    }
                }
            }
            
            if (headers.length === 0) {
                showNotification("âŒ NÃ£o foi possÃ­vel detectar cabeÃ§alhos vÃ¡lidos no arquivo", "error");
                return;
            }
            
            const rows = data.slice(headerRowIndex + 1);
            
            console.log('ðŸ“‹ CabeÃ§alhos encontrados:', headers);
            
            // Mapear colunas automaticamente
            const columnMapping = mapColumns(headers);
            console.log('ðŸ—ºï¸ Mapeamento de colunas:', columnMapping);
            
            importedLeadsData = [];
            const errors = [];
            let successCount = 0;
            
            rows.forEach((row, index) => {
                // Verificar se a linha nÃ£o estÃ¡ vazia
                const hasData = row.some(cell => cell && String(cell).trim() !== '');
                if (!hasData) {
                    console.log(`â­ï¸ Pulando linha vazia ${index + 2}`);
                    return;
                }
                
                console.log(`ðŸ” Processando linha ${index + 2}:`, row);
                
                try {
                    const lead = mapRowToLead(row, columnMapping, headers);
                    if (lead) {
                        importedLeadsData.push(lead);
                        successCount++;
                        console.log(`âœ… Lead criado com sucesso:`, lead.empresa, '-', lead.nome);
                    }
                } catch (error) {
                    console.log(`âŒ Erro na linha ${index + 2}:`, error.message);
                    errors.push(`Linha ${index + 2}: ${error.message}`);
                }
            });
            
            console.log('ðŸ“Š Resultado do processamento:', {
                totalLinhas: rows.length,
                leadsVÃ¡lidos: importedLeadsData.length,
                erros: errors.length
            });
            
            // Log detalhado dos primeiros 3 leads criados
            console.log('ðŸ” Primeiros 3 leads criados:');
            importedLeadsData.slice(0, 3).forEach((lead, index) => {
                console.log(`Lead ${index + 1}:`, {
                    id: lead.id,
                    empresa: lead.empresa,
                    nome: lead.nome,
                    status: lead.status,
                    cargo: lead.cargo
                });
            });
            
            if (importedLeadsData.length === 0) {
                console.log('âŒ Detalhes dos erros:', errors);
                const errorMessage = errors.length > 0 
                    ? `âŒ Nenhum lead vÃ¡lido encontrado. Erros: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`
                    : "âŒ Nenhum lead vÃ¡lido encontrado no arquivo";
                showNotification(errorMessage, "error");
                return;
            }
            
            if (importedLeadsData.length > 1000) {
                showNotification("âš ï¸ Muitos leads encontrados. Apenas os primeiros 1000 serÃ£o importados.", "warning");
                importedLeadsData = importedLeadsData.slice(0, 1000);
            }
            
            console.log('ðŸŽ¯ Pulando modal e importando diretamente...');
            console.log('ðŸ“‹ ParÃ¢metros:', { filename, successCount, errors: errors.length });
            
            // SOLUÃ‡ÃƒO DIRETA: Importar automaticamente sem modal
            showNotification(`âœ… ${importedLeadsData.length} leads processados com sucesso! Importando...`, "success");
            
            setTimeout(() => {
                importLeads();
            }, 1000);
        }
        
        // Mapear colunas automaticamente - ESTRUTURA CORRETA DO ARQUIVO
        function mapColumns(headers) {
            console.log('ðŸŽ¯ MAPEAMENTO PARA ESTRUTURA CORRETA DO ARQUIVO!');
            console.log('ðŸ“‹ CabeÃ§alhos encontrados:', headers);
            
            const mapping = {
                empresa: -1,
                dataCriacao: -1,
                abordagem: -1,
                linkedin: -1,
                nome: -1,
                cargo: -1,
                outrasInfo: []
            };

            // MAPEAMENTO DIRETO PELA ESTRUTURA CORRETA:
            // A = Nome, B = Empresa, C = Data, D = Abordagem, E = LinkedIn, F = Telefone, G = Cargo
            
            if (headers.length >= 1) {
                mapping.nome = 0; // Coluna A - Nome
                console.log(`âœ… Nome = coluna 0 (A): "${headers[0]}"`);
            }
            
            if (headers.length >= 2) {
                mapping.empresa = 1; // Coluna B - Empresa
                console.log(`âœ… Empresa = coluna 1 (B): "${headers[1]}"`);
            }
            
            if (headers.length >= 3) {
                mapping.dataCriacao = 2; // Coluna C - Data de adicionar
                console.log(`âœ… Data = coluna 2 (C): "${headers[2]}"`);
            }
            
            if (headers.length >= 4) {
                mapping.abordagem = 3; // Coluna D - Abordagem (nÃºmero da mensagem)
                console.log(`âœ… Abordagem = coluna 3 (D): "${headers[3]}"`);
            }
            
            if (headers.length >= 5) {
                mapping.linkedin = 4; // Coluna E - LinkedIn
                console.log(`âœ… LinkedIn = coluna 4 (E): "${headers[4]}"`);
            }
            
            if (headers.length >= 6) {
                // Coluna F - Telefone (vai para notas)
                mapping.outrasInfo.push(5);
                console.log(`ðŸ“ Telefone = coluna 5 (F): "${headers[5]}" - adicionado Ã s notas`);
            }
            
            if (headers.length >= 7) {
                mapping.cargo = 6; // Coluna G - Cargo
                console.log(`âœ… Cargo = coluna 6 (G): "${headers[6]}"`);
            }
            
            // Adicionar colunas restantes como outras informaÃ§Ãµes
            for (let i = 7; i < headers.length; i++) {
                mapping.outrasInfo.push(i);
                console.log(`ðŸ“ Outras info = coluna ${i}: "${headers[i]}"`);
            }
            
            console.log('ðŸŽ¯ MAPEAMENTO FINAL APLICADO:', mapping);
            return mapping;
        }
        
        // Converter nÃºmero serial de data do Excel para ISO (UTC)
        function excelSerialToISO(serial) {
            try {
                // Usar utilitÃ¡rio da prÃ³pria biblioteca se disponÃ­vel
                if (typeof XLSX !== 'undefined' && XLSX.SSF && typeof XLSX.SSF.parse_date_code === 'function') {
                    const d = XLSX.SSF.parse_date_code(serial);
                    if (d && typeof d.y === 'number') {
                        const date = new Date(Date.UTC(d.y, (d.m || 1) - 1, d.d || 1, d.H || 0, d.M || 0, Math.floor(d.S || 0)));
                        return date.toISOString();
                    }
                }
                // Fallback aproximado: Excel base 1899-12-30
                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                const ms = Math.round((Number(serial) || 0) * 24 * 60 * 60 * 1000);
                return new Date(excelEpoch.getTime() + ms).toISOString();
            } catch (e) {
                return new Date().toISOString();
            }
        }

        // Mapear linha para lead
        function mapRowToLead(row, mapping, headers) {
            const getRaw = (index) => index >= 0 && index < row.length ? row[index] : '';
            const getValue = (index) => {
                const v = getRaw(index);
                return (v === null || v === undefined) ? '' : String(v).trim();
            };
            
            const empresa = getValue(mapping.empresa);
            const nome = getValue(mapping.nome);
            const linkedin = getValue(mapping.linkedin);
            
            // DEBUG FORÃ‡ADO: Vamos ver exatamente o que estÃ¡ sendo mapeado
            console.log(`ðŸ” DEBUG mapRowToLead:`, {
                empresa: empresa,
                nome: nome,
                mapping: mapping,
                headers: headers,
                row: row
            });
            
            // ValidaÃ§Ã£o mais flexÃ­vel - permite nome vazio se tiver empresa
            if (!empresa && !nome) {
                throw new Error('Pelo menos Empresa ou Nome deve estar preenchido');
            }
            
            // Tratar valores undefined/null/vazios
            const empresaFinal = empresa && empresa !== 'undefined' ? empresa : 'NÃ£o informado';
            const nomeFinal = nome && nome !== 'undefined' ? nome : `Contato - ${empresaFinal}`;
            
            console.log(`ðŸ” Dados extraÃ­dos - Empresa: "${empresaFinal}", Nome: "${nomeFinal}"`)
            
            // Processar data de criaÃ§Ã£o
            let createdAt = new Date().toISOString();
            const rawDate = getRaw(mapping.dataCriacao);
            const dataStr = getValue(mapping.dataCriacao);
            if (rawDate !== '' && rawDate !== null && rawDate !== undefined) {
                try {
                    let parsedISO = null;
                    if (typeof rawDate === 'number') {
                        // ProvÃ¡vel serial do Excel
                        parsedISO = excelSerialToISO(rawDate);
                    } else if (/^\d+$/.test(dataStr)) {
                        // String numÃ©rica que pode ser serial
                        const serialNum = parseInt(dataStr, 10);
                        if (serialNum > 25000 && serialNum < 60000) {
                            parsedISO = excelSerialToISO(serialNum);
                        }
                    }
                    if (!parsedISO) {
                        // Tentar formatos DD/MM/AAAA, DD-MM-AAAA, AAAA-MM-DD
                        let parsedDate;
                        if (dataStr.includes('/')) {
                            const [day, month, year] = dataStr.split('/');
                            parsedDate = new Date(Number(year), Number(month) - 1, Number(day));
                        } else if (dataStr.includes('-')) {
                            const parts = dataStr.split('-');
                            if (parts[0].length === 4) {
                                parsedDate = new Date(dataStr);
                            } else {
                                const [day, month, year] = parts;
                                parsedDate = new Date(Number(year), Number(month) - 1, Number(day));
                            }
                        } else {
                            parsedDate = new Date(dataStr);
                        }
                        if (!isNaN(parsedDate.getTime())) {
                            parsedISO = parsedDate.toISOString();
                        }
                    }
                    if (parsedISO) createdAt = parsedISO;
                } catch (e) {
                    console.warn('Erro ao processar data:', dataStr, e);
                }
            }
            
            // Processar abordagem (nÃºmero da mensagem)
            let currentActionIndex = 0;
            const abordagemStr = getValue(mapping.abordagem);
            if (abordagemStr) {
                const abordagemNum = parseInt(abordagemStr);
                if (!isNaN(abordagemNum) && abordagemNum >= 1 && abordagemNum <= 5) {
                    currentActionIndex = abordagemNum - 1; // Converter para Ã­ndice baseado em 0
                }
            }
            
            // Coletar outras informaÃ§Ãµes para as notas
            const outrasInfo = [];
            mapping.outrasInfo.forEach(index => {
                const value = getValue(index);
                if (value) {
                    outrasInfo.push(`${headers[index]}: ${value}`);
                }
            });
            
            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                empresa: empresaFinal,
                nome: nomeFinal,
                cargo: getValue(mapping.cargo) || 'NÃ£o informado',
                linkedin: linkedin.startsWith('http') ? linkedin : (linkedin ? `https://linkedin.com/in/${linkedin}` : ''),
                status: (cadenceConfig.statusOptions && cadenceConfig.statusOptions.length > 0) ? cadenceConfig.statusOptions[0] : "Lista",
                currentActionIndex,
                nextActionDate: currentActionIndex < (cadenceConfig.actions?.length || 0) ? getToday().toISOString() : null,
                notes: outrasInfo.join('\n'),
                history: [],
                createdAt,
                isActive: true
            };
        }
        
        // Mostrar preview da importaÃ§Ã£o
        function showImportPreview(filename, successCount, errors) {
            console.log('ðŸŽ¬ showImportPreview executada!');
            console.log('ðŸ“Š Dados recebidos:', { filename, successCount, errorsCount: errors.length, totalLeads: importedLeadsData.length });
            
            const modal = document.getElementById('import-preview-modal');
            const content = document.getElementById('import-preview-content');
            const countElement = document.getElementById('import-count');
            
            console.log('ðŸ” Elementos DOM encontrados:', {
                modal: !!modal,
                content: !!content,
                countElement: !!countElement
            });
            
            if (!modal || !content || !countElement) {
                console.error('âŒ Elementos DOM do modal nÃ£o encontrados!');
                return;
            }
            
            countElement.textContent = importedLeadsData.length;
            console.log('âœ… Count element atualizado:', countElement.textContent);
            
            let html = `
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Arquivo: ${filename}</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 p-3 rounded">
                            <div class="text-2xl font-bold text-green-600">${successCount}</div>
                            <div class="text-sm text-green-600">Leads vÃ¡lidos</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded">
                            <div class="text-2xl font-bold text-red-600">${errors.length}</div>
                            <div class="text-sm text-red-600">Erros</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded">
                            <div class="text-2xl font-bold text-blue-600">${importedLeadsData.length}</div>
                            <div class="text-sm text-blue-600">Total a importar</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (errors.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded">
                        <h5 class="font-medium text-red-800 mb-2">âš ï¸ Erros encontrados (${errors.length}):</h5>
                        <div class="text-sm text-red-700 max-h-32 overflow-y-auto">
                            ${errors.slice(0, 10).map(error => `<div>â€¢ ${error}</div>`).join('')}
                            ${errors.length > 10 ? `<div class="mt-2 font-medium">... e mais ${errors.length - 10} erros</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="mb-4">
                    <h5 class="font-medium text-gray-900 mb-3">Preview dos leads (primeiros 5):</h5>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 border-b">Empresa</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 border-b">Nome</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 border-b">Cargo</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 border-b">Abordagem</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 border-b">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${importedLeadsData.slice(0, 5).map(lead => `
                                    <tr>
                                        <td class="px-3 py-2 text-sm">${escapeHtml(lead.empresa)}</td>
                                        <td class="px-3 py-2 text-sm">${escapeHtml(lead.nome)}</td>
                                        <td class="px-3 py-2 text-sm">${escapeHtml(lead.cargo)}</td>
                                        <td class="px-3 py-2 text-sm">${lead.currentActionIndex + 1}/5</td>
                                        <td class="px-3 py-2 text-sm">
                                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${escapeHtml(lead.status)}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${importedLeadsData.length > 5 ? `<p class="text-sm text-gray-500 mt-2">... e mais ${importedLeadsData.length - 5} leads</p>` : ''}
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            console.log('ðŸŽ¨ HTML do modal gerado, tamanho:', html.length);
            
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '999999';
            modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            modal.style.overflow = 'auto';
            modal.style.pointerEvents = 'auto';
            
            // Centralizar o modal interno
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.position = 'fixed';
                modalContent.style.top = '50%';
                modalContent.style.left = '50%';
                modalContent.style.transform = 'translate(-50%, -50%)';
                modalContent.style.zIndex = '1000000';
                modalContent.style.maxWidth = '90vw';
                modalContent.style.maxHeight = '90vh';
                modalContent.style.backgroundColor = 'white';
                modalContent.style.boxShadow = '0 25px 50px rgba(0,0,0,0.5)';
                modalContent.style.borderRadius = '12px';
                console.log('âœ… Modal interno centralizado e estilizado');
            }
            
            console.log('ðŸ‘ï¸ Modal exibido! Style display:', modal.style.display);
            console.log('ðŸŽ¨ Modal z-index:', modal.style.zIndex);
            
            // VerificaÃ§Ã£o final do DOM
            console.log('ðŸ” VerificaÃ§Ã£o final do modal:');
            console.log('Modal existe:', !!modal);
            console.log('Modal offsetWidth:', modal.offsetWidth);
            console.log('Modal offsetHeight:', modal.offsetHeight);
            console.log('Modal getBoundingClientRect:', modal.getBoundingClientRect());
            console.log('Modal computed style display:', window.getComputedStyle(modal).display);
            console.log('Modal computed style visibility:', window.getComputedStyle(modal).visibility);
            console.log('Modal computed style opacity:', window.getComputedStyle(modal).opacity);
            
            // ForÃ§ar todas as propriedades CSS
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.classList.remove('hidden');
            
            // Scroll para o modal se necessÃ¡rio
            modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Fallback: se ainda nÃ£o estiver visÃ­vel, usar confirm
            setTimeout(() => {
                const isVisible = modal.offsetWidth > 0 && modal.offsetHeight > 0;
                console.log('ðŸ” Modal Ã© visÃ­vel apÃ³s timeout:', isVisible);
                
                if (!isVisible) {
                    console.log('âš ï¸ Modal nÃ£o estÃ¡ visÃ­vel, criando modal alternativo...');
                    createAlternativeModal();
                }
            }, 1000);
            
            console.log('âœ… showImportPreview concluÃ­da com sucesso!');
        }
        
        // Criar modal alternativo quando o original nÃ£o funciona
        function createAlternativeModal() {
            console.log('ðŸ”§ Criando modal alternativo...');
            
            // Remover modal existente se houver
            const existingAlt = document.getElementById('alternative-modal');
            if (existingAlt) existingAlt.remove();
            
            // Criar novo modal do zero
            const altModal = document.createElement('div');
            altModal.id = 'alternative-modal';
            altModal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0,0,0,0.9) !important;
                z-index: 2147483647 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-family: Arial, sans-serif !important;
            `;
            
            altModal.innerHTML = `
                <div style="
                    background: white !important;
                    padding: 30px !important;
                    border-radius: 12px !important;
                    max-width: 600px !important;
                    max-height: 80vh !important;
                    overflow-y: auto !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.8) !important;
                    text-align: center !important;
                ">
                    <h2 style="color: #1f2937 !important; margin-bottom: 20px !important; font-size: 24px !important;">
                        ðŸŽ‰ ImportaÃ§Ã£o Pronta!
                    </h2>
                    <p style="color: #4b5563 !important; font-size: 16px !important; margin-bottom: 20px !important;">
                        <strong>${importedLeadsData.length} leads</strong> foram processados com sucesso e estÃ£o prontos para importaÃ§Ã£o.
                    </p>
                    <div style="background: #f3f4f6 !important; padding: 15px !important; border-radius: 8px !important; margin-bottom: 20px !important;">
                        <p style="color: #374151 !important; font-size: 14px !important; margin: 0 !important;">
                            âœ… Empresas mapeadas<br>
                            âœ… Nomes de contato criados<br>
                            âœ… Dados validados
                        </p>
                    </div>
                    <div style="display: flex !important; gap: 15px !important; justify-content: center !important;">
                        <button id="alt-import-btn" style="
                            background: #10b981 !important;
                            color: white !important;
                            padding: 12px 24px !important;
                            border: none !important;
                            border-radius: 6px !important;
                            font-size: 16px !important;
                            font-weight: 600 !important;
                            cursor: pointer !important;
                        ">
                            Importar ${importedLeadsData.length} Leads
                        </button>
                        <button id="alt-cancel-btn" style="
                            background: #6b7280 !important;
                            color: white !important;
                            padding: 12px 24px !important;
                            border: none !important;
                            border-radius: 6px !important;
                            font-size: 16px !important;
                            cursor: pointer !important;
                        ">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(altModal);
            
            // Event listeners
            document.getElementById('alt-import-btn').addEventListener('click', () => {
                console.log('âœ… UsuÃ¡rio confirmou importaÃ§Ã£o via modal alternativo');
                altModal.remove();
                importLeads();
            });
            
            document.getElementById('alt-cancel-btn').addEventListener('click', () => {
                console.log('âŒ UsuÃ¡rio cancelou importaÃ§Ã£o via modal alternativo');
                altModal.remove();
                importedLeadsData = [];
            });
            
            console.log('âœ… Modal alternativo criado e exibido');
        }
        
        // Limpar dados de importaÃ§Ã£o
        function closeImportPreview() {
            console.log('ðŸ§¹ Limpando dados de importaÃ§Ã£o...');
            
            // Limpar apenas dados - nÃ£o hÃ¡ modais para fechar
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.value = '';
            }
            
            console.log('âœ… Dados de importaÃ§Ã£o limpos');
        }
        
        // Importar leads para o sistema
        async function importLeads() {
            if (importedLeadsData.length === 0) {
                showNotification("âŒ Nenhum lead para importar", "error");
                return;
            }
            
            showLoader(`Importando ${importedLeadsData.length} leads...`);
            
            try {
                // Verificar duplicatas com leads existentes
                const duplicateCount = checkForDuplicates();
                
                console.log('âž• Adicionando leads ao sistema...');
                console.log('ðŸ“Š Leads antes da adiÃ§Ã£o:', leads.length);
                console.log('ðŸ“‹ Leads a serem adicionados:', importedLeadsData.length);
                
                // Adicionar leads ao sistema
                leads.push(...importedLeadsData);
                
                console.log('ðŸ“Š Leads apÃ³s adiÃ§Ã£o:', leads.length);
                console.log('âœ… Leads adicionados com sucesso Ã  variÃ¡vel global');
                
                // Fechar modal e mostrar leads imediatamente
                closeImportPreview();
                hideLoader();
                
                console.log('ðŸŽ¯ Finalizando importaÃ§Ã£o...');
                console.log('ðŸ“Š Total de leads finais:', leads.length);
                
                // Atualizar interface imediatamente
                console.log('ðŸ”„ Atualizando interface...');
                renderTable();
                
                // Salvar no JSONBin em background (nÃ£o bloquear a UI)
                setTimeout(async () => {
                    try {
                        console.log('ðŸ’¾ Salvando no JSONBin em background...');
                        await saveDataToBin(true, "Salvando leads importados...");
                        console.log('âœ… Salvamento no JSONBin concluÃ­do');
                    } catch (saveError) {
                        console.error('âŒ Erro ao salvar no JSONBin:', saveError);
                        showNotification("âš ï¸ Leads importados com sucesso, mas erro ao sincronizar online", "warning");
                    }
                }, 100);
                
                // Mostrar notificaÃ§Ã£o de sucesso
                const message = duplicateCount > 0 
                    ? `âœ… ${importedLeadsData.length} leads importados com sucesso! (${duplicateCount} duplicatas ignoradas)`
                    : `âœ… ${importedLeadsData.length} leads importados com sucesso!`;
                
                showNotification(message, "success");
                
                // Limpar dados de importaÃ§Ã£o
                closeImportPreview();
                
            } catch (error) {
                console.error('Erro ao importar leads:', error);
                showNotification("âŒ Erro ao importar leads. Tente novamente.", "error");
                hideLoader();
            }
        }
        
        // Verificar duplicatas
        function checkForDuplicates() {
            let duplicateCount = 0;
            const existingLeads = new Set(leads.map(lead => `${lead.empresa}|${lead.nome}|${lead.linkedin}`));
            
            importedLeadsData = importedLeadsData.filter(lead => {
                const key = `${lead.empresa}|${lead.nome}|${lead.linkedin}`;
                if (existingLeads.has(key)) {
                    duplicateCount++;
                    return false;
                }
                existingLeads.add(key);
                return true;
            });
            
            return duplicateCount;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromBin();
            initVersioning();
            initDarkMode();
            initExecutiveReport();
            initDragDrop();
            
            // CORREÃ‡ÃƒO AUTOMÃTICA DESABILITADA - sendo fiel Ã s datas reais das tasks
            console.log('ðŸ“… CorreÃ§Ã£o automÃ¡tica de datas DESABILITADA - respeitando datas originais dos leads');
            const toggleAllBtn = document.getElementById('toggle-all-btn');
            if (toggleAllBtn) {
                let expanded = false;
                toggleAllBtn.addEventListener('click', () => {
                    expanded = !expanded;
                    window.app.toggleAllCompanies(expanded);
                    toggleAllBtn.innerHTML = `
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        ${expanded ? 'Fechar tudo' : 'Abrir tudo'}
                    `;
                });
            }

            if (activityFilter) {
                activityFilter.addEventListener('change', () => {
                    renderTable();
                });
            }
            
            // Toggle do formulÃ¡rio de adicionar lead
            const toggleAddLeadBtn = document.getElementById('toggle-add-lead-btn');
            const addLeadFormContainer = document.getElementById('add-lead-form-container');
            const toggleArrow = document.getElementById('toggle-arrow');
            
            if (toggleAddLeadBtn && addLeadFormContainer && toggleArrow) {
                let isExpanded = false;
                
                toggleAddLeadBtn.addEventListener('click', () => {
                    isExpanded = !isExpanded;
                    
                    if (isExpanded) {
                        addLeadFormContainer.classList.remove('hidden');
                        toggleArrow.style.transform = 'rotate(180deg)';
                        // Focar no primeiro campo quando expandir
                        setTimeout(() => {
                            const empresaField = document.getElementById('empresa');
                            if (empresaField) empresaField.focus();
                        }, 100);
                    } else {
                        addLeadFormContainer.classList.add('hidden');
                        toggleArrow.style.transform = 'rotate(0deg)';
                    }
                });
            }
        });
    </script>

</body>
</html>
